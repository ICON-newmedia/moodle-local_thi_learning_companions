(function(c,F){"use strict";var I={exports:{}},R={};var H=c,B=Symbol.for("react.element"),W=Symbol.for("react.fragment"),J=Object.prototype.hasOwnProperty,K=H.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,V={key:!0,ref:!0,__self:!0,__source:!0};function O(e,n,d){var o,a={},m=null,u=null;d!==void 0&&(m=""+d),n.key!==void 0&&(m=""+n.key),n.ref!==void 0&&(u=n.ref);for(o in n)J.call(n,o)&&!V.hasOwnProperty(o)&&(a[o]=n[o]);if(e&&e.defaultProps)for(o in n=e.defaultProps,n)a[o]===void 0&&(a[o]=n[o]);return{$$typeof:B,type:e,key:m,ref:u,props:a,_owner:K.current}}R.Fragment=W,R.jsx=O,R.jsxs=O,function(e){e.exports=R}(I);const Y=I.exports.Fragment,t=I.exports.jsx,h=I.exports.jsxs;var G={},N=F;G.createRoot=N.createRoot,G.hydrateRoot=N.hydrateRoot;function D({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const d=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,n).format(d);return t("div",{className:"learningcompanions_chat_time",children:o})}function z({handleGroupSelect:e,group:n,activeGroupid:d}){const{name:o,id:a,description:m,chatid:u,shortdescription:v,imageurl:E,latestcomment:S,isPreview:g}=n,P=function(){e(a,u)};let s="d-flex learningcompanions_chat-group";return typeof d<"u"&&parseInt(d)===parseInt(a)&&(s+=" learningcompanions_currentgroup"),g&&(s+=" learningcompanions_previewgroup"),h("div",{onClick:P,id:"learningcompanions_chat-group-"+a,className:s,children:[t("img",{className:"learningcompanions_group_image_small",src:E}),h("div",{className:"learningcompanions_group_infos",children:[t("em",{children:o}),t("br",{}),t("span",{children:v})]}),t(D,{timestamp:S})]})}function A({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const p={on(e,n,d={}){return document.addEventListener(e,o=>n(o.detail),d),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}};function Q({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[d,o]=c.useState([]),[a,m]=c.useState(e),[u,v]=c.useState(0),[E,S]=c.useState(!0);function g(s,f){p.dispatch(p.events.GROUP_CHANGED,{groupid:s});const w=new URLSearchParams(window.location.search);w.set("groupid",s),w.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${w}`),m(s),document.querySelector('input[name="chatid"]').value=f,console.log(`setting active group id to: ${s} and chatid to: ${f}`)}function P(){const s=new AbortController,f=new URLSearchParams(window.location.search).get("previewGroup"),w=new URLSearchParams;return f&&w.set("previewGroup",f),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${w}`,{signal:s.signal}).then(_=>_.json()).then(({groups:_})=>{o(_),S(!1)}).catch(_=>{_.name!=="AbortError"&&console.log("Error: "+_.message)}),()=>s.abort()}return c.useEffect(P,[a,u]),c.useEffect(()=>{const s=window.setInterval(()=>{v(f=>f+1)},5e4);return()=>{window.clearInterval(s)}},[]),h("div",{id:"learningcompanions_chat-grouplist",children:[E&&t(A,{}),d.map(s=>t(z,{handleGroupSelect:g,group:s,activeGroupid:a},s.id))]})}function X({attachment:e}){const{url:n,filename:d}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:d})})}function Z({attachments:e=[]}){return e.map(n=>t(X,{attachment:n}))}function q({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function $({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function ee({highlighted:e,post:n,isPreview:d}){const{author:o,id:a,timecreated:m,comment:u,attachments:v,flagged:E,timedeleted:S}=n;let g=!1,P=!1,s;return typeof window.learningcompanions_chat_userid!==void 0&&+o.id==+window.learningcompanions_chat_userid?(g=!0,s="learningcompanions_chat-my-post"):(P=!0,s="learningcompanions_chat-other-post"),+E&&(s+=" learningcompanions_chat-reported-post"),h("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${s}`,children:[h("strong",{children:[o.firstname," ",o.lastname]}),t("br",{}),t("em",{children:t(D,{timestamp:m,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),t("br",{}),!+S&&t("div",{dangerouslySetInnerHTML:{__html:u}}),!!+S&&t("div",{children:t("i",{children:"Message Deleted"})}),!!v.length&&t(Z,{attachments:v}),h("div",{className:"action-button-wrapper",children:[!d&&g&&t(q,{id:a}),!d&&P&&!+E&&t($,{id:a})]}),h("span",{children:["ID: ",a]}),e&&h(Y,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function te({group:e}){return h("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function ne({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[d,o]=c.useState([]),[a,m]=c.useState({}),[u,v]=c.useState(e),[E,S]=c.useState(0),[g,P]=c.useState(!0),[s,f]=c.useState(null),[w,_]=c.useState(null),L=new URLSearchParams(window.location.search).get("postId"),C=n===a.id;let b=!1;const x=c.useCallback(r=>{v(r.groupid)},[]),j=c.useCallback(({postid:r})=>{o(i=>i.map(l=>(+l.id==+r&&(l.timedeleted=1),l)))},[]),T=c.useCallback(({postid:r})=>{o(i=>i.map(l=>(+l.id==+r&&(l.flagged=!0),l)))},[]);c.useEffect(()=>(p.on(p.events.GROUP_CHANGED,x),p.on(p.events.MESSAGE_DELETED,j),p.on(p.events.MESSAGE_REPORTED,T),()=>{p.off(p.events.GROUP_CHANGED,x),p.off(p.events.MESSAGE_DELETED,j),p.off(p.events.MESSAGE_REPORTED,T)}),[]),c.useEffect(()=>{if(!L)return;const r=document.querySelector(`#learningcompanions_chat-post-${L}`);console.log("Found element:",r),r&&r.scrollIntoView()},[g]);function se(){if(w===null||b)return;b=!0;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:u,firstPostId:w}),{signal:r.signal}).then(i=>i.json()).then(i=>{const l=i.posts;l.length&&(o(y=>[...y,...l]),_(l[l.length-1].id))}).catch(i=>{i.name!=="AbortError"&&console.log(i)}).finally(()=>{b=!1}),()=>r.abort()}function ie(){const r=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:u,includedPostId:L}),{signal:r.signal}).then(i=>i.json()).then(i=>{var y,U;const l=i.posts;o(l),m(i.group),P(!1),f(((y=l[0])==null?void 0:y.id)??0),_(((U=l[l.length-1])==null?void 0:U.id)??1/0)}).catch(i=>{i.name!=="AbortError"&&console.log(i)}),()=>r.abort()}function ae(){if(s===null)return;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${u}&lastPostId=${s}`,{signal:r.signal}).then(i=>i.json()).then(i=>{const l=i.posts;l.length&&(o(y=>[...l,...y]),f(l[0].id))}),()=>r.abort()}return c.useEffect(ie,[u]),c.useEffect(ae,[E]),c.useEffect(()=>{const r=window.setInterval(()=>{S(i=>i+1)},3e4);return()=>{window.clearInterval(r)}},[]),h("div",{id:"learningcompanions_chat-postlist",children:[g&&t(A,{}),t(te,{group:a}),C&&t("span",{children:"Is Preview"}),t("div",{className:"post-wrapper",onScroll:r=>{-r.target.scrollTop+r.target.clientHeight>=r.target.scrollHeight&&se()},children:d.map(r=>t(ee,{post:r,isPreview:C,highlighted:r.id===L},r.id))})]})}const oe=G.createRoot(document.getElementById("learningcompanions_groups-content")),re=G.createRoot(document.getElementById("learningcompanions_chat-content")),k=new URLSearchParams(window.location.search).get("previewGroup");oe.render(t(React.StrictMode,{children:t(Q,{previewGroup:k,activeGroupid:window.learningcompanions_groupid})})),re.render(t(React.StrictMode,{children:t(ne,{previewGroup:k,activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
