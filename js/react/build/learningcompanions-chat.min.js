(function(c,K){"use strict";var P={exports:{}},y={};var Y=c,z=Symbol.for("react.element"),Q=Symbol.for("react.fragment"),X=Object.prototype.hasOwnProperty,Z=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,q={key:!0,ref:!0,__self:!0,__source:!0};function L(e,t,s){var o,r={},f=null,h=null;s!==void 0&&(f=""+s),t.key!==void 0&&(f=""+t.key),t.ref!==void 0&&(h=t.ref);for(o in t)X.call(t,o)&&!q.hasOwnProperty(o)&&(r[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps,t)r[o]===void 0&&(r[o]=t[o]);return{$$typeof:z,type:e,key:f,ref:h,props:r,_owner:Z.current}}y.Fragment=Q,y.jsx=L,y.jsxs=L,function(e){e.exports=y}(P);const $=P.exports.Fragment,n=P.exports.jsx,w=P.exports.jsxs;var I={},O=K;I.createRoot=O.createRoot,I.hydrateRoot=O.hydrateRoot;function A({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"No Time!"});const s=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,t).format(s);return n("div",{className:"learningcompanions_chat_time",children:o})}function ee({handleGroupSelect:e,group:t,activeGroupid:s}){const{name:o,id:r,description:f,chatid:h,shortdescription:_,imageurl:v,latestcomment:g,isPreview:a}=t,m=function(){e(r,h)};let d="d-flex learningcompanions_chat-group";return typeof s<"u"&&parseInt(s)===parseInt(r)&&(d+=" learningcompanions_currentgroup"),a&&(d+=" learningcompanions_previewgroup"),w("div",{onClick:m,id:"learningcompanions_chat-group-"+r,className:d,children:[n("img",{className:"learningcompanions_group_image_small",src:v}),w("div",{className:"learningcompanions_group_infos",children:[n("em",{children:o}),n("br",{}),n("span",{children:_})]}),n(A,{timestamp:g})]})}function N(){return n("div",{className:"learningcompanions_loading"})}const p={on(e,t,s={}){return document.addEventListener(e,o=>t(o.detail),s),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",GROUPS_UPDATED:"learningcompanions_groups_updated"}};function b(e,t="local_learningcompanions",s=[]){var h;const o=((h=window.M.str[t])==null?void 0:h[e])??`[[${e}_not_found]]`;if(!s.length)return o;const r=/{\$a->(\w*)}/gm,f=/{\$a}/gm;return typeof s=="object"?o.replace(r,(_,v)=>s[v]??_):o.replace(f,s)}const k=".js-chat-preview",C="#fitem_id_message",x="#fitem_id_attachments",U=".fdescription.required";function te(e,t){var o,r;let s=t;e?(console.log("I make the input invisible"),s="",(o=document.querySelector(k))==null||o.classList.replace("d-none","d-flex"),document.querySelectorAll(`${C}, ${x}, ${U}`).forEach(f=>f.classList.add("d-none"))):(console.log("I make the input Visible"),(r=document.querySelector(k))==null||r.classList.replace("d-flex","d-none"),document.querySelectorAll(`${C}, ${x}, ${U}`).forEach(f=>f.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=s}const j=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function ne({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,s]=c.useState([]),[o,r]=c.useState(e),[f,h]=c.useState(!1),[_,v]=c.useState(!0);c.useEffect(()=>{const a=t.find(G=>+G.id==+o),m=a==null?void 0:a.chatid,d=(a==null?void 0:a.isPreviewGroup)??!1;te(d,m),console.log(`setting active group id to: ${o} and chatid to: ${m}`)},[o,t]);function g(a){p.dispatch(p.events.GROUP_CHANGED,{groupid:a});const m=new URLSearchParams(window.location.search);m.set("groupid",a),m.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${m}`),r(a)}return c.useEffect(()=>{const a=new URLSearchParams,m=new AbortController;j&&a.set("shouldIncludeId",j),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${a}`,{signal:m.signal}).then(d=>d.json()).then(({groups:d})=>{console.log("Groups",d),s(d),v(!1),p.dispatch(p.events.GROUPS_UPDATED,{groups:d})}).catch(d=>{d.name!=="AbortError"&&console.log("Error: "+d.message)})},[f]),c.useEffect(()=>{const a=window.setInterval(()=>{h(m=>!m)},5e4);return()=>{window.clearInterval(a)}},[]),w("div",{id:"learningcompanions_chat-grouplist",children:[_&&n(N,{}),t.map(a=>n(ee,{handleGroupSelect:g,group:a,activeGroupid:o},a.id))]})}function oe({attachment:e}){const{url:t,filename:s}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:s})})}function se({attachments:e=[]}){return e.map(t=>n(oe,{attachment:t}))}function re({id:e}){const t=b("delete_post");return console.log("Delete Button:",t),n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ie({id:e}){const t=b("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ae({highlighted:e,post:t,isPreview:s}){const{author:o,id:r,timecreated:f,comment:h,attachments:_,flagged:v,timedeleted:g}=t;let a=!1,m=!1,d;return typeof window.learningcompanions_chat_userid!==void 0&&+o.id==+window.learningcompanions_chat_userid?(a=!0,d="learningcompanions_chat-my-post"):(m=!0,d="learningcompanions_chat-other-post"),+v&&(d+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${r}`,className:`learningcompanions_chat-post ${d}`,children:[w("strong",{children:[o.firstname," ",o.lastname]}),n("br",{}),n("em",{children:n(A,{timestamp:f,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+g&&n("div",{dangerouslySetInnerHTML:{__html:h}}),!!+g&&n("div",{children:n("i",{children:"Message Deleted"})}),!+g&&!!_.length&&n(se,{attachments:_}),w("div",{className:"action-button-wrapper",children:[!s&&a&&n(re,{id:r}),!s&&m&&!+v&&n(ie,{id:r})]}),w("span",{children:["ID: ",r]}),e&&w($,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ce({posts:e,highlightedPostId:t,isInPreviewMode:s,handleWrapperScroll:o}){if(!e.length){const r=b("no_posts_available");return n("div",{className:"post-wrapper p-3",children:r})}return n("div",{className:"post-wrapper",onScroll:o,children:e.map(r=>n(ae,{post:r,isPreview:s,highlighted:r.id===t},r.id))})}function le({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function de({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,s]=c.useState([]),[o,r]=c.useState(e),[f,h]=c.useState([]),[_,v]=c.useState(0),[g,a]=c.useState(!0),[m,d]=c.useState(null),[G,T]=c.useState(null),S=new URLSearchParams(window.location.search).get("postId"),R=f.find(i=>+i.id==+o),H=(R==null?void 0:R.isPreviewGroup)??!1;let D=!1;const B=c.useCallback(i=>{r(i.groupid),a(!0)},[]),F=c.useCallback(i=>{h(i.groups)},[]),W=c.useCallback(({postid:i})=>{s(l=>l.map(u=>(+u.id==+i&&(u.timedeleted=1),u)))},[]),V=c.useCallback(({postid:i})=>{s(l=>l.map(u=>(+u.id==+i&&(u.flagged=!0),u)))},[]),fe=c.useCallback(()=>{const i=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:o,includedPostId:S}),{signal:i.signal}).then(l=>l.json()).then(l=>{var E,J;const u=l.posts;s(u),a(!1),d(((E=u[0])==null?void 0:E.id)??0),T(((J=u[u.length-1])==null?void 0:J.id)??1/0)}).catch(l=>{l.name!=="AbortError"&&console.log(l)}),()=>i.abort()},[o,S]);c.useEffect(()=>(p.on(p.events.GROUP_CHANGED,B),p.on(p.events.MESSAGE_DELETED,W),p.on(p.events.MESSAGE_REPORTED,V),p.on(p.events.GROUPS_UPDATED,F),()=>{p.off(p.events.GROUP_CHANGED,B),p.off(p.events.MESSAGE_DELETED,W),p.off(p.events.MESSAGE_REPORTED,V),p.off(p.events.GROUPS_UPDATED,F)}),[]),c.useEffect(()=>{if(!S)return;const i=document.querySelector(`#learningcompanions_chat-post-${S}`);i&&i.scrollIntoView()},[g]);function me(){if(G===null||D)return;D=!0;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:o,firstPostId:G}),{signal:i.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(s(E=>[...E,...u]),T(u[u.length-1].id))}).catch(l=>{l.name!=="AbortError"&&console.log(l)}).finally(()=>{D=!1}),()=>i.abort()}function he(){if(m===null)return;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${o}&lastPostId=${m}`,{signal:i.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(s(E=>[...u,...E]),d(u[0].id))}),()=>i.abort()}return c.useEffect(fe,[o]),c.useEffect(he,[_]),c.useEffect(()=>{const i=window.setInterval(()=>{v(l=>l+1)},3e4);return()=>{window.clearInterval(i)}},[]),w("div",{id:"learningcompanions_chat-postlist",children:[n(le,{group:R}),H&&n("span",{children:"Is Preview"}),g&&n(N,{}),!g&&n(ce,{posts:t,handleWrapperScroll:i=>{-i.target.scrollTop+i.target.clientHeight>=i.target.scrollHeight&&me()},isInPreviewMode:H,highlightedPostId:S})]})}const ue=I.createRoot(document.getElementById("learningcompanions_groups-content")),pe=I.createRoot(document.getElementById("learningcompanions_chat-content"));ue.render(n(React.StrictMode,{children:n(ne,{activeGroupid:window.learningcompanions_groupid})})),pe.render(n(React.StrictMode,{children:n(de,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
