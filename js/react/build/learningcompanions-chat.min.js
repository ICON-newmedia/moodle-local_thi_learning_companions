(function(s,k){"use strict";var O={exports:{}},E={};var x=s,D=Symbol.for("react.element"),C=Symbol.for("react.fragment"),$=Object.prototype.hasOwnProperty,B=x.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,F={key:!0,ref:!0,__self:!0,__source:!0};function G(e,n,d){var i,a={},c=null,u=null;d!==void 0&&(c=""+d),n.key!==void 0&&(c=""+n.key),n.ref!==void 0&&(u=n.ref);for(i in n)$.call(n,i)&&!F.hasOwnProperty(i)&&(a[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps,n)a[i]===void 0&&(a[i]=n[i]);return{$$typeof:D,type:e,key:c,ref:u,props:a,_owner:B.current}}E.Fragment=C,E.jsx=G,E.jsxs=G,function(e){e.exports=E}(O);const t=O.exports.jsx,m=O.exports.jsxs;var S={},I=k;S.createRoot=I.createRoot,S.hydrateRoot=I.hydrateRoot;function T({timestamp:e}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time"});const n=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(date);return console.log("lastActive: ",n),t("div",{className:"learningcompanions_chat_time",children:n})}function H({handleGroupSelect:e,name:n,id:d,description:i,chatid:a,shortdescription:c,imageurl:u,latestcomment:g,activeGroupid:f}){const p=function(){e(d,a)};let y="learningcompanions_chat-group";return typeof f<"u"&&parseInt(f)===parseInt(d)&&(y+=" learningcompanions_currentgroup"),m("div",{onClick:p,id:"learningcompanions_chat-group-"+d,className:y,children:[t(T,{timestamp:g}),t("img",{className:"learningcompanions_group_image_small",src:u,alt:`Group picture for group ${n}`}),t("em",{children:n}),t("br",{}),t("span",{children:c}),t("br",{})]})}function N({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const v={on(e,n){document.addEventListener(e,d=>n(d.detail))},dispatch(e,n){document.dispatchEvent(new CustomEvent(e,{detail:n}))},remove(e,n){document.removeEventListener(e,n)},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted"}};function U(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,d]=s.useState([]),[i,a]=s.useState(e.activeGroupid),[c,u]=s.useState(0),[g,f]=s.useState(!0);function p(l,w){v.dispatch(v.events.GROUP_CHANGED,{groupid:l}),a(l),document.querySelector('input[name="chatid"]').value=w,console.log(`setting active group id to: ${l} and chatid to: ${w}`)}function y(){const l=new AbortController;async function w(){const P=await(await fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php")).json();d(P.groups),f(!1)}return w(),()=>l.abort()}return s.useEffect(y,[i,c]),s.useEffect(()=>{const l=window.setInterval(()=>{u(w=>w+1)},5e4);return()=>{window.clearInterval(l)}},[]),m("div",{id:"learningcompanions_chat-grouplist",children:[g&&t(N,{}),n.map(l=>t(H,{handleGroupSelect:p,name:l.name,chatid:l.chatid,id:l.id,shortdescription:l.shortdescription,description:l.description,imageurl:l.imageurl,latestcomment:l.latestcomment,activeGroupid:i},l.id))]})}function q(e){return t("div",{children:t("a",{target:"_blank",href:e.attachment.url,children:e.attachment.filename})})}function W({attachments:e}){if(!(!e||e.length===0))return e.map(n=>t(q,{attachment:n}))}function R({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function J({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function K({author:e,id:n,datetime:d,comment:i,attachments:a,reported:c}){let u;a&&a.length?u=t(W,{attachments:a}):u="";let g=!1,f=!1,p;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(g=!0,p="learningcompanions_chat-my-post"):(f=!0,p="learningcompanions_chat-other-post"),m("div",{id:"learningcompanions_chat-post-"+n,className:"learningcompanions_chat-post "+p,children:[m("strong",{children:[e.firstname," ",e.lastname]}),t("br",{}),t("em",{children:d}),t("br",{}),t("div",{dangerouslySetInnerHTML:{__html:i}}),m("span",{children:["ID: ",n]}),m("span",{children:["Flagged: ",c]}),u,m("div",{className:"action-button-wrapper",children:[g&&t(R,{id:n}),f&&!c&&t(J,{id:n})]})]})}function Y({group:e}){return m("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function z(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,d]=s.useState([]),[i,a]=s.useState({}),[c,u]=s.useState(1),[g,f]=s.useState(0),[p,y]=s.useState(e.activeGroupid),[l,w]=s.useState(0),[L,P]=s.useState(!0),[j,X]=s.useState(0),[b,A]=s.useState(null);v.on(v.events.GROUP_CHANGED,o=>{y(o.groupid),u(1),f(0)}),v.on(v.events.MESSAGE_DELETED,()=>{X(j+1)});function Z(){if(c===1)return;const o=new AbortController;return console.log({page:c,postsOffset:g}),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:p,page:c,offset:g}),{signal:o.signal}).then(r=>r.json()).then(r=>{const h=Object.values(r.posts);console.log(r),d(_=>[..._,...h])}).catch(r=>{r.name==="AbortError"?console.log("Fetch aborted"):console.log(r)}),()=>o.abort()}const ee=()=>{const o=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?groupid="+p,{signal:o.signal}).then(r=>r.json()).then(r=>{var _;const h=Object.values(r.posts).reverse();d(h),a(r.group),P(!1),A(((_=h[0])==null?void 0:_.id)??0),console.log("Last post id: "+b)}).catch(r=>{r.name==="AbortError"?console.log("Fetch aborted"):console.log(r)}),()=>o.abort()},te=()=>{if(b===null)return;console.log("Getting new posts with lastPostId: "+b);const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${p}&lastPostId=${b}`,{signal:o.signal}).then(r=>r.json()).then(r=>{console.log("New Posts:",r);const h=Object.values(r.posts).reverse();h.length&&(f(_=>_+h.length),d(_=>[...h,..._]),A(h[0].id))}),()=>o.abort()};return s.useEffect(Z,[c]),s.useEffect(ee,[p,j]),s.useEffect(te,[l]),s.useEffect(()=>{const o=window.setInterval(()=>{w(r=>r+1)},3e4);return()=>{window.clearInterval(o)}},[]),m("div",{id:"learningcompanions_chat-postlist",children:[L&&t(N,{}),t(Y,{group:i}),t("div",{className:"post-wrapper",onScroll:o=>{-o.target.scrollTop+o.target.clientHeight>=o.target.scrollHeight&&u(r=>r+1)},children:n.map(o=>t(K,{author:o.author,id:o.id,datetime:o.datetime,comment:o.comment,attachments:o.attachments,reported:+o.flagged},o.id))})]})}const Q=S.createRoot(document.getElementById("learningcompanions_groups-content")),V=S.createRoot(document.getElementById("learningcompanions_chat-content"));Q.render(t(s.StrictMode,{children:t(U,{activeGroupid:window.learningcompanions_groupid})})),V.render(t(s.StrictMode,{children:t(z,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
