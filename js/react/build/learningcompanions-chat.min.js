(function(s,A){"use strict";var S={exports:{}},v={};var k=s,x=Symbol.for("react.element"),D=Symbol.for("react.fragment"),C=Object.prototype.hasOwnProperty,B=k.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,T={key:!0,ref:!0,__self:!0,__source:!0};function P(e,n,d){var i,a={},c=null,u=null;d!==void 0&&(c=""+d),n.key!==void 0&&(c=""+n.key),n.ref!==void 0&&(u=n.ref);for(i in n)C.call(n,i)&&!T.hasOwnProperty(i)&&(a[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps,n)a[i]===void 0&&(a[i]=n[i]);return{$$typeof:x,type:e,key:c,ref:u,props:a,_owner:B.current}}v.Fragment=D,v.jsx=P,v.jsxs=P,function(e){e.exports=v}(S);const t=S.exports.jsx,f=S.exports.jsxs;var E={},N=A;E.createRoot=N.createRoot,E.hydrateRoot=N.hydrateRoot;function F({timestamp:e}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time"});const n=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(date);return console.log("lastActive: ",n),t("div",{className:"learningcompanions_chat_time",children:n})}function H({handleGroupSelect:e,name:n,id:d,description:i,shortdescription:a,imageurl:c,latestcomment:u,activeGroupid:p}){const g=function(){e(d)};let m="learningcompanions_chat-group";return typeof p<"u"&&parseInt(p)===parseInt(d)&&(m+=" learningcompanions_currentgroup"),f("div",{onClick:g,id:"learningcompanions_chat-group-"+d,className:m,children:[t(F,{timestamp:u}),t("img",{className:"learningcompanions_group_image_small",src:c}),t("em",{children:n}),t("br",{}),t("span",{children:a}),t("br",{})]})}function L({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const w={on(e,n){document.addEventListener(e,d=>n(d.detail))},dispatch(e,n){document.dispatchEvent(new CustomEvent(e,{detail:n}))},remove(e,n){document.removeEventListener(e,n)},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted"}};function $(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,d]=s.useState([]),[i,a]=s.useState(e.activeGroupid),[c,u]=s.useState(0),[p,g]=s.useState(!0);function m(l){w.dispatch(w.events.GROUP_CHANGED,{groupid:l}),a(l),document.querySelector('input[name="chatid"]').value=l,console.log("setting active group id to: ",l)}function b(){const l=new AbortController;async function O(){const I=await(await fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php")).json();d(I.groups),g(!1)}return O(),()=>l.abort()}return s.useEffect(b,[i,c]),s.useEffect(()=>{const l=window.setInterval(()=>{u(c+1)},5e4);return()=>{window.clearInterval(l)}},[]),f("div",{id:"learningcompanions_chat-grouplist s",children:[t(L,{loading:p}),n.map(l=>t(H,{handleGroupSelect:m,name:l.name,id:l.id,shortdescription:l.shortdescription,description:l.description,imageurl:l.imageurl,latestcomment:l.latestcomment,activeGroupid:i},l.id))]})}function U(e){return t("div",{children:t("a",{target:"_blank",href:e.attachment.url,children:e.attachment.filename})})}function q({attachments:e}){if(!(!e||e.length===0))return e.map(n=>t(U,{attachment:n}))}function W({id:e}){return t("a",{href:"#","data-id":e,title:"Edit",className:"learningcompanions_edit_comment"})}function R({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function J({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function K({author:e,id:n,datetime:d,comment:i,attachments:a}){let c;a&&a.length?c=t(q,{attachments:a}):c="";let u=!1,p=!1,g=!1,m;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(u=!0,p=!0,m="learningcompanions_chat-my-post"):(g=!0,m="learningcompanions_chat-other-post"),f("div",{id:"learningcompanions_chat-post-"+n,className:"learningcompanions_chat-post "+m,children:[f("strong",{children:[e.firstname," ",e.lastname]}),t("br",{}),t("em",{children:d}),t("br",{}),t("div",{dangerouslySetInnerHTML:{__html:i}}),f("span",{children:["ID: ",n]}),c,f("div",{className:"action-button-wrapper",children:[u&&t(W,{id:n}),p&&t(R,{id:n}),g&&t(J,{id:n})]})]})}function Y({group:e}){return f("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function z(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,d]=s.useState([]),[i,a]=s.useState({}),[c,u]=s.useState(1),[p,g]=s.useState(e.activeGroupid),[m,b]=s.useState(0),[l,O]=s.useState(!0),[G,I]=s.useState(0),[y,j]=s.useState(null);w.on(w.events.GROUP_CHANGED,r=>{g(r.groupid),u(1)}),w.on(w.events.MESSAGE_DELETED,()=>{I(G+1)});function X(){const r=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?groupid="+p+"&page="+c,{signal:r.signal}).then(o=>o.json()).then(o=>{const h=Object.values(o.posts);console.log(o),d(_=>[..._,...h])}).catch(o=>{o.name==="AbortError"?console.log("Fetch aborted"):console.log(o)}),()=>r.abort()}const Z=()=>{const r=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?groupid="+p,{signal:r.signal}).then(o=>o.json()).then(o=>{var _;const h=Object.values(o.posts).reverse();d(h),a(o.group),O(!1),j(((_=h[0])==null?void 0:_.id)??0),console.log("Last post id: "+y)}).catch(o=>{o.name==="AbortError"?console.log("Fetch aborted"):console.log(o)}),()=>r.abort()},ee=()=>{if(y===null)return;console.log("Getting new posts with lastPostId: "+y);const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${p}&lastPostId=${y}`,{signal:r.signal}).then(o=>o.json()).then(o=>{console.log("New Posts:",o);const h=Object.values(o.posts).reverse();h.length&&(d(_=>[...h,..._]),j(h[0].id))}),()=>r.abort()};return s.useEffect(X,[c]),s.useEffect(Z,[p,G]),s.useEffect(ee,[m]),s.useEffect(()=>{const r=window.setInterval(()=>{b(o=>o+1)},3e4);return()=>{window.clearInterval(r)}},[]),f("div",{id:"learningcompanions_chat-postlist",children:[t(L,{loading:l}),t(Y,{group:i}),t("div",{className:"post-wrapper",onScroll:r=>{-r.target.scrollTop+r.target.clientHeight>=r.target.scrollHeight&&u(o=>o+1)},children:n.map(r=>t(K,{author:r.author,id:r.id,datetime:r.datetime,comment:r.comment,attachments:r.attachments},r.id))})]})}const Q=E.createRoot(document.getElementById("learningcompanions_groups-content")),V=E.createRoot(document.getElementById("learningcompanions_chat-content"));Q.render(t(s.StrictMode,{children:t($,{activeGroupid:window.learningcompanions_groupid})})),V.render(t(s.StrictMode,{children:t(z,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
