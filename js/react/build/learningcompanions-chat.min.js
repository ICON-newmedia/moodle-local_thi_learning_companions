(function(l,N){"use strict";var P={exports:{}},y={};var J=l,K=Symbol.for("react.element"),Q=Symbol.for("react.fragment"),Y=Object.prototype.hasOwnProperty,z=J.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,X={key:!0,ref:!0,__self:!0,__source:!0};function x(e,t,r){var o,s={},p=null,m=null;r!==void 0&&(p=""+r),t.key!==void 0&&(p=""+t.key),t.ref!==void 0&&(m=t.ref);for(o in t)Y.call(t,o)&&!X.hasOwnProperty(o)&&(s[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps,t)s[o]===void 0&&(s[o]=t[o]);return{$$typeof:K,type:e,key:p,ref:m,props:s,_owner:z.current}}y.Fragment=Q,y.jsx=x,y.jsxs=x,function(e){e.exports=y}(P);const A=P.exports.Fragment,n=P.exports.jsx,_=P.exports.jsxs;var I={},G=N;I.createRoot=G.createRoot,I.hydrateRoot=G.hydrateRoot;function O({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"No Time!"});const r=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,t).format(r);return n("div",{className:"learningcompanions_chat_time",children:o})}function Z({handleGroupSelect:e,group:t,activeGroupid:r}){const{name:o,id:s,description:p,chatid:m,shortdescription:g,imageurl:w,latestcomment:v,isPreview:E}=t,a=function(){e(s,m)};let i="d-flex learningcompanions_chat-group";return typeof r<"u"&&parseInt(r)===parseInt(s)&&(i+=" learningcompanions_currentgroup"),E&&(i+=" learningcompanions_previewgroup"),_("div",{onClick:a,id:"learningcompanions_chat-group-"+s,className:i,children:[n("img",{className:"learningcompanions_group_image_small",src:w}),_("div",{className:"learningcompanions_group_infos",children:[n("em",{children:o}),n("br",{}),n("span",{children:g})]}),n(O,{timestamp:v})]})}function j(){return n("div",{className:"learningcompanions_loading"})}function R(e,t="local_learningcompanions",r=[]){var m;const o=((m=window.M.str[t])==null?void 0:m[e])??`[[${e}_not_found]]`;if(!r.length)return o;const s=/{\$a->(\w*)}/gm,p=/{\$a}/gm;return typeof r=="object"?o.replace(s,(g,w)=>r[w]??g):o.replace(p,r)}const D=".js-chat-preview",k="#fitem_id_message",C="#fitem_id_attachments",T=".fdescription.required";function q(e,t){var o,s;let r=t;e?(r="",(o=document.querySelector(D))==null||o.classList.replace("d-none","d-flex"),document.querySelectorAll(`${k}, ${C}, ${T}`).forEach(p=>p.classList.add("d-none"))):((s=document.querySelector(D))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${k}, ${C}, ${T}`).forEach(p=>p.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=r}function $(){document.querySelector(".chat-post-form").classList.add("d-none")}function ee({attachment:e}){const{url:t,filename:r}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:r})})}function te({attachments:e=[]}){return e.map(t=>n(ee,{attachment:t}))}function ne({id:e}){const t=R("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function oe({id:e}){const t=R("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function se({highlighted:e,post:t,isPreview:r}){const{author:o,id:s,timecreated:p,comment:m,attachments:g,flagged:w,timedeleted:v}=t;let E=!1,a=!1,i;return typeof window.learningcompanions_chat_userid!==void 0&&+o.id==+window.learningcompanions_chat_userid?(E=!0,i="learningcompanions_chat-my-post"):(a=!0,i="learningcompanions_chat-other-post"),+w&&(i+=" learningcompanions_chat-reported-post"),_("div",{id:`learningcompanions_chat-post-${s}`,className:`learningcompanions_chat-post ${i}`,children:[_("strong",{children:[o.firstname," ",o.lastname]}),n("br",{}),n("em",{children:n(O,{timestamp:p,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+v&&n("div",{dangerouslySetInnerHTML:{__html:m}}),!!+v&&n("div",{children:n("i",{children:"Message Deleted"})}),!+v&&!!g.length&&n(te,{attachments:g}),_("div",{className:"action-button-wrapper",children:[!r&&E&&n(ne,{id:s}),!r&&a&&!+w&&n(oe,{id:s})]}),e&&_(A,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function re({posts:e,highlightedPostId:t,isInPreviewMode:r,handleWrapperScroll:o}){if(!e.length){const s=R("no_posts_available");return n("div",{className:"post-wrapper p-3",children:s})}return n("div",{className:"post-wrapper",onScroll:o,children:e.map(s=>n(se,{post:s,isPreview:r,highlighted:s.id===t},s.id))})}function ae({group:e}){if(e!==void 0)return _("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}const h={on(e,t,r={}){return document.addEventListener(e,o=>t(o.detail),r),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send"}};function B({activeGroupid:e,groups:t}){const[r,o]=l.useState([]),[s,p]=l.useState(0),[m,g]=l.useState(!0),[w,v]=l.useState(null),[E,a]=l.useState(null),i=new URLSearchParams(window.location.search).get("postId"),f=t.find(c=>+c.id==+e),L=(f==null?void 0:f.isPreviewGroup)??!1;let b=!1;l.useEffect(()=>{g(!0)},[e]);const U=l.useCallback(({postid:c})=>{o(d=>d.map(u=>(+u.id==+c&&(u.timedeleted=1),u)))},[]),H=l.useCallback(({postid:c})=>{o(d=>d.map(u=>(+u.id==+c&&(u.flagged=!0),u)))},[]),W=l.useCallback(()=>{p(c=>c+1)},[]),ue=l.useCallback(()=>{const c=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:i}),{signal:c.signal}).then(d=>d.json()).then(d=>{var S,V;const u=d.posts;o(u),g(!1),v(((S=u[0])==null?void 0:S.id)??0),a(((V=u[u.length-1])==null?void 0:V.id)??1/0)}).catch(d=>{d.name!=="AbortError"&&console.log(d)}),()=>c.abort()},[e,i]);l.useEffect(()=>(h.on(h.events.MESSAGE_DELETED,U),h.on(h.events.MESSAGE_REPORTED,H),h.on(h.events.MESSAGE_SEND,W),()=>{h.off(h.events.MESSAGE_DELETED,U),h.off(h.events.MESSAGE_REPORTED,H),h.off(h.events.MESSAGE_SEND,W)}),[]),l.useEffect(()=>{if(!i)return;const c=document.querySelector(`#learningcompanions_chat-post-${i}`);c&&c.scrollIntoView()},[m]);function pe(){if(E===null||b)return;b=!0;const c=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:E}),{signal:c.signal}).then(d=>d.json()).then(d=>{const u=d.posts;u.length&&(o(S=>[...S,...u]),a(u[u.length-1].id))}).catch(d=>{d.name!=="AbortError"&&console.log(d)}).finally(()=>{b=!1}),()=>c.abort()}function me(){if(w===null)return;const c=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${w}`,{signal:c.signal}).then(d=>d.json()).then(d=>{const u=d.posts;u.length&&(o(S=>[...u,...S]),v(u[0].id))}),()=>c.abort()}l.useEffect(ue,[e]),l.useEffect(me,[s]),l.useEffect(()=>{const c=window.setInterval(()=>{p(d=>d+1)},1e4);return()=>{window.clearInterval(c)}},[]);const fe=c=>{-c.target.scrollTop+c.target.clientHeight>=c.target.scrollHeight&&pe()};return _("div",{id:"learningcompanions_chat-postlist",children:[n(ae,{group:f}),L&&n("span",{children:"Is Preview"}),m&&n(j,{}),!m&&t.length>0&&n(re,{posts:r,handleWrapperScroll:fe,isInPreviewMode:L,highlightedPostId:i})]})}const F=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function ie({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,r]=l.useState([]),[o,s]=l.useState(e),[p,m]=l.useState(!1),[g,w]=l.useState(!0);o===void 0&&t.length&&s(t[0].id),l.useEffect(()=>{const a=t.find(L=>+L.id==+o),i=a==null?void 0:a.chatid,f=(a==null?void 0:a.isPreviewGroup)??!1;q(f,i),console.log(`setting active group id to: ${o} and chatid to: ${i}`)},[o,t]);function v(a){const i=new URLSearchParams(window.location.search);i.set("groupid",a),i.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${i}`),s(a)}l.useEffect(()=>{const a=new URLSearchParams,i=new AbortController;F&&a.set("shouldIncludeId",F),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${a}`,{signal:i.signal}).then(f=>f.json()).then(({groups:f})=>{console.log("Groups",f),r(f),w(!1),f.length===0&&$()}).catch(f=>{f.name!=="AbortError"&&console.log("Error: "+f.message)})},[p]),l.useEffect(()=>{const a=window.setInterval(()=>{m(i=>!i)},5e4);return()=>{window.clearInterval(a)}},[]);const E=document.getElementById("learningcompanions_chat-content");return _(A,{children:[_("div",{id:"learningcompanions_chat-grouplist",children:[g&&n(j,{}),t.map(a=>n(Z,{handleGroupSelect:v,group:a,activeGroupid:o},a.id)),t.length===0&&!g&&n("p",{children:"No groups found"})]}),N.createPortal(n(B,{activeGroupid:o,groups:t}),E)]})}function ce(){I.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(ie,{activeGroupid:window.learningcompanions_groupid})}))}function le(){const e=I.createRoot(document.getElementById("learningcompanions_groups-content")),t=window.learningcompanions_groupid,r=[window.learningcompanions_questionGroup];e.render(n(React.StrictMode,{children:n(B,{activeGroupid:t,groups:r})}))}const de={startChat:ce,startQuestionChat:le};window.Chat=de})(React,ReactDOM);
