(function(i,N){"use strict";var P={},K={get exports(){return P},set exports(e){P=e}},y={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y=i,z=Symbol.for("react.element"),X=Symbol.for("react.fragment"),Z=Object.prototype.hasOwnProperty,q=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$={key:!0,ref:!0,__self:!0,__source:!0};function x(e,t,o){var s,r={},c=null,h=null;o!==void 0&&(c=""+o),t.key!==void 0&&(c=""+t.key),t.ref!==void 0&&(h=t.ref);for(s in t)Z.call(t,s)&&!$.hasOwnProperty(s)&&(r[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps,t)r[s]===void 0&&(r[s]=t[s]);return{$$typeof:z,type:e,key:c,ref:h,props:r,_owner:q.current}}y.Fragment=X,y.jsx=x,y.jsxs=x,function(e){e.exports=y}(K);const j=P.Fragment,n=P.jsx,w=P.jsxs;var I={},O=N;I.createRoot=O.createRoot,I.hydrateRoot=O.hydrateRoot;function A({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"No Time!"});const o=new Date(e*1e3),s=new Intl.DateTimeFormat(void 0,t).format(o);return n("div",{className:"learningcompanions_chat_time",children:s})}function ee({handleGroupSelect:e,group:t,activeGroupid:o}){const{name:s,id:r,description:c,chatid:h,shortdescription:p,imageurl:_,latestcomment:v,isPreview:E}=t,a=function(){e(r,h)};let f="d-flex learningcompanions_chat-group";return typeof o<"u"&&parseInt(o)===parseInt(r)&&(f+=" learningcompanions_currentgroup"),E&&(f+=" learningcompanions_previewgroup"),w("div",{onClick:a,id:"learningcompanions_chat-group-"+r,className:f,children:[n("img",{className:"learningcompanions_group_image_small",src:_}),w("div",{className:"learningcompanions_group_infos",children:[n("em",{children:s}),n("br",{}),n("span",{children:p})]}),n(A,{timestamp:v})]})}function D(){return n("div",{className:"learningcompanions_loading"})}function R(e,t="local_learningcompanions",o=[]){var h;const s=((h=window.M.str[t])==null?void 0:h[e])??`[[${e}_not_found]]`;if(!o.length)return s;const r=/{\$a->(\w*)}/gm,c=/{\$a}/gm;return typeof o=="object"?s.replace(r,(p,_)=>o[_]??p):s.replace(c,o)}const C=".js-chat-preview",G="#fitem_id_message",T="#fitem_id_attachments",B=".fdescription.required";function te(e,t){var s,r;let o=t;e?(o="",(s=document.querySelector(C))==null||s.classList.replace("d-none","d-flex"),document.querySelectorAll(`${G}, ${T}, ${B}`).forEach(c=>c.classList.add("d-none"))):((r=document.querySelector(C))==null||r.classList.replace("d-flex","d-none"),document.querySelectorAll(`${G}, ${T}, ${B}`).forEach(c=>c.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=o}function ne(){document.querySelector(".chat-post-form").classList.add("d-none")}function oe({attachment:e}){const{url:t,filename:o}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:o})})}function se({attachments:e=[]}){return e.map(t=>n(oe,{attachment:t}))}function re({id:e}){const t=R("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ae({id:e}){const t=R("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ie({highlighted:e,post:t,isPreview:o}){const{author:s,id:r,timecreated:c,comment:h,attachments:p,flagged:_,timedeleted:v}=t;let E=!1,a=!1,f;return typeof window.learningcompanions_chat_userid!==void 0&&+s.id==+window.learningcompanions_chat_userid?(E=!0,f="learningcompanions_chat-my-post"):(a=!0,f="learningcompanions_chat-other-post"),+_&&(f+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${r}`,className:`learningcompanions_chat-post ${f}`,children:[w("strong",{children:[s.firstname," ",s.lastname]}),n("br",{}),n("em",{children:n(A,{timestamp:c,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+v&&n("div",{dangerouslySetInnerHTML:{__html:h}}),!!+v&&n("div",{children:n("i",{children:"Message Deleted"})}),!+v&&!!p.length&&n(se,{attachments:p}),w("div",{className:"action-button-wrapper",children:[!o&&E&&n(re,{id:r}),!o&&a&&!+_&&n(ae,{id:r})]}),e&&w(j,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ce({posts:e,highlightedPostId:t,isInPreviewMode:o,handleWrapperScroll:s}){if(!e.length){const r=R("no_posts_available");return n("div",{className:"post-wrapper p-3",children:r})}return n("div",{className:"post-wrapper",onScroll:s,children:e.map(r=>n(ie,{post:r,isPreview:o,highlighted:r.id===t},r.id))})}function le({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function de({questionid:e}){if(console.log("create questionheader for questionid: ",e),e===void 0)return;const[t,o]=i.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function s(){if(console.log("inside questionheader, getting question for questionid: ",e),e===null)return;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:r.signal}).then(c=>c.json()).then(c=>{console.log("reqceived question: ",c),console.log("data.length",c.length),c&&o(c)}),()=>r.abort()}return i.useEffect(s,[e]),w("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}const g={on(e,t,o={}){return document.addEventListener(e,s=>t(s.detail),o),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send"}};function F({activeGroupid:e,group:t,questionid:o}){const[s,r]=i.useState([]),[c,h]=i.useState(0),[p,_]=i.useState(!0),[v,E]=i.useState(null),[a,f]=i.useState(null),m=new URLSearchParams(window.location.search).get("postId"),L=!o&&t?t.isPreviewGroup:!1;let b=!1;i.useEffect(()=>{_(!0)},[e]);const H=i.useCallback(({postid:l})=>{r(d=>d.map(u=>(+u.id==+l&&(u.timedeleted=1),u)))},[]),Q=i.useCallback(({postid:l})=>{r(d=>d.map(u=>(+u.id==+l&&(u.flagged=!0),u)))},[]),W=i.useCallback(()=>{h(l=>l+1)},[]),pe=i.useCallback(()=>{const l=new AbortController;return console.log("fetching initial posts for questionid: ",o),fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:m,questionid:o}),{signal:l.signal}).then(d=>d.json()).then(d=>{var S,J;const u=d.posts;r(u),_(!1),E(((S=u[0])==null?void 0:S.id)??0),f(((J=u[u.length-1])==null?void 0:J.id)??1/0)}).catch(d=>{d.name!=="AbortError"&&console.log(d)}),()=>l.abort()},[e,m]);i.useEffect(()=>(g.on(g.events.MESSAGE_DELETED,H),g.on(g.events.MESSAGE_REPORTED,Q),g.on(g.events.MESSAGE_SEND,W),()=>{g.off(g.events.MESSAGE_DELETED,H),g.off(g.events.MESSAGE_REPORTED,Q),g.off(g.events.MESSAGE_SEND,W)}),[]),i.useEffect(()=>{if(!m)return;const l=document.querySelector(`#learningcompanions_chat-post-${m}`);l&&l.scrollIntoView()},[p]);function ge(){if(a===null||b)return;b=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:a,questionid:o}),{signal:l.signal}).then(d=>d.json()).then(d=>{const u=d.posts;u.length&&(r(S=>[...S,...u]),f(u[u.length-1].id))}).catch(d=>{d.name!=="AbortError"&&console.log(d)}).finally(()=>{b=!1}),()=>l.abort()}function we(){if(v===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${v}&questinogroup=${o}`,{signal:l.signal}).then(d=>d.json()).then(d=>{const u=d.posts;u&&u.length&&(r(S=>[...u,...S]),E(u[0].id))}),()=>l.abort()}i.useEffect(pe,[e]),i.useEffect(we,[c]),i.useEffect(()=>{const l=window.setInterval(()=>{h(d=>d+1)},1e4);return()=>{window.clearInterval(l)}},[]);const _e=l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&ge()};var k;const V=()=>{o?(console.log("we have a question id, make a question header. Question ID: ",o),k=n(de,{questionid:o})):(console.log("no question id, make a group header. Group: ",t),k=n(le,{group:t}))};return i.useEffect(V,[t,o]),V(),w("div",{id:"learningcompanions_chat-postlist",children:[k,L&&n("span",{children:"Is Preview"}),p&&n(D,{}),!p&&n(ce,{posts:s,handleWrapperScroll:_e,isInPreviewMode:L,highlightedPostId:m})]})}const U=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function ue({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,o]=i.useState([]),[s,r]=i.useState(e),[c,h]=i.useState(!1),[p,_]=i.useState(!0);s===void 0&&t.length&&r(t[0].id),i.useEffect(()=>{const a=t.find(L=>+L.id==+s),f=a==null?void 0:a.chatid,m=!window.learningcompanions_questionid&&a?a.isPreviewGroup:!1;te(m,f)},[s,t]);function v(a){const f=new URLSearchParams(window.location.search);f.set("groupid",a),f.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${f}`),r(a)}i.useEffect(()=>{const a=new URLSearchParams,f=new AbortController;U&&a.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${a}`,{signal:f.signal}).then(m=>m.json()).then(({groups:m})=>{o(m),_(!1),m.length===0&&ne()}).catch(m=>{m.name!=="AbortError"&&console.log("Error: "+m.message)})},[c]),i.useEffect(()=>{const a=window.setInterval(()=>{h(f=>!f)},5e4);return()=>{window.clearInterval(a)}},[]);const E=document.getElementById("learningcompanions_chat-content");return w(j,{children:[w("div",{id:"learningcompanions_chat-grouplist",children:[p&&n(D,{}),t.map(a=>n(ee,{handleGroupSelect:v,group:a,activeGroupid:s},a.id)),t.length===0&&!p&&n("p",{children:"No groups found"})]}),N.createPortal(n(F,{activeGroupid:s,group:t.find(a=>+(a==null?void 0:a.id)==+e)}),E)]})}function fe(){I.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(ue,{activeGroupid:window.learningcompanions_groupid})}))}function he(){const e=I.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(F,{questionid:t})}))}const me={startChat:fe,startQuestionChat:he};window.Chat=me})(React,ReactDOM);
