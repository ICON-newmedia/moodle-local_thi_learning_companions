(function(c,A){"use strict";var I={exports:{}},R={};var J=c,K=Symbol.for("react.element"),Y=Symbol.for("react.fragment"),z=Object.prototype.hasOwnProperty,X=J.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Z={key:!0,ref:!0,__self:!0,__source:!0};function N(e,t,r){var o,s={},a=null,h=null;r!==void 0&&(a=""+r),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(h=t.ref);for(o in t)z.call(t,o)&&!Z.hasOwnProperty(o)&&(s[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps,t)s[o]===void 0&&(s[o]=t[o]);return{$$typeof:K,type:e,key:a,ref:h,props:s,_owner:X.current}}R.Fragment=Y,R.jsx=N,R.jsxs=N,function(e){e.exports=R}(I);const x=I.exports.Fragment,n=I.exports.jsx,_=I.exports.jsxs;var b={},j=A;b.createRoot=j.createRoot,b.hydrateRoot=j.hydrateRoot;function D({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"-"});const r=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,t).format(r);return n("div",{className:"learningcompanions_chat_time",children:o})}function q({handleGroupSelect:e,group:t,activeGroupid:r}){const{name:o,id:s,description:a,chatid:h,shortdescription:g,imageurl:w,latestcomment:v,isPreview:E,timecreated:y}=t,i=function(){e(s,h)};let f="d-flex learningcompanions_chat-group";return typeof r<"u"&&parseInt(r)===parseInt(s)&&(f+=" learningcompanions_currentgroup"),E&&(f+=" learningcompanions_previewgroup"),_("div",{onClick:i,id:"learningcompanions_chat-group-"+s,className:f,children:[n("img",{className:"learningcompanions_group_image_small",src:w}),_("div",{className:"learningcompanions_group_infos",children:[n("em",{children:o}),n("br",{}),n("span",{children:g})]}),n(D,{timestamp:v??y})]})}function G(){return n("div",{className:"learningcompanions_loading"})}function L(e,t="local_learningcompanions",r=[]){var h;const o=((h=window.M.str[t])==null?void 0:h[e])??`[[${e}_not_found]]`;if(!r.length)return o;const s=/{\$a->(\w*)}/gm,a=/{\$a}/gm;return typeof r=="object"?o.replace(s,(g,w)=>r[w]??g):o.replace(a,r)}const O=".js-chat-preview",k="#fitem_id_message",C="#fitem_id_attachments",T=".fdescription.required";function $(e,t){var o,s;let r=t;e?(r="",(o=document.querySelector(O))==null||o.classList.replace("d-none","d-flex"),document.querySelectorAll(`${k}, ${C}, ${T}`).forEach(a=>a.classList.add("d-none"))):((s=document.querySelector(O))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${k}, ${C}, ${T}`).forEach(a=>a.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=r}function ee(){document.querySelector(".chat-post-form").classList.add("d-none")}function te({attachment:e}){const{url:t,filename:r}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:r})})}function ne({attachments:e=[]}){return e.map(t=>n(te,{attachment:t}))}function oe({id:e}){const t=L("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function re({id:e}){const t=L("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function se({id:e,isratedbyuser:t}){return n("a",{href:"#","data-id":e,title:"Rate",className:`learningcompanions_rate_comment ${t?"learningcompanions_israted_by_current_user":""}`})}function ae({highlighted:e,post:t,isPreview:r,questionid:o}){const{author:s,id:a,timecreated:h,comment:g,attachments:w,flagged:v,timedeleted:E}=t;let y=!1,i=!1,f=o>0&&+s.id!=+window.learningcompanions_chat_userid,p;return typeof window.learningcompanions_chat_userid!==void 0&&+s.id==+window.learningcompanions_chat_userid?(y=!0,p="learningcompanions_chat-my-post"):(i=!0,p="learningcompanions_chat-other-post"),+v&&(p+=" learningcompanions_chat-reported-post"),_("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${p}`,children:[_("strong",{children:[s.firstname," ",s.lastname]}),n("br",{}),n("em",{children:n(D,{timestamp:h,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+E&&n("div",{dangerouslySetInnerHTML:{__html:g}}),!!+E&&n("div",{children:n("i",{children:"Message Deleted"})}),!+E&&!!w.length&&n(ne,{attachments:w}),_("div",{className:"action-button-wrapper",children:[!r&&y&&n(oe,{id:a}),!r&&i&&!+v&&n(re,{id:a}),!r&&f&&n(se,{id:a,isratedbyuser:t.isratedbyuser})]}),e&&_(x,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ie({posts:e,highlightedPostId:t,isInPreviewMode:r,handleWrapperScroll:o,questionid:s}){if(typeof e>"u"||!e.length){const a=L("no_posts_available");return n("div",{className:"post-wrapper p-3",children:a})}return n("div",{className:"post-wrapper",onScroll:o,children:e.map(a=>n(ae,{post:a,isPreview:r,highlighted:a.id===t,questionid:s},a.id))})}const m={on(e,t,r={}){return document.addEventListener(e,o=>t(o.detail),r),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send",MESSAGE_RATED:"learningcompanions_message_rated"}};function ce({questionid:e}){if(e===void 0)return;const[t,r]=c.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function o(){if(e===null)return;const s=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:s.signal}).then(a=>a.json()).then(a=>{a&&r(a)}),()=>s.abort()}return c.useEffect(o,[e]),_("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}function le({group:e}){if(e!==void 0)return _("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function de({questionid:e,group:t}){if(e)return n(ce,{questionid:e});if(t)return n(le,{group:t})}function B({activeGroupid:e,group:t,questionid:r}){const[o,s]=c.useState([]),[a,h]=c.useState(0),[g,w]=c.useState(!0),[v,E]=c.useState(null),[y,i]=c.useState(null),f=new URLSearchParams(window.location.search).get("postId"),p=!r&&t?t.isPreviewGroup:!1;let P=!1;c.useEffect(()=>{w(!0)},[e]);const U=c.useCallback(({postid:l})=>{s(u=>u.map(d=>(+d.id==+l&&(d.timedeleted=1),d)))},[]),H=c.useCallback(({postid:l})=>{s(u=>u.map(d=>(+d.id==+l&&(d.flagged=!0),d)))},[]),W=c.useCallback(({postid:l,newvalue:u})=>{s(d=>d.map(S=>(+S.id==+l&&(S.isratedbyuser=u),S)))}),Q=c.useCallback(()=>{h(l=>l+1)},[]),he=c.useCallback(()=>{const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:f,questionid:r}),{signal:l.signal}).then(u=>u.json()).then(u=>{var S,V;const d=u.posts;s(d),w(!1),E(((S=d[0])==null?void 0:S.id)??0),i(((V=d[d.length-1])==null?void 0:V.id)??1/0)}).catch(u=>{u.name}),()=>l.abort()},[e,f]);c.useEffect(()=>(m.on(m.events.MESSAGE_DELETED,U),m.on(m.events.MESSAGE_REPORTED,H),m.on(m.events.MESSAGE_SEND,Q),m.on(m.events.MESSAGE_RATED,W),()=>{m.off(m.events.MESSAGE_DELETED,U),m.off(m.events.MESSAGE_REPORTED,H),m.off(m.events.MESSAGE_SEND,Q),m.off(m.events.MESSAGE_RATED,W)}),[]),c.useEffect(()=>{if(!f)return;const l=document.querySelector(`#learningcompanions_chat-post-${f}`);l&&l.scrollIntoView()},[g]);function ge(){if(y===null||P)return;P=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:y,questionid:r}),{signal:l.signal}).then(u=>u.json()).then(u=>{const d=u.posts;d.length&&(s(S=>[...S,...d]),i(d[d.length-1].id))}).catch(u=>{u.name}).finally(()=>{P=!1}),()=>l.abort()}function _e(){if(v===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${v}&questionid=${r}`,{signal:l.signal}).then(u=>u.json()).then(u=>{const d=u.posts;d&&d.length&&(s(S=>[...d,...S]),E(d[0].id))}),()=>l.abort()}return c.useEffect(he,[e]),c.useEffect(_e,[a]),c.useEffect(()=>{const l=window.setInterval(()=>{h(u=>u+1)},1e4);return()=>{window.clearInterval(l)}},[]),_("div",{id:"learningcompanions_chat-postlist",children:[n(de,{group:t,questionid:r}),g&&n(G,{}),!g&&n(ie,{posts:o,handleWrapperScroll:l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&ge()},isInPreviewMode:p,highlightedPostId:f,questionid:r})]})}const F=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function ue({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,r]=c.useState([]),[o,s]=c.useState(e),[a,h]=c.useState(!1),[g,w]=c.useState(!0);o===void 0&&t.length&&s(t[0].id),c.useEffect(()=>{const i=t.find(P=>+P.id==+o),f=i==null?void 0:i.chatid,p=!window.learningcompanions_questionid&&i?i.isPreviewGroup:!1;$(p,f)},[o,t]);function v(i){const f=new URLSearchParams(window.location.search);f.set("groupid",i),f.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${f}`),s(i)}c.useEffect(()=>{const i=new URLSearchParams,f=new AbortController;F&&i.set("shouldIncludeId",F),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${i}`,{signal:f.signal}).then(p=>p.json()).then(({groups:p})=>{r(p),w(!1),p.length===0&&ee()}).catch(p=>{p.name!=="AbortError"&&console.log("Error: "+p.message)})},[a]),c.useEffect(()=>{const i=window.setInterval(()=>{h(f=>!f)},5e4);return()=>{window.clearInterval(i)}},[]);const E=document.getElementById("learningcompanions_chat-content"),y=t.find(i=>+(i==null?void 0:i.id)==+o);return _(x,{children:[_("div",{id:"learningcompanions_chat-grouplist",children:[g&&n(G,{}),t.map(i=>n(q,{handleGroupSelect:v,group:i,activeGroupid:o},i.id)),t.length===0&&!g&&n("p",{children:"No groups found"})]}),A.createPortal(n(B,{activeGroupid:o,group:y}),E)]})}function fe(){b.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(ue,{activeGroupid:window.learningcompanions_groupid})}))}function me(){const e=b.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(B,{questionid:t})}))}const pe={startChat:fe,startQuestionChat:me};window.Chat=pe})(React,ReactDOM);
