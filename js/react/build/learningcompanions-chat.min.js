(function(d,x){"use strict";var P={exports:{}},y={};var W=d,V=Symbol.for("react.element"),J=Symbol.for("react.fragment"),K=Object.prototype.hasOwnProperty,Y=W.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,z={key:!0,ref:!0,__self:!0,__source:!0};function N(e,t,r){var n,s={},p=null,f=null;r!==void 0&&(p=""+r),t.key!==void 0&&(p=""+t.key),t.ref!==void 0&&(f=t.ref);for(n in t)K.call(t,n)&&!z.hasOwnProperty(n)&&(s[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps,t)s[n]===void 0&&(s[n]=t[n]);return{$$typeof:V,type:e,key:p,ref:f,props:s,_owner:Y.current}}y.Fragment=J,y.jsx=N,y.jsxs=N,function(e){e.exports=y}(P);const O=P.exports.Fragment,o=P.exports.jsx,w=P.exports.jsxs;var L={},j=x;L.createRoot=j.createRoot,L.hydrateRoot=j.hydrateRoot;function A({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return o("div",{className:"learningcompanions_chat_time",children:"No Time!"});const r=new Date(e*1e3),n=new Intl.DateTimeFormat(void 0,t).format(r);return o("div",{className:"learningcompanions_chat_time",children:n})}function Q({handleGroupSelect:e,group:t,activeGroupid:r}){const{name:n,id:s,description:p,chatid:f,shortdescription:h,imageurl:g,latestcomment:_,isPreview:v}=t,a=function(){e(s,f)};let i="d-flex learningcompanions_chat-group";return typeof r<"u"&&parseInt(r)===parseInt(s)&&(i+=" learningcompanions_currentgroup"),v&&(i+=" learningcompanions_previewgroup"),w("div",{onClick:a,id:"learningcompanions_chat-group-"+s,className:i,children:[o("img",{className:"learningcompanions_group_image_small",src:g}),w("div",{className:"learningcompanions_group_infos",children:[o("em",{children:n}),o("br",{}),o("span",{children:h})]}),o(A,{timestamp:_})]})}function k(){return o("div",{className:"learningcompanions_loading"})}function R(e,t="local_learningcompanions",r=[]){var f;const n=((f=window.M.str[t])==null?void 0:f[e])??`[[${e}_not_found]]`;if(!r.length)return n;const s=/{\$a->(\w*)}/gm,p=/{\$a}/gm;return typeof r=="object"?n.replace(s,(h,g)=>r[g]??h):n.replace(p,r)}const D=".js-chat-preview",G="#fitem_id_message",C="#fitem_id_attachments",T=".fdescription.required";function X(e,t){var n,s;let r=t;e?(r="",(n=document.querySelector(D))==null||n.classList.replace("d-none","d-flex"),document.querySelectorAll(`${G}, ${C}, ${T}`).forEach(p=>p.classList.add("d-none"))):((s=document.querySelector(D))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${G}, ${C}, ${T}`).forEach(p=>p.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=r}function Z(){document.querySelector(".chat-post-form").classList.add("d-none")}function q({attachment:e}){const{url:t,filename:r}=e;return o("div",{children:o("a",{target:"_blank",href:t,children:r})})}function $({attachments:e=[]}){return e.map(t=>o(q,{attachment:t}))}function ee({id:e}){const t=R("delete_post");return o("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function te({id:e}){const t=R("report_post");return o("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ne({highlighted:e,post:t,isPreview:r}){const{author:n,id:s,timecreated:p,comment:f,attachments:h,flagged:g,timedeleted:_}=t;let v=!1,a=!1,i;return typeof window.learningcompanions_chat_userid!==void 0&&+n.id==+window.learningcompanions_chat_userid?(v=!0,i="learningcompanions_chat-my-post"):(a=!0,i="learningcompanions_chat-other-post"),+g&&(i+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${s}`,className:`learningcompanions_chat-post ${i}`,children:[w("strong",{children:[n.firstname," ",n.lastname]}),o("br",{}),o("em",{children:o(A,{timestamp:p,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),o("br",{}),!+_&&o("div",{dangerouslySetInnerHTML:{__html:f}}),!!+_&&o("div",{children:o("i",{children:"Message Deleted"})}),!+_&&!!h.length&&o($,{attachments:h}),w("div",{className:"action-button-wrapper",children:[!r&&v&&o(ee,{id:s}),!r&&a&&!+g&&o(te,{id:s})]}),e&&w(O,{children:[o("br",{}),o("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function oe({posts:e,highlightedPostId:t,isInPreviewMode:r,handleWrapperScroll:n}){if(!e.length){const s=R("no_posts_available");return o("div",{className:"post-wrapper p-3",children:s})}return o("div",{className:"post-wrapper",onScroll:n,children:e.map(s=>o(ne,{post:s,isPreview:r,highlighted:s.id===t},s.id))})}function se({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[o("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),o("h1",{children:e.name}),e.dummyGroup||o("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}const E={on(e,t,r={}){return document.addEventListener(e,n=>t(n.detail),r),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}};function re({activeGroupid:e,groups:t}){const[r,n]=d.useState([]),[s,p]=d.useState(0),[f,h]=d.useState(!0),[g,_]=d.useState(null),[v,a]=d.useState(null),i=new URLSearchParams(window.location.search).get("postId"),m=t.find(c=>+c.id==+e),I=(m==null?void 0:m.isPreviewGroup)??!1;let b=!1;d.useEffect(()=>{h(!0)},[e]);const U=d.useCallback(({postid:c})=>{n(l=>l.map(u=>(+u.id==+c&&(u.timedeleted=1),u)))},[]),B=d.useCallback(({postid:c})=>{n(l=>l.map(u=>(+u.id==+c&&(u.flagged=!0),u)))},[]),ie=d.useCallback(()=>{const c=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:i}),{signal:c.signal}).then(l=>l.json()).then(l=>{var S,H;const u=l.posts;n(u),h(!1),_(((S=u[0])==null?void 0:S.id)??0),a(((H=u[u.length-1])==null?void 0:H.id)??1/0)}).catch(l=>{l.name!=="AbortError"&&console.log(l)}),()=>c.abort()},[e,i]);d.useEffect(()=>(E.on(E.events.MESSAGE_DELETED,U),E.on(E.events.MESSAGE_REPORTED,B),()=>{E.off(E.events.MESSAGE_DELETED,U),E.off(E.events.MESSAGE_REPORTED,B)}),[]),d.useEffect(()=>{if(!i)return;const c=document.querySelector(`#learningcompanions_chat-post-${i}`);c&&c.scrollIntoView()},[f]);function ce(){if(v===null||b)return;b=!0;const c=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:v}),{signal:c.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(n(S=>[...S,...u]),a(u[u.length-1].id))}).catch(l=>{l.name!=="AbortError"&&console.log(l)}).finally(()=>{b=!1}),()=>c.abort()}function le(){if(g===null)return;const c=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${g}`,{signal:c.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(n(S=>[...u,...S]),_(u[0].id))}),()=>c.abort()}d.useEffect(ie,[e]),d.useEffect(le,[s]),d.useEffect(()=>{const c=window.setInterval(()=>{p(l=>l+1)},3e4);return()=>{window.clearInterval(c)}},[]);const de=c=>{-c.target.scrollTop+c.target.clientHeight>=c.target.scrollHeight&&ce()};return w("div",{id:"learningcompanions_chat-postlist",children:[o(se,{group:m}),I&&o("span",{children:"Is Preview"}),f&&o(k,{}),!f&&t.length>0&&o(oe,{posts:r,handleWrapperScroll:de,isInPreviewMode:I,highlightedPostId:i})]})}const F=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function ae({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,r]=d.useState([]),[n,s]=d.useState(e),[p,f]=d.useState(!1),[h,g]=d.useState(!0);n===void 0&&t.length&&s(t[0].id),d.useEffect(()=>{const a=t.find(I=>+I.id==+n),i=a==null?void 0:a.chatid,m=(a==null?void 0:a.isPreviewGroup)??!1;X(m,i),console.log(`setting active group id to: ${n} and chatid to: ${i}`)},[n,t]);function _(a){const i=new URLSearchParams(window.location.search);i.set("groupid",a),i.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${i}`),s(a)}d.useEffect(()=>{const a=new URLSearchParams,i=new AbortController;F&&a.set("shouldIncludeId",F),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${a}`,{signal:i.signal}).then(m=>m.json()).then(({groups:m})=>{console.log("Groups",m),r(m),g(!1),m.length===0&&Z()}).catch(m=>{m.name!=="AbortError"&&console.log("Error: "+m.message)})},[p]),d.useEffect(()=>{const a=window.setInterval(()=>{f(i=>!i)},5e4);return()=>{window.clearInterval(a)}},[]);const v=document.getElementById("learningcompanions_chat-content");return w(O,{children:[w("div",{id:"learningcompanions_chat-grouplist",children:[h&&o(k,{}),t.map(a=>o(Q,{handleGroupSelect:_,group:a,activeGroupid:n},a.id)),t.length===0&&!h&&o("p",{children:"No groups found"})]}),x.createPortal(o(re,{activeGroupid:n,groups:t}),v)]})}L.createRoot(document.getElementById("learningcompanions_groups-content")).render(o(React.StrictMode,{children:o(ae,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
