(function(l,K){"use strict";var S={exports:{}},y={};var Y=l,z=Symbol.for("react.element"),Q=Symbol.for("react.fragment"),X=Object.prototype.hasOwnProperty,Z=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,q={key:!0,ref:!0,__self:!0,__source:!0};function D(e,n,i){var s,o={},m=null,g=null;i!==void 0&&(m=""+i),n.key!==void 0&&(m=""+n.key),n.ref!==void 0&&(g=n.ref);for(s in n)X.call(n,s)&&!q.hasOwnProperty(s)&&(o[s]=n[s]);if(e&&e.defaultProps)for(s in n=e.defaultProps,n)o[s]===void 0&&(o[s]=n[s]);return{$$typeof:z,type:e,key:m,ref:g,props:o,_owner:Z.current}}y.Fragment=Q,y.jsx=D,y.jsxs=D,function(e){e.exports=y}(S);const $=S.exports.Fragment,t=S.exports.jsx,w=S.exports.jsxs;var I={},L=K;I.createRoot=L.createRoot,I.hydrateRoot=L.hydrateRoot;function b({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const i=new Date(e*1e3),s=new Intl.DateTimeFormat(void 0,n).format(i);return t("div",{className:"learningcompanions_chat_time",children:s})}function ee({handleGroupSelect:e,group:n,activeGroupid:i}){const{name:s,id:o,description:m,chatid:g,shortdescription:_,imageurl:v,latestcomment:a,isPreview:h}=n,f=function(){e(o,g)};let d="d-flex learningcompanions_chat-group";return typeof i<"u"&&parseInt(i)===parseInt(o)&&(d+=" learningcompanions_currentgroup"),h&&(d+=" learningcompanions_previewgroup"),w("div",{onClick:f,id:"learningcompanions_chat-group-"+o,className:d,children:[t("img",{className:"learningcompanions_group_image_small",src:v}),w("div",{className:"learningcompanions_group_infos",children:[t("em",{children:s}),t("br",{}),t("span",{children:_})]}),t(b,{timestamp:a})]})}function O(){return t("div",{className:"learningcompanions_loading"})}const p={on(e,n,i={}){return document.addEventListener(e,s=>n(s.detail),i),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",GROUPS_UPDATED:"learningcompanions_groups_updated"}},A=".js-chat-preview",N="#fitem_id_message",k="#fitem_id_attachments",C=".fdescription.required";function te(e,n){var s,o;let i=n;e?(console.log("I make the input invisible"),i="",(s=document.querySelector(A))==null||s.classList.replace("d-none","d-flex"),document.querySelectorAll(`${N}, ${k}, ${C}`).forEach(m=>m.classList.add("d-none"))):(console.log("I make the input Visible"),(o=document.querySelector(A))==null||o.classList.replace("d-flex","d-none"),document.querySelectorAll(`${N}, ${k}, ${C}`).forEach(m=>m.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=i}const U=new URLSearchParams(window.location.search).get("groupid");function ne({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[i,s]=l.useState([]),[o,m]=l.useState(e),[g,_]=l.useState(!0);l.useEffect(()=>{const a=i.find(d=>+d.id==+o),h=a==null?void 0:a.chatid,f=(a==null?void 0:a.isPreviewGroup)??!1;te(f,h),console.log(`setting active group id to: ${o} and chatid to: ${h}`)},[o,i]);function v(a){p.dispatch(p.events.GROUP_CHANGED,{groupid:a});const h=new URLSearchParams(window.location.search);h.set("groupid",a),h.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${h}`),m(a)}return l.useEffect(()=>{const a=new AbortController,h=window.setInterval(()=>{const f=new URLSearchParams;U&&f.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${f}`,{signal:a.signal}).then(d=>d.json()).then(({groups:d})=>{s(d),_(!1),p.dispatch(p.events.GROUPS_UPDATED,{groups:d})}).catch(d=>{d.name!=="AbortError"&&console.log("Error: "+d.message)})},5e3);return()=>{a.abort(),window.clearInterval(h)}},[]),w("div",{id:"learningcompanions_chat-grouplist",children:[g&&t(O,{}),i.map(a=>t(ee,{handleGroupSelect:v,group:a,activeGroupid:o},a.id))]})}function oe({attachment:e}){const{url:n,filename:i}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:i})})}function se({attachments:e=[]}){return e.map(n=>t(oe,{attachment:n}))}function re({id:e}){return t("a",{href:"#","data-id":e,title:"[[Delete]]",className:"learningcompanions_delete_comment"})}function ie({id:e}){return t("a",{href:"#","data-id":e,title:"[[Report]]",className:"learningcompanions_report_comment"})}function ae({highlighted:e,post:n,isPreview:i}){const{author:s,id:o,timecreated:m,comment:g,attachments:_,flagged:v,timedeleted:a}=n;let h=!1,f=!1,d;return typeof window.learningcompanions_chat_userid!==void 0&&+s.id==+window.learningcompanions_chat_userid?(h=!0,d="learningcompanions_chat-my-post"):(f=!0,d="learningcompanions_chat-other-post"),+v&&(d+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${o}`,className:`learningcompanions_chat-post ${d}`,children:[w("strong",{children:[s.firstname," ",s.lastname]}),t("br",{}),t("em",{children:t(b,{timestamp:m,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),t("br",{}),!+a&&t("div",{dangerouslySetInnerHTML:{__html:g}}),!!+a&&t("div",{children:t("i",{children:"Message Deleted"})}),!+a&&!!_.length&&t(se,{attachments:_}),w("div",{className:"action-button-wrapper",children:[!i&&h&&t(re,{id:o}),!i&&f&&!+v&&t(ie,{id:o})]}),w("span",{children:["ID: ",o]}),e&&w($,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ce({posts:e,highlightedPostId:n,isInPreviewMode:i,handleWrapperScroll:s}){return e.length?t("div",{className:"post-wrapper",onScroll:s,children:e.map(o=>t(ae,{post:o,isPreview:i,highlighted:o.id===n},o.id))}):t("div",{className:"post-wrapper p-3",children:"[[No Posts available]]"})}function le({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),e.dummyGroup||t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function de({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[i,s]=l.useState([]),[o,m]=l.useState(e),[g,_]=l.useState([]),[v,a]=l.useState(0),[h,f]=l.useState(!0),[d,x]=l.useState(null),[j,T]=l.useState(null),R=new URLSearchParams(window.location.search).get("postId"),P=g.find(r=>+r.id==+o),H=(P==null?void 0:P.isPreviewGroup)??!1;let G=!1;const F=l.useCallback(r=>{m(r.groupid),f(!0)},[]),B=l.useCallback(r=>{console.log("Data",r),_(r.groups)},[]),V=l.useCallback(({postid:r})=>{s(c=>c.map(u=>(+u.id==+r&&(u.timedeleted=1),u)))},[]),W=l.useCallback(({postid:r})=>{s(c=>c.map(u=>(+u.id==+r&&(u.flagged=!0),u)))},[]);l.useEffect(()=>(p.on(p.events.GROUP_CHANGED,F),p.on(p.events.MESSAGE_DELETED,V),p.on(p.events.MESSAGE_REPORTED,W),p.on(p.events.GROUPS_UPDATED,B),()=>{p.off(p.events.GROUP_CHANGED,F),p.off(p.events.MESSAGE_DELETED,V),p.off(p.events.MESSAGE_REPORTED,W),p.off(p.events.GROUPS_UPDATED,B)}),[]),l.useEffect(()=>{if(!R)return;const r=document.querySelector(`#learningcompanions_chat-post-${R}`);console.log("Found element:",r),r&&r.scrollIntoView()},[h]);function me(){if(j===null||G)return;G=!0;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:o,firstPostId:j}),{signal:r.signal}).then(c=>c.json()).then(c=>{const u=c.posts;u.length&&(s(E=>[...E,...u]),T(u[u.length-1].id))}).catch(c=>{c.name!=="AbortError"&&console.log(c)}).finally(()=>{G=!1}),()=>r.abort()}function he(){const r=new AbortController;return console.log("Using this group:",P),fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:o,includedPostId:R,previewGroup:n}),{signal:r.signal}).then(c=>c.json()).then(c=>{var E,J;const u=c.posts;s(u),f(!1),x(((E=u[0])==null?void 0:E.id)??0),T(((J=u[u.length-1])==null?void 0:J.id)??1/0)}).catch(c=>{c.name!=="AbortError"&&console.log(c)}),()=>r.abort()}function fe(){if(d===null)return;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${o}&lastPostId=${d}`,{signal:r.signal}).then(c=>c.json()).then(c=>{const u=c.posts;u.length&&(s(E=>[...u,...E]),x(u[0].id))}),()=>r.abort()}return l.useEffect(he,[o]),l.useEffect(fe,[v]),l.useEffect(()=>{const r=window.setInterval(()=>{a(c=>c+1)},3e4);return()=>{window.clearInterval(r)}},[]),w("div",{id:"learningcompanions_chat-postlist",children:[t(le,{group:P}),H&&t("span",{children:"Is Preview"}),h&&t(O,{}),!h&&t(ce,{posts:i,handleWrapperScroll:r=>{-r.target.scrollTop+r.target.clientHeight>=r.target.scrollHeight&&me()},isInPreviewMode:H,highlightedPostId:R})]})}const ue=I.createRoot(document.getElementById("learningcompanions_groups-content")),pe=I.createRoot(document.getElementById("learningcompanions_chat-content"));ue.render(t(React.StrictMode,{children:t(ne,{activeGroupid:window.learningcompanions_groupid})})),pe.render(t(React.StrictMode,{children:t(de,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
