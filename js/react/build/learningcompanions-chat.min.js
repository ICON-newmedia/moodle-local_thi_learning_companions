(function(c,J){"use strict";var P={exports:{}},y={};var K=c,Y=Symbol.for("react.element"),z=Symbol.for("react.fragment"),Q=Object.prototype.hasOwnProperty,X=K.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Z={key:!0,ref:!0,__self:!0,__source:!0};function L(e,n,s){var o,r={},f=null,h=null;s!==void 0&&(f=""+s),n.key!==void 0&&(f=""+n.key),n.ref!==void 0&&(h=n.ref);for(o in n)Q.call(n,o)&&!Z.hasOwnProperty(o)&&(r[o]=n[o]);if(e&&e.defaultProps)for(o in n=e.defaultProps,n)r[o]===void 0&&(r[o]=n[o]);return{$$typeof:Y,type:e,key:f,ref:h,props:r,_owner:X.current}}y.Fragment=z,y.jsx=L,y.jsxs=L,function(e){e.exports=y}(P);const q=P.exports.Fragment,t=P.exports.jsx,w=P.exports.jsxs;var I={},b=J;I.createRoot=b.createRoot,I.hydrateRoot=b.hydrateRoot;function O({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const s=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,n).format(s);return t("div",{className:"learningcompanions_chat_time",children:o})}function $({handleGroupSelect:e,group:n,activeGroupid:s}){const{name:o,id:r,description:f,chatid:h,shortdescription:_,imageurl:v,latestcomment:g,isPreview:a}=n,m=function(){e(r,h)};let d="d-flex learningcompanions_chat-group";return typeof s<"u"&&parseInt(s)===parseInt(r)&&(d+=" learningcompanions_currentgroup"),a&&(d+=" learningcompanions_previewgroup"),w("div",{onClick:m,id:"learningcompanions_chat-group-"+r,className:d,children:[t("img",{className:"learningcompanions_group_image_small",src:v}),w("div",{className:"learningcompanions_group_infos",children:[t("em",{children:o}),t("br",{}),t("span",{children:_})]}),t(O,{timestamp:g})]})}function A(){return t("div",{className:"learningcompanions_loading"})}const p={on(e,n,s={}){return document.addEventListener(e,o=>n(o.detail),s),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",GROUPS_UPDATED:"learningcompanions_groups_updated"}},N=".js-chat-preview",k="#fitem_id_message",C="#fitem_id_attachments",U=".fdescription.required";function ee(e,n){var o,r;let s=n;e?(console.log("I make the input invisible"),s="",(o=document.querySelector(N))==null||o.classList.replace("d-none","d-flex"),document.querySelectorAll(`${k}, ${C}, ${U}`).forEach(f=>f.classList.add("d-none"))):(console.log("I make the input Visible"),(r=document.querySelector(N))==null||r.classList.replace("d-flex","d-none"),document.querySelectorAll(`${k}, ${C}, ${U}`).forEach(f=>f.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=s}const x=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function te({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=c.useState([]),[o,r]=c.useState(e),[f,h]=c.useState(!1),[_,v]=c.useState(!0);c.useEffect(()=>{const a=n.find(R=>+R.id==+o),m=a==null?void 0:a.chatid,d=(a==null?void 0:a.isPreviewGroup)??!1;ee(d,m),console.log(`setting active group id to: ${o} and chatid to: ${m}`)},[o,n]);function g(a){p.dispatch(p.events.GROUP_CHANGED,{groupid:a});const m=new URLSearchParams(window.location.search);m.set("groupid",a),m.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${m}`),r(a)}return c.useEffect(()=>{const a=new URLSearchParams,m=new AbortController;x&&a.set("shouldIncludeId",x),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${a}`,{signal:m.signal}).then(d=>d.json()).then(({groups:d})=>{console.log("Groups",d),s(d),v(!1),p.dispatch(p.events.GROUPS_UPDATED,{groups:d})}).catch(d=>{d.name!=="AbortError"&&console.log("Error: "+d.message)})},[f]),c.useEffect(()=>{const a=window.setInterval(()=>{h(m=>!m)},5e4);return()=>{window.clearInterval(a)}},[]),w("div",{id:"learningcompanions_chat-grouplist",children:[_&&t(A,{}),n.map(a=>t($,{handleGroupSelect:g,group:a,activeGroupid:o},a.id))]})}function ne({attachment:e}){const{url:n,filename:s}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:s})})}function oe({attachments:e=[]}){return e.map(n=>t(ne,{attachment:n}))}function se({id:e}){return t("a",{href:"#","data-id":e,title:"[[Delete]]",className:"learningcompanions_delete_comment"})}function re({id:e}){return t("a",{href:"#","data-id":e,title:"[[Report]]",className:"learningcompanions_report_comment"})}function ie({highlighted:e,post:n,isPreview:s}){const{author:o,id:r,timecreated:f,comment:h,attachments:_,flagged:v,timedeleted:g}=n;let a=!1,m=!1,d;return typeof window.learningcompanions_chat_userid!==void 0&&+o.id==+window.learningcompanions_chat_userid?(a=!0,d="learningcompanions_chat-my-post"):(m=!0,d="learningcompanions_chat-other-post"),+v&&(d+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${r}`,className:`learningcompanions_chat-post ${d}`,children:[w("strong",{children:[o.firstname," ",o.lastname]}),t("br",{}),t("em",{children:t(O,{timestamp:f,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),t("br",{}),!+g&&t("div",{dangerouslySetInnerHTML:{__html:h}}),!!+g&&t("div",{children:t("i",{children:"Message Deleted"})}),!+g&&!!_.length&&t(oe,{attachments:_}),w("div",{className:"action-button-wrapper",children:[!s&&a&&t(se,{id:r}),!s&&m&&!+v&&t(re,{id:r})]}),w("span",{children:["ID: ",r]}),e&&w(q,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ae({posts:e,highlightedPostId:n,isInPreviewMode:s,handleWrapperScroll:o}){return e.length?t("div",{className:"post-wrapper",onScroll:o,children:e.map(r=>t(ie,{post:r,isPreview:s,highlighted:r.id===n},r.id))}):t("div",{className:"post-wrapper p-3",children:"[[No Posts available]]"})}function ce({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),e.dummyGroup||t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function le({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=c.useState([]),[o,r]=c.useState(e),[f,h]=c.useState([]),[_,v]=c.useState(0),[g,a]=c.useState(!0),[m,d]=c.useState(null),[R,j]=c.useState(null),S=new URLSearchParams(window.location.search).get("postId"),G=f.find(i=>+i.id==+o),T=(G==null?void 0:G.isPreviewGroup)??!1;let D=!1;const H=c.useCallback(i=>{r(i.groupid),a(!0)},[]),B=c.useCallback(i=>{h(i.groups)},[]),F=c.useCallback(({postid:i})=>{s(l=>l.map(u=>(+u.id==+i&&(u.timedeleted=1),u)))},[]),V=c.useCallback(({postid:i})=>{s(l=>l.map(u=>(+u.id==+i&&(u.flagged=!0),u)))},[]),pe=c.useCallback(()=>{const i=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:o,includedPostId:S}),{signal:i.signal}).then(l=>l.json()).then(l=>{var E,W;const u=l.posts;s(u),a(!1),d(((E=u[0])==null?void 0:E.id)??0),j(((W=u[u.length-1])==null?void 0:W.id)??1/0)}).catch(l=>{l.name!=="AbortError"&&console.log(l)}),()=>i.abort()},[o,S]);c.useEffect(()=>(p.on(p.events.GROUP_CHANGED,H),p.on(p.events.MESSAGE_DELETED,F),p.on(p.events.MESSAGE_REPORTED,V),p.on(p.events.GROUPS_UPDATED,B),()=>{p.off(p.events.GROUP_CHANGED,H),p.off(p.events.MESSAGE_DELETED,F),p.off(p.events.MESSAGE_REPORTED,V),p.off(p.events.GROUPS_UPDATED,B)}),[]),c.useEffect(()=>{if(!S)return;const i=document.querySelector(`#learningcompanions_chat-post-${S}`);i&&i.scrollIntoView()},[g]);function me(){if(R===null||D)return;D=!0;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:o,firstPostId:R}),{signal:i.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(s(E=>[...E,...u]),j(u[u.length-1].id))}).catch(l=>{l.name!=="AbortError"&&console.log(l)}).finally(()=>{D=!1}),()=>i.abort()}function fe(){if(m===null)return;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${o}&lastPostId=${m}`,{signal:i.signal}).then(l=>l.json()).then(l=>{const u=l.posts;u.length&&(s(E=>[...u,...E]),d(u[0].id))}),()=>i.abort()}return c.useEffect(pe,[o]),c.useEffect(fe,[_]),c.useEffect(()=>{const i=window.setInterval(()=>{v(l=>l+1)},3e4);return()=>{window.clearInterval(i)}},[]),w("div",{id:"learningcompanions_chat-postlist",children:[t(ce,{group:G}),T&&t("span",{children:"Is Preview"}),g&&t(A,{}),!g&&t(ae,{posts:n,handleWrapperScroll:i=>{-i.target.scrollTop+i.target.clientHeight>=i.target.scrollHeight&&me()},isInPreviewMode:T,highlightedPostId:S})]})}const de=I.createRoot(document.getElementById("learningcompanions_groups-content")),ue=I.createRoot(document.getElementById("learningcompanions_chat-content"));de.render(t(React.StrictMode,{children:t(te,{activeGroupid:window.learningcompanions_groupid})})),ue.render(t(React.StrictMode,{children:t(le,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
