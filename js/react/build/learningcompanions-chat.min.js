(function(c,A){"use strict";var I={},K={get exports(){return I},set exports(e){I=e}},b={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y=c,z=Symbol.for("react.element"),X=Symbol.for("react.fragment"),Z=Object.prototype.hasOwnProperty,q=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$={key:!0,ref:!0,__self:!0,__source:!0};function N(e,t,s){var o,r={},a=null,u=null;s!==void 0&&(a=""+s),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(u=t.ref);for(o in t)Z.call(t,o)&&!$.hasOwnProperty(o)&&(r[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps,t)r[o]===void 0&&(r[o]=t[o]);return{$$typeof:z,type:e,key:a,ref:u,props:r,_owner:q.current}}b.Fragment=X,b.jsx=N,b.jsxs=N,function(e){e.exports=b}(K);const x=I.Fragment,n=I.jsx,g=I.jsxs;var L={},j=A;L.createRoot=j.createRoot,L.hydrateRoot=j.hydrateRoot;function D({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"-"});const s=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,t).format(s);return n("div",{className:"learningcompanions_chat_time",children:o})}function ee({handleGroupSelect:e,group:t,activeGroupid:s}){const{name:o,id:r,description:a,chatid:u,shortdescription:_,imageurl:w,lastcomment:v,latestcomment:E,isPreview:y,timecreated:i,has_new_comments:f,comments_since_last_visit:p}=t,R=function(){e(r,u)};let P="d-flex learningcompanions_chat-group";return typeof s<"u"&&parseInt(s)===parseInt(r)&&(P+=" learningcompanions_currentgroup"),y&&(P+=" learningcompanions_previewgroup"),g("div",{onClick:R,id:"learningcompanions_chat-group-"+r,className:P,children:[n("img",{className:"learningcompanions_group_image_small",src:w}),g("div",{className:"learningcompanions_group_infos",children:[n("em",{title:o,children:o}),n("br",{}),n("span",{children:v})]}),n(D,{timestamp:E??i}),n("div",{className:"block_learningcompanions_mygroups_group_newposts_count",children:f&&n("span",{className:"block_learningcompanions_mygroups_group_newposts_count_circle",children:p})})]})}function G(){return n("div",{className:"learningcompanions_loading"})}function k(e,t="local_learningcompanions",s=[]){var u;const o=((u=window.M.str[t])==null?void 0:u[e])??`[[${e}_not_found]]`;if(!s.length)return o;const r=/{\$a->(\w*)}/gm,a=/{\$a}/gm;return typeof s=="object"?o.replace(r,(_,w)=>s[w]??_):o.replace(a,s)}const O=".js-chat-preview",C="#fitem_id_message",T="#fitem_id_attachments",B=".fdescription.required";function te(e,t){var o,r;let s=t;e?(s="",(o=document.querySelector(O))==null||o.classList.replace("d-none","d-flex"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.add("d-none"))):((r=document.querySelector(O))==null||r.classList.replace("d-flex","d-none"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=s}function ne(){document.querySelector(".chat-post-form").classList.add("d-none")}function oe({attachment:e}){const{url:t,filename:s}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:s})})}function se({attachments:e=[]}){return e.map(t=>n(oe,{attachment:t}))}function re({id:e}){const t=k("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ae({id:e}){const t=k("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ie({id:e,isratedbyuser:t}){return n("a",{href:"#","data-id":e,title:"Rate",className:`learningcompanions_rate_comment ${t?"learningcompanions_israted_by_current_user":""}`})}function ce({highlighted:e,post:t,isPreview:s,questionid:o}){const{author:r,id:a,timecreated:u,comment:_,attachments:w,flagged:v,timedeleted:E}=t;let y=!1,i=!1,f=o>0&&+r.id!=+window.learningcompanions_chat_userid,p;return typeof window.learningcompanions_chat_userid!==void 0&&+r.id==+window.learningcompanions_chat_userid?(y=!0,p="learningcompanions_chat-my-post"):(i=!0,p="learningcompanions_chat-other-post"),+v&&(p+=" learningcompanions_chat-reported-post"),g("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${p}`,children:[g("strong",{children:[r.firstname," ",r.lastname]}),n("br",{}),n("em",{children:n(D,{timestamp:u,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+E&&n("div",{dangerouslySetInnerHTML:{__html:_}}),!!+E&&n("div",{children:n("i",{children:"Message Deleted"})}),!+E&&!!w.length&&n(se,{attachments:w}),g("div",{className:"action-button-wrapper",children:[!s&&y&&n(re,{id:a}),!s&&i&&!+v&&n(ae,{id:a}),!s&&f&&n(ie,{id:a,isratedbyuser:t.isratedbyuser})]}),e&&g(x,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function le({posts:e,highlightedPostId:t,isInPreviewMode:s,handleWrapperScroll:o,questionid:r,isDummyGroup:a=!1}){if(a){const u=k("not_allowed_to_see_posts");return n("div",{className:"post-wrapper p-3",children:u})}if(typeof e>"u"||!e.length){const u=k("no_posts_available");return n("div",{className:"post-wrapper p-3",children:u})}return n("div",{className:"post-wrapper",onScroll:o,children:e.map(u=>n(ce,{post:u,isPreview:s,highlighted:u.id===t,questionid:r},u.id))})}const h={on(e,t,s={}){return document.addEventListener(e,o=>t(o.detail),s),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send",MESSAGE_RATED:"learningcompanions_message_rated"}};function de({questionid:e}){if(e===void 0)return;const[t,s]=c.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function o(){if(e===null)return;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:r.signal}).then(a=>a.json()).then(a=>{a&&s(a)}),()=>r.abort()}return c.useEffect(o,[e]),g("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}function ue({group:e}){if(e!==void 0)return g("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function me({questionid:e,group:t}){if(e)return n(de,{questionid:e});if(t)return n(ue,{group:t})}function F({activeGroupid:e,group:t,questionid:s}){const[o,r]=c.useState([]),[a,u]=c.useState(0),[_,w]=c.useState(!0),[v,E]=c.useState(null),[y,i]=c.useState(null),f=new URLSearchParams(window.location.search).get("postId"),p=!s&&t?t.isPreviewGroup:!1,R=!s&&t?t.dummyGroup:!1;let P=!1;c.useEffect(()=>{w(!0)},[e]);const H=c.useCallback(({postid:l})=>{r(m=>m.map(d=>(+d.id==+l&&(d.timedeleted=1),d)))},[]),W=c.useCallback(({postid:l})=>{r(m=>m.map(d=>(+d.id==+l&&(d.flagged=!0),d)))},[]),Q=c.useCallback(({postid:l,newvalue:m})=>{r(d=>d.map(S=>(+S.id==+l&&(S.isratedbyuser=m),S)))}),V=c.useCallback(()=>{u(l=>l+1)},[]),_e=c.useCallback(()=>{const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:f,questionid:s}),{signal:l.signal}).then(m=>m.json()).then(m=>{var S,J;const d=m.posts;r(d),w(!1),E(((S=d[0])==null?void 0:S.id)??0),i(((J=d[d.length-1])==null?void 0:J.id)??1/0)}).catch(m=>{m.name}),()=>l.abort()},[e,f]);c.useEffect(()=>(h.on(h.events.MESSAGE_DELETED,H),h.on(h.events.MESSAGE_REPORTED,W),h.on(h.events.MESSAGE_SEND,V),h.on(h.events.MESSAGE_RATED,Q),()=>{h.off(h.events.MESSAGE_DELETED,H),h.off(h.events.MESSAGE_REPORTED,W),h.off(h.events.MESSAGE_SEND,V),h.off(h.events.MESSAGE_RATED,Q)}),[]),c.useEffect(()=>{if(!f)return;const l=document.querySelector(`#learningcompanions_chat-post-${f}`);l&&l.scrollIntoView()},[_]);function we(){if(y===null||P)return;P=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:y,questionid:s}),{signal:l.signal}).then(m=>m.json()).then(m=>{const d=m.posts;d.length&&(r(S=>[...S,...d]),i(d[d.length-1].id))}).catch(m=>{m.name}).finally(()=>{P=!1}),()=>l.abort()}function Ee(){if(v===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${v}&questionid=${s}`,{signal:l.signal}).then(m=>m.json()).then(m=>{const d=m.posts;d&&d.length&&(r(S=>[...d,...S]),E(d[0].id))}),()=>l.abort()}return c.useEffect(_e,[e]),c.useEffect(Ee,[a]),c.useEffect(()=>{const l=window.setInterval(()=>{u(m=>m+1)},1e4);return()=>{window.clearInterval(l)}},[]),g("div",{id:"learningcompanions_chat-postlist",children:[n(me,{group:t,questionid:s}),_&&n(G,{}),!_&&n(le,{posts:o,handleWrapperScroll:l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&we()},isInPreviewMode:p,isDummyGroup:R,highlightedPostId:f,questionid:s})]})}const U=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function fe({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,s]=c.useState([]),[o,r]=c.useState(e),[a,u]=c.useState(!1),[_,w]=c.useState(!0);o===void 0&&t.length&&r(t[0].id),c.useEffect(()=>{const i=t.find(R=>+R.id==+o),f=i==null?void 0:i.chatid,p=!window.learningcompanions_questionid&&i?i.isPreviewGroup:!1;te(p,f)},[o,t]);function v(i){const f=new URLSearchParams(window.location.search);f.set("groupid",i),f.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${f}`),r(i)}c.useEffect(()=>{const i=new URLSearchParams,f=new AbortController;U&&i.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${i}`,{signal:f.signal}).then(p=>p.json()).then(({groups:p})=>{s(p),w(!1),p.length===0&&ne()}).catch(p=>{p.name!=="AbortError"&&console.log("Error: "+p.message)})},[a]),c.useEffect(()=>{const i=window.setInterval(()=>{u(f=>!f)},5e4);return()=>{window.clearInterval(i)}},[]);const E=document.getElementById("learningcompanions_chat-content"),y=t.find(i=>+(i==null?void 0:i.id)==+o);return g(x,{children:[g("div",{id:"learningcompanions_chat-grouplist",children:[_&&n(G,{}),t.map(i=>n(ee,{handleGroupSelect:v,group:i,activeGroupid:o},i.id)),t.length===0&&!_&&n("p",{children:"No groups found"})]}),A.createPortal(n(F,{activeGroupid:o,group:y}),E)]})}function pe(){L.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(fe,{activeGroupid:window.learningcompanions_groupid})}))}function he(){const e=L.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(F,{questionid:t})}))}const ge={startChat:pe,startQuestionChat:he};window.Chat=ge})(React,ReactDOM);
