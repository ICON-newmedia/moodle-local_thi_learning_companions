(function(s,k){"use strict";var O={exports:{}},E={};var x=s,D=Symbol.for("react.element"),C=Symbol.for("react.fragment"),$=Object.prototype.hasOwnProperty,B=x.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,F={key:!0,ref:!0,__self:!0,__source:!0};function G(e,t,a){var c,l={},i=null,u=null;a!==void 0&&(i=""+a),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(u=t.ref);for(c in t)$.call(t,c)&&!F.hasOwnProperty(c)&&(l[c]=t[c]);if(e&&e.defaultProps)for(c in t=e.defaultProps,t)l[c]===void 0&&(l[c]=t[c]);return{$$typeof:D,type:e,key:i,ref:u,props:l,_owner:B.current}}E.Fragment=C,E.jsx=G,E.jsxs=G,function(e){e.exports=E}(O);const n=O.exports.jsx,m=O.exports.jsxs;var S={},L=k;S.createRoot=L.createRoot,S.hydrateRoot=L.hydrateRoot;function T({timestamp:e}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time"});const t=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(date);return console.log("lastActive: ",t),n("div",{className:"learningcompanions_chat_time",children:t})}function H({handleGroupSelect:e,name:t,id:a,description:c,chatid:l,shortdescription:i,imageurl:u,latestcomment:g,activeGroupid:f}){const p=function(){e(a,l)};let y="learningcompanions_chat-group";return typeof f<"u"&&parseInt(f)===parseInt(a)&&(y+=" learningcompanions_currentgroup"),m("div",{onClick:p,id:"learningcompanions_chat-group-"+a,className:y,children:[n(T,{timestamp:g}),n("img",{className:"learningcompanions_group_image_small",src:u,alt:`Group picture for group ${t}`}),n("em",{children:t}),n("br",{}),n("span",{children:i}),n("br",{})]})}function N({loading:e}){return e?n("div",{className:"learningcompanions_loading"}):null}const _={on(e,t){document.addEventListener(e,a=>t(a.detail))},dispatch(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))},remove(e,t){document.removeEventListener(e,t)},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted"}};function U(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,a]=s.useState([]),[c,l]=s.useState(e.activeGroupid),[i,u]=s.useState(0),[g,f]=s.useState(!0);function p(d,w){_.dispatch(_.events.GROUP_CHANGED,{groupid:d}),l(d),document.querySelector('input[name="chatid"]').value=w,console.log(`setting active group id to: ${d} and chatid to: ${w}`)}function y(){const d=new AbortController;async function w(){const I=await(await fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php")).json();a(I.groups),f(!1)}return w(),()=>d.abort()}return s.useEffect(y,[c,i]),s.useEffect(()=>{const d=window.setInterval(()=>{u(w=>w+1)},5e4);return()=>{window.clearInterval(d)}},[]),m("div",{id:"learningcompanions_chat-grouplist",children:[g&&n(N,{}),t.map(d=>n(H,{handleGroupSelect:p,name:d.name,chatid:d.chatid,id:d.id,shortdescription:d.shortdescription,description:d.description,imageurl:d.imageurl,latestcomment:d.latestcomment,activeGroupid:c},d.id))]})}function R(e){return n("div",{children:n("a",{target:"_blank",href:e.attachment.url,children:e.attachment.filename})})}function q({attachments:e}){if(!(!e||e.length===0))return e.map(t=>n(R,{attachment:t}))}function W({id:e}){return n("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function J({id:e}){return n("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function K({author:e,id:t,datetime:a,comment:c,attachments:l,reported:i}){let u;l&&l.length?u=n(q,{attachments:l}):u="";let g=!1,f=!1,p;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(g=!0,p="learningcompanions_chat-my-post"):(f=!0,p="learningcompanions_chat-other-post"),m("div",{id:"learningcompanions_chat-post-"+t,className:"learningcompanions_chat-post "+p,children:[m("strong",{children:[e.firstname," ",e.lastname]}),n("br",{}),n("em",{children:a}),n("br",{}),n("div",{dangerouslySetInnerHTML:{__html:c}}),m("span",{children:["ID: ",t]}),m("span",{children:["Flagged: ",i]}),u,m("div",{className:"action-button-wrapper",children:[g&&n(W,{id:t}),f&&!i&&n(J,{id:t})]})]})}function Y({group:e}){return m("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function z(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,a]=s.useState([]),[c,l]=s.useState({}),[i,u]=s.useState(1),[g,f]=s.useState(0),[p,y]=s.useState(e.activeGroupid),[d,w]=s.useState(0),[j,I]=s.useState(!0),[b,A]=s.useState(null);let P=!1;_.on(_.events.GROUP_CHANGED,o=>{y(o.groupid),u(1),f(0)}),_.on(_.events.MESSAGE_DELETED,({postid:o})=>{a(t.filter(r=>r.id!==o))});function X(){if(i===1){u(i+1);return}if(P)return;P=!0;const o=new AbortController;return console.log({page:i,postsOffset:g}),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:p,page:i,offset:g}),{signal:o.signal}).then(r=>r.json()).then(r=>{const h=Object.values(r.posts).reverse();console.log(r),a(v=>[...v,...h]),u(i+1)}).catch(r=>{r.name==="AbortError"?console.log("Fetch aborted"):console.log(r)}).finally(()=>{P=!1}),()=>o.abort()}const Z=()=>{const o=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?groupid="+p,{signal:o.signal}).then(r=>r.json()).then(r=>{var v;const h=Object.values(r.posts).reverse();a(h),l(r.group),I(!1),A(((v=h[0])==null?void 0:v.id)??0),console.log("Last post id: "+b)}).catch(r=>{r.name==="AbortError"?console.log("Fetch aborted"):console.log(r)}),()=>o.abort()},ee=()=>{if(b===null)return;console.log("Getting new posts with lastPostId: "+b);const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${p}&lastPostId=${b}`,{signal:o.signal}).then(r=>r.json()).then(r=>{console.log("New Posts:",r);const h=Object.values(r.posts).reverse();h.length&&(f(v=>v+h.length),a(v=>[...h,...v]),A(h[0].id))}),()=>o.abort()};return s.useEffect(Z,[p]),s.useEffect(ee,[d]),s.useEffect(()=>{const o=window.setInterval(()=>{w(r=>r+1)},3e4);return()=>{window.clearInterval(o)}},[]),m("div",{id:"learningcompanions_chat-postlist",children:[j&&n(N,{}),n(Y,{group:c}),n("div",{className:"post-wrapper",onScroll:o=>{-o.target.scrollTop+o.target.clientHeight>=o.target.scrollHeight&&X()},children:t.map(o=>n(K,{author:o.author,id:o.id,datetime:o.datetime,comment:o.comment,attachments:o.attachments,reported:+o.flagged},o.id))})]})}const Q=S.createRoot(document.getElementById("learningcompanions_groups-content")),V=S.createRoot(document.getElementById("learningcompanions_chat-content"));Q.render(n(s.StrictMode,{children:n(U,{activeGroupid:window.learningcompanions_groupid})})),V.render(n(s.StrictMode,{children:n(z,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
