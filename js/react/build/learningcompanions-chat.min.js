(function(i,x){"use strict";var S={exports:{}},y={};var j=i,T=Symbol.for("react.element"),F=Symbol.for("react.fragment"),H=Object.prototype.hasOwnProperty,U=j.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,B={key:!0,ref:!0,__self:!0,__source:!0};function G(e,n,s){var a,u={},d=null,f=null;s!==void 0&&(d=""+s),n.key!==void 0&&(d=""+n.key),n.ref!==void 0&&(f=n.ref);for(a in n)H.call(n,a)&&!B.hasOwnProperty(a)&&(u[a]=n[a]);if(e&&e.defaultProps)for(a in n=e.defaultProps,n)u[a]===void 0&&(u[a]=n[a]);return{$$typeof:T,type:e,key:d,ref:f,props:u,_owner:U.current}}y.Fragment=F,y.jsx=G,y.jsxs=G,function(e){e.exports=y}(S);const W=S.exports.Fragment,t=S.exports.jsx,g=S.exports.jsxs;var I={},b=x;I.createRoot=b.createRoot,I.hydrateRoot=b.hydrateRoot;function J({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const s=new Date(e*1e3),a=new Intl.DateTimeFormat(void 0,n).format(s);return t("div",{className:"learningcompanions_chat_time",children:a})}function K({handleGroupSelect:e,name:n,id:s,description:a,chatid:u,shortdescription:d,imageurl:f,latestcomment:v,activeGroupid:_}){const w=function(){e(s,u)};let h="learningcompanions_chat-group";return typeof _<"u"&&parseInt(_)===parseInt(s)&&(h+=" learningcompanions_currentgroup"),g("div",{onClick:w,id:"learningcompanions_chat-group-"+s,className:h,children:[t(J,{timestamp:v}),t("img",{className:"learningcompanions_group_image_small",src:f}),t("em",{children:n}),t("br",{}),t("span",{children:d}),t("br",{})]})}function O({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const p={on(e,n,s={}){return document.addEventListener(e,a=>n(a.detail),s),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}};function V(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=i.useState([]),[a,u]=i.useState(e.activeGroupid),[d,f]=i.useState(0),[v,_]=i.useState(!0);function w(l,m){p.dispatch(p.events.GROUP_CHANGED,{groupid:l}),u(l),document.querySelector('input[name="chatid"]').value=m,console.log(`setting active group id to: ${l} and chatid to: ${m}`)}function h(){const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php",{signal:l.signal}).then(m=>m.json()).then(({groups:m})=>{s(m),_(!1)}).catch(m=>{m.name!=="AbortError"&&console.log("Error: "+m.message)}),()=>l.abort()}return i.useEffect(h,[a,d]),i.useEffect(()=>{const l=window.setInterval(()=>{f(m=>m+1)},5e4);return()=>{window.clearInterval(l)}},[]),g("div",{id:"learningcompanions_chat-grouplist",children:[v&&t(O,{}),n.map(l=>t(K,{handleGroupSelect:w,name:l.name,chatid:l.chatid,id:l.id,shortdescription:l.shortdescription,description:l.description,imageurl:l.imageurl,latestcomment:l.latestcomment,activeGroupid:a},l.id))]})}function Y({attachment:e}){const{url:n,filename:s}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:s})})}function z({attachments:e=[]}){return e.map(n=>t(Y,{attachment:n}))}function Q({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function X({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function Z({author:e,id:n,datetime:s,comment:a,attachments:u,reported:d,deleted:f,highlighted:v}){let _=!1,w=!1,h;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(_=!0,h="learningcompanions_chat-my-post"):(w=!0,h="learningcompanions_chat-other-post"),d&&(h+=" learningcompanions_chat-reported-post"),g("div",{id:`learningcompanions_chat-post-${n}`,className:`learningcompanions_chat-post ${h}`,children:[g("strong",{children:[e.firstname," ",e.lastname]}),t("br",{}),t("em",{children:s}),t("br",{}),!f&&t("div",{dangerouslySetInnerHTML:{__html:a}}),f&&t("div",{children:t("i",{children:"Message Deleted"})}),!!u.length&&t(z,{attachments:u}),g("div",{className:"action-button-wrapper",children:[_&&t(Q,{id:n}),w&&!d&&t(X,{id:n})]}),g("span",{children:["ID: ",n]}),v&&g(W,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function q({group:e}){return g("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function $(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=i.useState([]),[a,u]=i.useState({}),[d,f]=i.useState(e.activeGroupid),[v,_]=i.useState(0),[w,h]=i.useState(!0),[l,m]=i.useState(null),[L,N]=i.useState(null);let R=!1;const P=new URLSearchParams(window.location.search).get("postId"),D=i.useCallback(o=>{f(o.groupid)},[]),A=i.useCallback(({postid:o})=>{s(r=>r.map(c=>(+c.id==+o&&(c.timedeleted=1),c)))},[]),k=i.useCallback(({postid:o})=>{s(r=>r.map(c=>(+c.id==+o&&(c.flagged=!0),c)))},[]);i.useEffect(()=>(p.on(p.events.GROUP_CHANGED,D),p.on(p.events.MESSAGE_DELETED,A),p.on(p.events.MESSAGE_REPORTED,k),()=>{p.off(p.events.GROUP_CHANGED,D),p.off(p.events.MESSAGE_DELETED,A),p.off(p.events.MESSAGE_REPORTED,k)}),[]),i.useEffect(()=>{if(!P)return;const o=document.querySelector(`#learningcompanions_chat-post-${P}`);console.log("Found element:",o),o&&o.scrollIntoView()},[w]);function ne(){if(L===null||R)return;R=!0;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:d,firstPostId:L}),{signal:o.signal}).then(r=>r.json()).then(r=>{const c=r.posts;c.length&&(s(E=>[...E,...c]),N(c[c.length-1].id))}).catch(r=>{r.name!=="AbortError"&&console.log(r)}).finally(()=>{R=!1}),()=>o.abort()}function oe(){const o=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:d,includedPostId:P}),{signal:o.signal}).then(r=>r.json()).then(r=>{var E,C;const c=r.posts;s(c),u(r.group),h(!1),m(((E=c[0])==null?void 0:E.id)??0),N(((C=c[c.length-1])==null?void 0:C.id)??1/0)}).catch(r=>{r.name!=="AbortError"&&console.log(r)}),()=>o.abort()}function re(){if(l===null)return;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${d}&lastPostId=${l}`,{signal:o.signal}).then(r=>r.json()).then(r=>{const c=r.posts;c.length&&(s(E=>[...c,...E]),m(c[0].id))}),()=>o.abort()}return i.useEffect(oe,[d]),i.useEffect(re,[v]),i.useEffect(()=>{const o=window.setInterval(()=>{_(r=>r+1)},3e4);return()=>{window.clearInterval(o)}},[]),g("div",{id:"learningcompanions_chat-postlist",children:[w&&t(O,{}),t(q,{group:a}),t("div",{className:"post-wrapper",onScroll:o=>{-o.target.scrollTop+o.target.clientHeight>=o.target.scrollHeight&&ne()},children:n.map(o=>t(Z,{author:o.author,id:o.id,datetime:o.datetime,comment:o.comment,attachments:o.attachments,reported:!!+o.flagged,deleted:!!+o.timedeleted,highlighted:o.id===P},o.id))})]})}const ee=I.createRoot(document.getElementById("learningcompanions_groups-content")),te=I.createRoot(document.getElementById("learningcompanions_chat-content"));ee.render(t(React.StrictMode,{children:t(V,{activeGroupid:window.learningcompanions_groupid})})),te.render(t(React.StrictMode,{children:t($,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
