(function(i,k){"use strict";var O={exports:{}},S={};var j=i,C=Symbol.for("react.element"),x=Symbol.for("react.fragment"),T=Object.prototype.hasOwnProperty,B=j.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,H={key:!0,ref:!0,__self:!0,__source:!0};function G(e,n,s){var a,d={},l=null,f=null;s!==void 0&&(l=""+s),n.key!==void 0&&(l=""+n.key),n.ref!==void 0&&(f=n.ref);for(a in n)T.call(n,a)&&!H.hasOwnProperty(a)&&(d[a]=n[a]);if(e&&e.defaultProps)for(a in n=e.defaultProps,n)d[a]===void 0&&(d[a]=n[a]);return{$$typeof:C,type:e,key:l,ref:f,props:d,_owner:B.current}}S.Fragment=x,S.jsx=G,S.jsxs=G,function(e){e.exports=S}(O);const t=O.exports.jsx,_=O.exports.jsxs;var y={},P=k;y.createRoot=P.createRoot,y.hydrateRoot=P.hydrateRoot;function U({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const s=new Date(e*1e3),a=new Intl.DateTimeFormat(void 0,n).format(s);return t("div",{className:"learningcompanions_chat_time",children:a})}function F({handleGroupSelect:e,name:n,id:s,description:a,chatid:d,shortdescription:l,imageurl:f,latestcomment:v,activeGroupid:h}){const m=function(){e(s,d)};let E="learningcompanions_chat-group";return typeof h<"u"&&parseInt(h)===parseInt(s)&&(E+=" learningcompanions_currentgroup"),_("div",{onClick:m,id:"learningcompanions_chat-group-"+s,className:E,children:[t(U,{timestamp:v}),t("img",{className:"learningcompanions_group_image_small",src:f}),t("em",{children:n}),t("br",{}),t("span",{children:l}),t("br",{})]})}function b({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const p={on(e,n,s={}){return document.addEventListener(e,a=>n(a.detail),s),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}};function W(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=i.useState([]),[a,d]=i.useState(e.activeGroupid),[l,f]=i.useState(0),[v,h]=i.useState(!0);function m(c,g){p.dispatch(p.events.GROUP_CHANGED,{groupid:c}),d(c),document.querySelector('input[name="chatid"]').value=g,console.log(`setting active group id to: ${c} and chatid to: ${g}`)}function E(){const c=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php",{signal:c.signal}).then(g=>g.json()).then(({groups:g})=>{s(g),h(!1)}).catch(g=>{g.name!=="AbortError"&&console.log("Error: "+g.message)}),()=>c.abort()}return i.useEffect(E,[a,l]),i.useEffect(()=>{const c=window.setInterval(()=>{f(g=>g+1)},5e4);return()=>{window.clearInterval(c)}},[]),_("div",{id:"learningcompanions_chat-grouplist",children:[v&&t(b,{}),n.map(c=>t(F,{handleGroupSelect:m,name:c.name,chatid:c.chatid,id:c.id,shortdescription:c.shortdescription,description:c.description,imageurl:c.imageurl,latestcomment:c.latestcomment,activeGroupid:a},c.id))]})}function J({attachment:e}){const{url:n,filename:s}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:s})})}function K({attachments:e=[]}){return e.map(n=>t(J,{attachment:n}))}function Y({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function z({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function Q({author:e,id:n,datetime:s,comment:a,attachments:d,reported:l,deleted:f}){let v=!1,h=!1,m;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(v=!0,m="learningcompanions_chat-my-post"):(h=!0,m="learningcompanions_chat-other-post"),l&&(m+=" learningcompanions_chat-reported-post"),_("div",{id:"learningcompanions_chat-post-"+n,className:"learningcompanions_chat-post "+m,children:[_("strong",{children:[e.firstname," ",e.lastname]}),t("br",{}),t("em",{children:s}),t("br",{}),!f&&t("div",{dangerouslySetInnerHTML:{__html:a}}),f&&t("div",{children:t("i",{children:"Message Deleted"})}),!!d.length&&t(K,{attachments:d}),_("div",{className:"action-button-wrapper",children:[v&&t(Y,{id:n}),h&&!l&&t(z,{id:n})]}),_("span",{children:["ID: ",n]})]})}function V({group:e}){return _("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function X(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,s]=i.useState([]),[a,d]=i.useState({}),[l,f]=i.useState(1),[v,h]=i.useState(0),[m,E]=i.useState(e.activeGroupid),[c,g]=i.useState(0),[$,ee]=i.useState(!0),[I,D]=i.useState(null);let R=!1;const N=i.useCallback(o=>{E(o.groupid),f(1),h(0)},[]),A=i.useCallback(({postid:o})=>{s(r=>r.map(u=>(+u.id==+o&&(u.timedeleted=1),u)))},[]),L=i.useCallback(({postid:o})=>{s(r=>r.map(u=>(+u.id==+o&&(u.flagged=!0),u)))},[]);i.useEffect(()=>(p.on(p.events.GROUP_CHANGED,N),p.on(p.events.MESSAGE_DELETED,A),p.on(p.events.MESSAGE_REPORTED,L),()=>{p.off(p.events.GROUP_CHANGED,N),p.off(p.events.MESSAGE_DELETED,A),p.off(p.events.MESSAGE_REPORTED,L)}),[]);function te(){if(l===1){f(l+1);return}if(R)return;R=!0;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:m,page:l,offset:v}),{signal:o.signal}).then(r=>r.json()).then(r=>{const u=Object.values(r.posts).reverse();s(w=>[...w,...u]),f(l+1)}).catch(r=>{r.name!=="AbortError"&&console.log(r)}).finally(()=>{R=!1}),()=>o.abort()}const ne=()=>{const o=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?groupid="+m,{signal:o.signal}).then(r=>r.json()).then(r=>{var w;const u=Object.values(r.posts).reverse();s(u),d(r.group),ee(!1),D(((w=u[0])==null?void 0:w.id)??0)}).catch(r=>{r.name!=="AbortError"&&console.log(r)}),()=>o.abort()},oe=()=>{if(I===null)return;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${m}&lastPostId=${I}`,{signal:o.signal}).then(r=>r.json()).then(r=>{const u=Object.values(r.posts).reverse();u.length&&(h(w=>w+u.length),s(w=>[...u,...w]),D(u[0].id))}),()=>o.abort()};return i.useEffect(ne,[m]),i.useEffect(oe,[c]),i.useEffect(()=>{const o=window.setInterval(()=>{g(r=>r+1)},3e4);return()=>{window.clearInterval(o)}},[]),_("div",{id:"learningcompanions_chat-postlist",children:[$&&t(b,{}),t(V,{group:a}),t("div",{className:"post-wrapper",onScroll:o=>{-o.target.scrollTop+o.target.clientHeight>=o.target.scrollHeight&&te()},children:n.map(o=>t(Q,{author:o.author,id:o.id,datetime:o.datetime,comment:o.comment,attachments:o.attachments,reported:!!+o.flagged,deleted:!!+o.timedeleted},o.id))})]})}const Z=y.createRoot(document.getElementById("learningcompanions_groups-content")),q=y.createRoot(document.getElementById("learningcompanions_chat-content"));Z.render(t(React.StrictMode,{children:t(W,{activeGroupid:window.learningcompanions_groupid})})),q.render(t(React.StrictMode,{children:t(X,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
