(function(l,J){"use strict";var b={exports:{}},N={};var K=l,Y=Symbol.for("react.element"),z=Symbol.for("react.fragment"),Q=Object.prototype.hasOwnProperty,X=K.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Z={key:!0,ref:!0,__self:!0,__source:!0};function A(e,n,c){var o,r={},f=null,m=null;c!==void 0&&(f=""+c),n.key!==void 0&&(f=""+n.key),n.ref!==void 0&&(m=n.ref);for(o in n)Q.call(n,o)&&!Z.hasOwnProperty(o)&&(r[o]=n[o]);if(e&&e.defaultProps)for(o in n=e.defaultProps,n)r[o]===void 0&&(r[o]=n[o]);return{$$typeof:Y,type:e,key:f,ref:m,props:r,_owner:X.current}}N.Fragment=z,N.jsx=A,N.jsxs=A,function(e){e.exports=N}(b);const q=b.exports.Fragment,t=b.exports.jsx,v=b.exports.jsxs;var O={},D=J;O.createRoot=D.createRoot,O.hydrateRoot=D.hydrateRoot;function k({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const c=new Date(e*1e3),o=new Intl.DateTimeFormat(void 0,n).format(c);return t("div",{className:"learningcompanions_chat_time",children:o})}function $({handleGroupSelect:e,group:n,activeGroupid:c}){const{name:o,id:r,description:f,chatid:m,shortdescription:S,imageurl:P,latestcomment:E,isPreview:_}=n,y=function(){e(r,m)};let s="d-flex learningcompanions_chat-group";return typeof c<"u"&&parseInt(c)===parseInt(r)&&(s+=" learningcompanions_currentgroup"),_&&(s+=" learningcompanions_previewgroup"),v("div",{onClick:y,id:"learningcompanions_chat-group-"+r,className:s,children:[t("img",{className:"learningcompanions_group_image_small",src:P}),v("div",{className:"learningcompanions_group_infos",children:[t("em",{children:o}),t("br",{}),t("span",{children:S})]}),t(k,{timestamp:E})]})}function x(){return t("div",{className:"learningcompanions_loading"})}const u={on(e,n,c={}){return document.addEventListener(e,o=>n(o.detail),c),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}},C=".js-chat-preview",j="#fitem_id_message",T="#fitem_id_attachments",U=".fdescription.required";function ee({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[c,o]=l.useState([]),[r,f]=l.useState(e),[m,S]=l.useState(0),[P,E]=l.useState(!0);l.useEffect(()=>{var p,G,L,I;const s=(p=c.find(w=>+w.id==+r))==null?void 0:p.chatid,g=((G=c.find(w=>+w.id==+r))==null?void 0:G.isPreviewGroup)??!1;let h=s;g?(console.log("I make the input invisible"),h="",(L=document.querySelector(C))==null||L.classList.replace("d-none","d-flex"),document.querySelectorAll(`${j}, ${T}, ${U}`).forEach(w=>w.classList.add("d-none"))):(console.log("I make the input Visible"),(I=document.querySelector(C))==null||I.classList.replace("d-flex","d-none"),document.querySelectorAll(`${j}, ${T}, ${U}`).forEach(w=>w.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=h,console.log(`setting active group id to: ${r} and chatid to: ${s}`)},[r,c]);function _(s){var p;const g=((p=c.find(G=>+G.id==+s))==null?void 0:p.isPreviewGroup)??!1;u.dispatch(u.events.GROUP_CHANGED,{groupid:s,isPreviewGroup:g});const h=new URLSearchParams(window.location.search);h.set("groupid",s),h.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${h}`),f(s)}function y(){const s=new AbortController,g=new URLSearchParams(window.location.search).get("previewGroup"),h=new URLSearchParams;return g&&h.set("previewGroup",g),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${h}`,{signal:s.signal}).then(p=>p.json()).then(({groups:p})=>{o(p),E(!1)}).catch(p=>{p.name!=="AbortError"&&console.log("Error: "+p.message)}),()=>s.abort()}return l.useEffect(y,[m]),l.useEffect(()=>{const s=window.setInterval(()=>{S(g=>g+1)},5e4);return()=>{window.clearInterval(s)}},[]),v("div",{id:"learningcompanions_chat-grouplist",children:[P&&t(x,{}),c.map(s=>t($,{handleGroupSelect:_,group:s,activeGroupid:r},s.id))]})}function te({attachment:e}){const{url:n,filename:c}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:c})})}function ne({attachments:e=[]}){return e.map(n=>t(te,{attachment:n}))}function oe({id:e}){return t("a",{href:"#","data-id":e,title:"[[Delete]]",className:"learningcompanions_delete_comment"})}function re({id:e}){return t("a",{href:"#","data-id":e,title:"[[Report]]",className:"learningcompanions_report_comment"})}function se({highlighted:e,post:n,isPreview:c}){const{author:o,id:r,timecreated:f,comment:m,attachments:S,flagged:P,timedeleted:E}=n;let _=!1,y=!1,s;return typeof window.learningcompanions_chat_userid!==void 0&&+o.id==+window.learningcompanions_chat_userid?(_=!0,s="learningcompanions_chat-my-post"):(y=!0,s="learningcompanions_chat-other-post"),+P&&(s+=" learningcompanions_chat-reported-post"),v("div",{id:`learningcompanions_chat-post-${r}`,className:`learningcompanions_chat-post ${s}`,children:[v("strong",{children:[o.firstname," ",o.lastname]}),t("br",{}),t("em",{children:t(k,{timestamp:f,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),t("br",{}),!+E&&t("div",{dangerouslySetInnerHTML:{__html:m}}),!!+E&&t("div",{children:t("i",{children:"Message Deleted"})}),!+E&&!!S.length&&t(ne,{attachments:S}),v("div",{className:"action-button-wrapper",children:[!c&&_&&t(oe,{id:r}),!c&&y&&!+P&&t(re,{id:r})]}),v("span",{children:["ID: ",r]}),e&&v(q,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ie({posts:e,highlightedPostId:n,isInPreviewMode:c,handleWrapperScroll:o}){return e.length?t("div",{className:"post-wrapper",onScroll:o,children:e.map(r=>t(se,{post:r,isPreview:c,highlighted:r.id===n},r.id))}):t("div",{className:"post-wrapper p-3",children:"[[No Posts available]]"})}function ae({group:e}){return v("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function ce({activeGroupid:e,previewGroup:n}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[c,o]=l.useState([]),[r,f]=l.useState({}),[m,S]=l.useState(e),[P,E]=l.useState(0),[_,y]=l.useState(!0),[s,g]=l.useState(null),[h,p]=l.useState(null),[G,L]=l.useState(!1),I=new URLSearchParams(window.location.search).get("postId");let w=!1;const F=l.useCallback(i=>{console.log("Data",i),S(i.groupid),L(i.isPreviewGroup)},[]),B=l.useCallback(({postid:i})=>{o(a=>a.map(d=>(+d.id==+i&&(d.timedeleted=1),d)))},[]),V=l.useCallback(({postid:i})=>{o(a=>a.map(d=>(+d.id==+i&&(d.flagged=!0),d)))},[]);l.useEffect(()=>(u.on(u.events.GROUP_CHANGED,F),u.on(u.events.MESSAGE_DELETED,B),u.on(u.events.MESSAGE_REPORTED,V),()=>{u.off(u.events.GROUP_CHANGED,F),u.off(u.events.MESSAGE_DELETED,B),u.off(u.events.MESSAGE_REPORTED,V)}),[]),l.useEffect(()=>{if(!I)return;const i=document.querySelector(`#learningcompanions_chat-post-${I}`);console.log("Found element:",i),i&&i.scrollIntoView()},[_]);function pe(){if(h===null||w)return;w=!0;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:m,firstPostId:h}),{signal:i.signal}).then(a=>a.json()).then(a=>{const d=a.posts;d.length&&(o(R=>[...R,...d]),p(d[d.length-1].id))}).catch(a=>{a.name!=="AbortError"&&console.log(a)}).finally(()=>{w=!1}),()=>i.abort()}function ue(){const i=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:m,includedPostId:I,previewGroup:n}),{signal:i.signal}).then(a=>a.json()).then(a=>{var R,W;const d=a.posts;o(d),console.log("Group",a.group),f(a.group),y(!1),L(a.group.isPreviewGroup),g(((R=d[0])==null?void 0:R.id)??0),p(((W=d[d.length-1])==null?void 0:W.id)??1/0)}).catch(a=>{a.name!=="AbortError"&&console.log(a)}),()=>i.abort()}function me(){if(s===null)return;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${m}&lastPostId=${s}`,{signal:i.signal}).then(a=>a.json()).then(a=>{const d=a.posts;d.length&&(o(R=>[...d,...R]),g(d[0].id))}),()=>i.abort()}return l.useEffect(ue,[m]),l.useEffect(me,[P]),l.useEffect(()=>{const i=window.setInterval(()=>{E(a=>a+1)},3e4);return()=>{window.clearInterval(i)}},[]),v("div",{id:"learningcompanions_chat-postlist",children:[t(ae,{group:r}),_&&t(x,{}),G&&t("span",{children:"Is Preview"}),!_&&t(ie,{posts:c,handleWrapperScroll:i=>{-i.target.scrollTop+i.target.clientHeight>=i.target.scrollHeight&&pe()},isInPreviewMode:G,highlightedPostId:I})]})}const le=O.createRoot(document.getElementById("learningcompanions_groups-content")),de=O.createRoot(document.getElementById("learningcompanions_chat-content")),H=new URLSearchParams(window.location.search).get("previewGroup");le.render(t(React.StrictMode,{children:t(ee,{previewGroup:H,activeGroupid:window.learningcompanions_groupid})})),de.render(t(React.StrictMode,{children:t(ce,{previewGroup:H,activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
