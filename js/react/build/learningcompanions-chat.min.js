(function(c,N){"use strict";var R={},K={get exports(){return R},set exports(e){R=e}},b={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y=c,z=Symbol.for("react.element"),X=Symbol.for("react.fragment"),Z=Object.prototype.hasOwnProperty,q=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$={key:!0,ref:!0,__self:!0,__source:!0};function k(e,t,o){var s,r={},a=null,u=null;o!==void 0&&(a=""+o),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(u=t.ref);for(s in t)Z.call(t,s)&&!$.hasOwnProperty(s)&&(r[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps,t)r[s]===void 0&&(r[s]=t[s]);return{$$typeof:z,type:e,key:a,ref:u,props:r,_owner:q.current}}b.Fragment=X,b.jsx=k,b.jsxs=k,function(e){e.exports=b}(K);const x=R.Fragment,n=R.jsx,w=R.jsxs;var L={},D=N;L.createRoot=D.createRoot,L.hydrateRoot=D.hydrateRoot;function j({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"-"});const o=new Date(e*1e3),s=new Intl.DateTimeFormat(void 0,t).format(o);return n("div",{className:"learningcompanions_chat_time",children:s})}function ee({handleGroupSelect:e,group:t,activeGroupid:o}){const{name:s,id:r,description:a,chatid:u,shortdescription:E,imageurl:v,lastcomment:y,latestcomment:g,isPreview:P,timecreated:i,has_new_comments:h,comments_since_last_visit:f}=t,_=function(){e(r,u)};let I="d-flex learningcompanions_chat-group";return typeof o<"u"&&parseInt(o)===parseInt(r)&&(I+=" learningcompanions_currentgroup"),P&&(I+=" learningcompanions_previewgroup"),w("div",{onClick:_,id:"learningcompanions_chat-group-"+r,className:I,children:[n("img",{className:"learningcompanions_group_image_small",src:v}),w("div",{className:"learningcompanions_group_infos",children:[n("em",{title:s,children:s}),n("br",{}),n("span",{children:y})]}),n(j,{timestamp:g??i}),n("div",{className:"learningcompanions_mygroups_group_newposts_count",children:h&&n("span",{className:"learningcompanions_mygroups_group_newposts_count_circle",children:f})})]})}function G(){return n("div",{className:"learningcompanions_loading"})}function A(e,t="local_learningcompanions",o=[]){var u;const s=((u=window.M.str[t])==null?void 0:u[e])??`[[${e}_not_found]]`;if(!o.length)return s;const r=/{\$a->(\w*)}/gm,a=/{\$a}/gm;return typeof o=="object"?s.replace(r,(E,v)=>o[v]??E):s.replace(a,o)}const O=".js-chat-preview",C="#fitem_id_message",T="#fitem_id_attachments",B=".fdescription.required";function te(e,t){var s,r;let o=t;e?(o="",(s=document.querySelector(O))==null||s.classList.replace("d-none","d-flex"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.add("d-none"))):((r=document.querySelector(O))==null||r.classList.replace("d-flex","d-none"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=o}function ne(){document.querySelector(".chat-post-form").classList.add("d-none")}function oe({attachment:e}){const{url:t,filename:o}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:o})})}function se({attachments:e=[]}){return e.map(t=>n(oe,{attachment:t}))}function re({id:e}){const t=A("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ae({id:e}){const t=A("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ie({id:e,isratedbyuser:t}){return n("a",{href:"#","data-id":e,title:"Rate",className:`learningcompanions_rate_comment ${t?"learningcompanions_israted_by_current_user":""}`})}function ce({highlighted:e,post:t,isPreview:o,questionid:s}){const{author:r,id:a,timecreated:u,comment:E,attachments:v,flagged:y,timedeleted:g}=t;let P=!1,i=!1,h=s>0&&+r.id!=+window.learningcompanions_chat_userid,f,_=!(typeof g>"u"||g===null||g===0);return typeof window.learningcompanions_chat_userid!==void 0&&+r.id==+window.learningcompanions_chat_userid&&!_?(P=!0,f="learningcompanions_chat-my-post"):_||(i=!0,f="learningcompanions_chat-other-post"),+y&&(f+=" learningcompanions_chat-reported-post"),w("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${f}`,children:[w("strong",{children:[r.firstname," ",r.lastname]}),n("br",{}),n("em",{children:n(j,{timestamp:u,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+g&&n("div",{dangerouslySetInnerHTML:{__html:E}}),!!+g&&n("div",{children:n("i",{children:"Message Deleted"})}),!+g&&!!v.length&&n(se,{attachments:v}),w("div",{className:"action-button-wrapper",children:[!o&&P&&n(re,{id:a}),!o&&i&&!+y&&n(ae,{id:a}),!o&&h&&n(ie,{id:a,isratedbyuser:t.isratedbyuser})]}),e&&w(x,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function le({posts:e,highlightedPostId:t,isInPreviewMode:o,handleWrapperScroll:s,questionid:r,isDummyGroup:a=!1}){if(a){const u=A("not_allowed_to_see_posts");return n("div",{className:"post-wrapper p-3",children:u})}if(typeof e>"u"||!e.length){const u=A("no_posts_available");return n("div",{className:"post-wrapper p-3",children:u})}return n("div",{className:"post-wrapper",onScroll:s,children:e.map(u=>n(ce,{post:u,isPreview:o,highlighted:u.id===t,questionid:r},u.id))})}const p={on(e,t,o={}){return document.addEventListener(e,s=>t(s.detail),o),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send",MESSAGE_RATED:"learningcompanions_message_rated"}};function de({questionid:e}){if(e===void 0)return;const[t,o]=c.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function s(){if(e===null)return;const r=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:r.signal}).then(a=>a.json()).then(a=>{a&&o(a)}),()=>r.abort()}return c.useEffect(s,[e]),w("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}function ue({group:e}){if(e!==void 0)return w("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function me({questionid:e,group:t}){if(e)return n(de,{questionid:e});if(t)return n(ue,{group:t})}function F({activeGroupid:e,group:t,questionid:o}){const[s,r]=c.useState([]),[a,u]=c.useState(0),[E,v]=c.useState(!0),[y,g]=c.useState(null),[P,i]=c.useState(null),h=new URLSearchParams(window.location.search).get("postId"),f=!o&&t?t.isPreviewGroup:!1,_=!o&&t?t.dummyGroup:!1;let I=!1;c.useEffect(()=>{v(!0)},[e]);const H=c.useCallback(({postid:l})=>{r(m=>m.map(d=>(+d.id==+l&&(d.timedeleted=1),d)))},[]),W=c.useCallback(({postid:l})=>{r(m=>m.map(d=>(+d.id==+l&&(d.flagged=!0),d)))},[]),Q=c.useCallback(({postid:l,newvalue:m})=>{r(d=>d.map(S=>(+S.id==+l&&(S.isratedbyuser=m),S)))}),V=c.useCallback(()=>{u(l=>l+1)},[]),_e=c.useCallback(()=>{const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:h,questionid:o}),{signal:l.signal}).then(m=>m.json()).then(m=>{var S,J;const d=m.posts;r(d),v(!1),g(((S=d[0])==null?void 0:S.id)??0),i(((J=d[d.length-1])==null?void 0:J.id)??1/0)}).catch(m=>{m.name}),()=>l.abort()},[e,h]);c.useEffect(()=>(p.on(p.events.MESSAGE_DELETED,H),p.on(p.events.MESSAGE_REPORTED,W),p.on(p.events.MESSAGE_SEND,V),p.on(p.events.MESSAGE_RATED,Q),()=>{p.off(p.events.MESSAGE_DELETED,H),p.off(p.events.MESSAGE_REPORTED,W),p.off(p.events.MESSAGE_SEND,V),p.off(p.events.MESSAGE_RATED,Q)}),[]),c.useEffect(()=>{if(!h)return;const l=document.querySelector(`#learningcompanions_chat-post-${h}`);l&&l.scrollIntoView()},[E]);function we(){if(P===null||I)return;I=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:P,questionid:o}),{signal:l.signal}).then(m=>m.json()).then(m=>{const d=m.posts;d.length&&(r(S=>[...S,...d]),i(d[d.length-1].id))}).catch(m=>{m.name}).finally(()=>{I=!1}),()=>l.abort()}function Ee(){if(y===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${y}&questionid=${o}`,{signal:l.signal}).then(m=>m.json()).then(m=>{const d=m.posts;d&&d.length&&(r(S=>[...d,...S]),g(d[0].id))}),()=>l.abort()}return c.useEffect(_e,[e]),c.useEffect(Ee,[a]),c.useEffect(()=>{const l=window.setInterval(()=>{u(m=>m+1)},1e4);return()=>{window.clearInterval(l)}},[]),w("div",{id:"learningcompanions_chat-postlist",children:[n(me,{group:t,questionid:o}),E&&n(G,{}),!E&&n(le,{posts:s,handleWrapperScroll:l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&we()},isInPreviewMode:f,isDummyGroup:_,highlightedPostId:h,questionid:o})]})}const U=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function fe({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,o]=c.useState([]),[s,r]=c.useState(e),[a,u]=c.useState(!1),[E,v]=c.useState(!0);s===void 0&&t.length&&r(t[0].id),c.useEffect(()=>{const i=t.find(_=>+_.id==+s),h=i==null?void 0:i.chatid,f=!window.learningcompanions_questionid&&i?i.isPreviewGroup:!1;te(f,h)},[s,t]);function y(i){const h=new URLSearchParams(window.location.search);h.set("groupid",i),h.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${h}`),r(i),o(f=>f.map(_=>(+_.id==+i&&(_.comments_since_last_visit=0,_.has_new_comments=!1),_)))}c.useEffect(()=>{const i=new URLSearchParams,h=new AbortController;U&&i.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${i}`,{signal:h.signal}).then(f=>f.json()).then(({groups:f})=>{o(f),v(!1),f.length===0&&ne()}).catch(f=>{f.name!=="AbortError"&&console.log("Error: "+f.message)})},[a]),c.useEffect(()=>{const i=window.setInterval(()=>{u(h=>!h)},5e4);return()=>{window.clearInterval(i)}},[]);const g=document.getElementById("learningcompanions_chat-content"),P=t.find(i=>+(i==null?void 0:i.id)==+s);return w(x,{children:[w("div",{id:"learningcompanions_chat-grouplist",children:[E&&n(G,{}),t.map(i=>n(ee,{handleGroupSelect:y,group:i,activeGroupid:s},i.id)),t.length===0&&!E&&n("p",{children:"No groups found"})]}),N.createPortal(n(F,{activeGroupid:s,group:P}),g)]})}function he(){L.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(fe,{activeGroupid:window.learningcompanions_groupid})}))}function pe(){const e=L.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(F,{questionid:t})}))}const ge={startChat:he,startQuestionChat:pe};window.Chat=ge})(React,ReactDOM);
