(function(c,N){"use strict";var P={exports:{}},I={};var Y=c,z=Symbol.for("react.element"),X=Symbol.for("react.fragment"),Z=Object.prototype.hasOwnProperty,q=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$={key:!0,ref:!0,__self:!0,__source:!0};function x(e,t,o){var r,s={},a=null,p=null;o!==void 0&&(a=""+o),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(p=t.ref);for(r in t)Z.call(t,r)&&!$.hasOwnProperty(r)&&(s[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps,t)s[r]===void 0&&(s[r]=t[r]);return{$$typeof:z,type:e,key:a,ref:p,props:s,_owner:q.current}}I.Fragment=X,I.jsx=x,I.jsxs=x,function(e){e.exports=I}(P);const j=P.exports.Fragment,n=P.exports.jsx,_=P.exports.jsxs;var R={},D=N;R.createRoot=D.createRoot,R.hydrateRoot=D.hydrateRoot;function O({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"-"});const o=new Date(e*1e3),r=new Intl.DateTimeFormat(void 0,t).format(o);return n("div",{className:"learningcompanions_chat_time",children:r})}function ee({handleGroupSelect:e,group:t,activeGroupid:o}){const{name:r,id:s,description:a,chatid:p,shortdescription:g,imageurl:w,latestcomment:v,isPreview:E,timecreated:i}=t,m=function(){e(s,p)};let f="d-flex learningcompanions_chat-group";return typeof o<"u"&&parseInt(o)===parseInt(s)&&(f+=" learningcompanions_currentgroup"),E&&(f+=" learningcompanions_previewgroup"),_("div",{onClick:m,id:"learningcompanions_chat-group-"+s,className:f,children:[n("img",{className:"learningcompanions_group_image_small",src:w}),_("div",{className:"learningcompanions_group_infos",children:[n("em",{children:r}),n("br",{}),n("span",{children:g})]}),n(O,{timestamp:v??i})]})}function k(){return n("div",{className:"learningcompanions_loading"})}function b(e,t="local_learningcompanions",o=[]){var p;const r=((p=window.M.str[t])==null?void 0:p[e])??`[[${e}_not_found]]`;if(!o.length)return r;const s=/{\$a->(\w*)}/gm,a=/{\$a}/gm;return typeof o=="object"?r.replace(s,(g,w)=>o[w]??g):r.replace(a,o)}const C=".js-chat-preview",G="#fitem_id_message",T="#fitem_id_attachments",B=".fdescription.required";function te(e,t){var r,s;let o=t;e?(o="",(r=document.querySelector(C))==null||r.classList.replace("d-none","d-flex"),document.querySelectorAll(`${G}, ${T}, ${B}`).forEach(a=>a.classList.add("d-none"))):((s=document.querySelector(C))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${G}, ${T}, ${B}`).forEach(a=>a.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=o}function ne(){document.querySelector(".chat-post-form").classList.add("d-none")}function oe({attachment:e}){const{url:t,filename:o}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:o})})}function re({attachments:e=[]}){return e.map(t=>n(oe,{attachment:t}))}function se({id:e}){const t=b("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ae({id:e}){const t=b("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ie({id:e,isratedbyuser:t}){return n("a",{href:"#","data-id":e,title:"Rate",className:`learningcompanions_rate_comment ${t?"learningcompanions_israted_by_current_user":""}`})}function ce({highlighted:e,post:t,isPreview:o,questionid:r}){const{author:s,id:a,timecreated:p,comment:g,attachments:w,flagged:v,timedeleted:E}=t;let i=!1,m=!1,f=r>0&&+s.id!=+window.learningcompanions_chat_userid,y;return typeof window.learningcompanions_chat_userid!==void 0&&+s.id==+window.learningcompanions_chat_userid?(i=!0,y="learningcompanions_chat-my-post"):(m=!0,y="learningcompanions_chat-other-post"),+v&&(y+=" learningcompanions_chat-reported-post"),_("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${y}`,children:[_("strong",{children:[s.firstname," ",s.lastname]}),n("br",{}),n("em",{children:n(O,{timestamp:p,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+E&&n("div",{dangerouslySetInnerHTML:{__html:g}}),!!+E&&n("div",{children:n("i",{children:"Message Deleted"})}),!+E&&!!w.length&&n(re,{attachments:w}),_("div",{className:"action-button-wrapper",children:[!o&&i&&n(se,{id:a}),!o&&m&&!+v&&n(ae,{id:a}),!o&&f&&n(ie,{id:a,isratedbyuser:t.isratedbyuser})]}),e&&_(j,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function le({posts:e,highlightedPostId:t,isInPreviewMode:o,handleWrapperScroll:r,questionid:s}){if(typeof e>"u"||!e.length){const a=b("no_posts_available");return n("div",{className:"post-wrapper p-3",children:a})}return n("div",{className:"post-wrapper",onScroll:r,children:e.map(a=>n(ce,{post:a,isPreview:o,highlighted:a.id===t,questionid:s},a.id))})}function de({group:e}){if(e!==void 0)return _("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function ue({questionid:e}){if(e===void 0)return;const[t,o]=c.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function r(){if(e===null)return;const s=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:s.signal}).then(a=>a.json()).then(a=>{a&&o(a)}),()=>s.abort()}return c.useEffect(r,[e]),_("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}const h={on(e,t,o={}){return document.addEventListener(e,r=>t(r.detail),o),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send",MESSAGE_RATED:"learningcompanions_message_rated"}};function F({activeGroupid:e,group:t,questionid:o}){const[r,s]=c.useState([]),[a,p]=c.useState(0),[g,w]=c.useState(!0),[v,E]=c.useState(null),[i,m]=c.useState(null),f=new URLSearchParams(window.location.search).get("postId"),y=!o&&t?t.isPreviewGroup:!1;let L=!1;c.useEffect(()=>{w(!0)},[e]);const H=c.useCallback(({postid:l})=>{s(u=>u.map(d=>(+d.id==+l&&(d.timedeleted=1),d)))},[]),Q=c.useCallback(({postid:l})=>{s(u=>u.map(d=>(+d.id==+l&&(d.flagged=!0),d)))},[]),W=c.useCallback(({postid:l,newvalue:u})=>{s(d=>d.map(S=>(+S.id==+l&&(S.isratedbyuser=u),S)))}),V=c.useCallback(()=>{p(l=>l+1)},[]),ge=c.useCallback(()=>{const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:f,questionid:o}),{signal:l.signal}).then(u=>u.json()).then(u=>{var S,K;const d=u.posts;s(d),w(!1),E(((S=d[0])==null?void 0:S.id)??0),m(((K=d[d.length-1])==null?void 0:K.id)??1/0)}).catch(u=>{u.name}),()=>l.abort()},[e,f]);c.useEffect(()=>(h.on(h.events.MESSAGE_DELETED,H),h.on(h.events.MESSAGE_REPORTED,Q),h.on(h.events.MESSAGE_SEND,V),h.on(h.events.MESSAGE_RATED,W),()=>{h.off(h.events.MESSAGE_DELETED,H),h.off(h.events.MESSAGE_REPORTED,Q),h.off(h.events.MESSAGE_SEND,V),h.off(h.events.MESSAGE_RATED,W)}),[]),c.useEffect(()=>{if(!f)return;const l=document.querySelector(`#learningcompanions_chat-post-${f}`);l&&l.scrollIntoView()},[g]);function _e(){if(i===null||L)return;L=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:i,questionid:o}),{signal:l.signal}).then(u=>u.json()).then(u=>{const d=u.posts;d.length&&(s(S=>[...S,...d]),m(d[d.length-1].id))}).catch(u=>{u.name}).finally(()=>{L=!1}),()=>l.abort()}function we(){if(v===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${v}&questionid=${o}`,{signal:l.signal}).then(u=>u.json()).then(u=>{const d=u.posts;d&&d.length&&(s(S=>[...d,...S]),E(d[0].id))}),()=>l.abort()}c.useEffect(ge,[e]),c.useEffect(we,[a]),c.useEffect(()=>{const l=window.setInterval(()=>{p(u=>u+1)},1e4);return()=>{window.clearInterval(l)}},[]);const Ee=l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&_e()};var A;const J=()=>{o?A=n(ue,{questionid:o}):A=n(de,{group:t})};return c.useEffect(J,[t,o]),J(),_("div",{id:"learningcompanions_chat-postlist",children:[A,y&&n("span",{children:"Is Preview"}),g&&n(k,{}),!g&&n(le,{posts:r,handleWrapperScroll:Ee,isInPreviewMode:y,highlightedPostId:f,questionid:o})]})}const U=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function fe({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,o]=c.useState([]),[r,s]=c.useState(e),[a,p]=c.useState(!1),[g,w]=c.useState(!0);r===void 0&&t.length&&s(t[0].id),c.useEffect(()=>{const i=t.find(y=>+y.id==+r),m=i==null?void 0:i.chatid,f=!window.learningcompanions_questionid&&i?i.isPreviewGroup:!1;te(f,m)},[r,t]);function v(i){const m=new URLSearchParams(window.location.search);m.set("groupid",i),m.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${m}`),s(i)}c.useEffect(()=>{const i=new URLSearchParams,m=new AbortController;U&&i.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${i}`,{signal:m.signal}).then(f=>f.json()).then(({groups:f})=>{o(f),w(!1),f.length===0&&ne()}).catch(f=>{f.name!=="AbortError"&&console.log("Error: "+f.message)})},[a]),c.useEffect(()=>{const i=window.setInterval(()=>{p(m=>!m)},5e4);return()=>{window.clearInterval(i)}},[]);const E=document.getElementById("learningcompanions_chat-content");return _(j,{children:[_("div",{id:"learningcompanions_chat-grouplist",children:[g&&n(k,{}),t.map(i=>n(ee,{handleGroupSelect:v,group:i,activeGroupid:r},i.id)),t.length===0&&!g&&n("p",{children:"No groups found"})]}),N.createPortal(n(F,{activeGroupid:r,group:t.find(i=>+(i==null?void 0:i.id)==+e)}),E)]})}function me(){R.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(fe,{activeGroupid:window.learningcompanions_groupid})}))}function he(){const e=R.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(F,{questionid:t})}))}const pe={startChat:me,startQuestionChat:he};window.Chat=pe})(React,ReactDOM);
