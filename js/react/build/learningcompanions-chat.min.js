(function(c,N){"use strict";var P={exports:{}},I={};var K=c,Y=Symbol.for("react.element"),z=Symbol.for("react.fragment"),X=Object.prototype.hasOwnProperty,Z=K.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,q={key:!0,ref:!0,__self:!0,__source:!0};function x(e,t,o){var r,s={},a=null,u=null;o!==void 0&&(a=""+o),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(u=t.ref);for(r in t)X.call(t,r)&&!q.hasOwnProperty(r)&&(s[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps,t)s[r]===void 0&&(s[r]=t[r]);return{$$typeof:Y,type:e,key:a,ref:u,props:s,_owner:Z.current}}I.Fragment=z,I.jsx=x,I.jsxs=x,function(e){e.exports=I}(P);const D=P.exports.Fragment,n=P.exports.jsx,_=P.exports.jsxs;var R={},G=N;R.createRoot=G.createRoot,R.hydrateRoot=G.hydrateRoot;function j({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return n("div",{className:"learningcompanions_chat_time",children:"-"});const o=new Date(e*1e3),r=new Intl.DateTimeFormat(void 0,t).format(o);return n("div",{className:"learningcompanions_chat_time",children:r})}function $({handleGroupSelect:e,group:t,activeGroupid:o}){const{name:r,id:s,description:a,chatid:u,shortdescription:g,imageurl:w,latestcomment:v,isPreview:E,timecreated:y}=t,i=function(){e(s,u)};let m="d-flex learningcompanions_chat-group";return typeof o<"u"&&parseInt(o)===parseInt(s)&&(m+=" learningcompanions_currentgroup"),E&&(m+=" learningcompanions_previewgroup"),_("div",{onClick:i,id:"learningcompanions_chat-group-"+s,className:m,children:[n("img",{className:"learningcompanions_group_image_small",src:w}),_("div",{className:"learningcompanions_group_infos",children:[n("em",{children:r}),n("br",{}),n("span",{children:g})]}),n(j,{timestamp:v??y})]})}function O(){return n("div",{className:"learningcompanions_loading"})}function b(e,t="local_learningcompanions",o=[]){var u;const r=((u=window.M.str[t])==null?void 0:u[e])??`[[${e}_not_found]]`;if(!o.length)return r;const s=/{\$a->(\w*)}/gm,a=/{\$a}/gm;return typeof o=="object"?r.replace(s,(g,w)=>o[w]??g):r.replace(a,o)}const k=".js-chat-preview",C="#fitem_id_message",T="#fitem_id_attachments",B=".fdescription.required";function ee(e,t){var r,s;let o=t;e?(o="",(r=document.querySelector(k))==null||r.classList.replace("d-none","d-flex"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.add("d-none"))):((s=document.querySelector(k))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${C}, ${T}, ${B}`).forEach(a=>a.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=o}function te(){document.querySelector(".chat-post-form").classList.add("d-none")}function ne({attachment:e}){const{url:t,filename:o}=e;return n("div",{children:n("a",{target:"_blank",href:t,children:o})})}function oe({attachments:e=[]}){return e.map(t=>n(ne,{attachment:t}))}function re({id:e}){const t=b("delete_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function se({id:e}){const t=b("report_post");return n("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ae({id:e,isratedbyuser:t}){return n("a",{href:"#","data-id":e,title:"Rate",className:`learningcompanions_rate_comment ${t?"learningcompanions_israted_by_current_user":""}`})}function ie({highlighted:e,post:t,isPreview:o,questionid:r}){const{author:s,id:a,timecreated:u,comment:g,attachments:w,flagged:v,timedeleted:E}=t;let y=!1,i=!1,m=r>0&&+s.id!=+window.learningcompanions_chat_userid,h;return typeof window.learningcompanions_chat_userid!==void 0&&+s.id==+window.learningcompanions_chat_userid?(y=!0,h="learningcompanions_chat-my-post"):(i=!0,h="learningcompanions_chat-other-post"),+v&&(h+=" learningcompanions_chat-reported-post"),_("div",{id:`learningcompanions_chat-post-${a}`,className:`learningcompanions_chat-post ${h}`,children:[_("strong",{children:[s.firstname," ",s.lastname]}),n("br",{}),n("em",{children:n(j,{timestamp:u,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),n("br",{}),!+E&&n("div",{dangerouslySetInnerHTML:{__html:g}}),!!+E&&n("div",{children:n("i",{children:"Message Deleted"})}),!+E&&!!w.length&&n(oe,{attachments:w}),_("div",{className:"action-button-wrapper",children:[!o&&y&&n(re,{id:a}),!o&&i&&!+v&&n(se,{id:a}),!o&&m&&n(ae,{id:a,isratedbyuser:t.isratedbyuser})]}),e&&_(D,{children:[n("br",{}),n("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function ce({posts:e,highlightedPostId:t,isInPreviewMode:o,handleWrapperScroll:r,questionid:s,isDummyGroup:a=!1}){if(a){const u=b("not_allowed_to_see_posts");return n("div",{className:"post-wrapper p-3",children:u})}if(typeof e>"u"||!e.length){const u=b("no_posts_available");return n("div",{className:"post-wrapper p-3",children:u})}return n("div",{className:"post-wrapper",onScroll:r,children:e.map(u=>n(ie,{post:u,isPreview:o,highlighted:u.id===t,questionid:s},u.id))})}const p={on(e,t,o={}){return document.addEventListener(e,r=>t(r.detail),o),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",MESSAGE_SEND:"learningcompanions_message_send",MESSAGE_RATED:"learningcompanions_message_rated"}};function le({questionid:e}){if(e===void 0)return;const[t,o]=c.useState({id:e,askedby:0,mentorid:0,question:"",title:"",topic:0,timecreated:"0",timeclosed:"0"});function r(){if(e===null)return;const s=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_getquestion.php?questionid=${e}`,{signal:s.signal}).then(a=>a.json()).then(a=>{a&&o(a)}),()=>s.abort()}return c.useEffect(r,[e]),_("div",{className:"learningcompanions_questionheader",children:[n("h1",{children:t.title}),n("p",{children:t.question})]})}function de({group:e}){if(e!==void 0)return _("div",{className:"learningcompanions_groupheader",children:[n("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),n("h1",{children:e.name}),e.dummyGroup||n("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function ue({questionid:e,group:t}){if(e)return n(le,{questionid:e});if(t)return n(de,{group:t})}function F({activeGroupid:e,group:t,questionid:o}){const[r,s]=c.useState([]),[a,u]=c.useState(0),[g,w]=c.useState(!0),[v,E]=c.useState(null),[y,i]=c.useState(null),m=new URLSearchParams(window.location.search).get("postId"),h=!o&&t?t.isPreviewGroup:!1,L=!o&&t?t.dummyGroup:!1;let A=!1;c.useEffect(()=>{w(!0)},[e]);const H=c.useCallback(({postid:l})=>{s(f=>f.map(d=>(+d.id==+l&&(d.timedeleted=1),d)))},[]),W=c.useCallback(({postid:l})=>{s(f=>f.map(d=>(+d.id==+l&&(d.flagged=!0),d)))},[]),Q=c.useCallback(({postid:l,newvalue:f})=>{s(d=>d.map(S=>(+S.id==+l&&(S.isratedbyuser=f),S)))}),V=c.useCallback(()=>{u(l=>l+1)},[]),ge=c.useCallback(()=>{const l=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxchat.php?"+new URLSearchParams({groupid:e,includedPostId:m,questionid:o}),{signal:l.signal}).then(f=>f.json()).then(f=>{var S,J;const d=f.posts;s(d),w(!1),E(((S=d[0])==null?void 0:S.id)??0),i(((J=d[d.length-1])==null?void 0:J.id)??1/0)}).catch(f=>{f.name}),()=>l.abort()},[e,m]);c.useEffect(()=>(p.on(p.events.MESSAGE_DELETED,H),p.on(p.events.MESSAGE_REPORTED,W),p.on(p.events.MESSAGE_SEND,V),p.on(p.events.MESSAGE_RATED,Q),()=>{p.off(p.events.MESSAGE_DELETED,H),p.off(p.events.MESSAGE_REPORTED,W),p.off(p.events.MESSAGE_SEND,V),p.off(p.events.MESSAGE_RATED,Q)}),[]),c.useEffect(()=>{if(!m)return;const l=document.querySelector(`#learningcompanions_chat-post-${m}`);l&&l.scrollIntoView()},[g]);function _e(){if(y===null||A)return;A=!0;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxchat.php?`+new URLSearchParams({groupid:e,firstPostId:y,questionid:o}),{signal:l.signal}).then(f=>f.json()).then(f=>{const d=f.posts;d.length&&(s(S=>[...S,...d]),i(d[d.length-1].id))}).catch(f=>{f.name}).finally(()=>{A=!1}),()=>l.abort()}function we(){if(v===null)return;const l=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajax_newmessages.php?groupId=${e}&lastPostId=${v}&questionid=${o}`,{signal:l.signal}).then(f=>f.json()).then(f=>{const d=f.posts;d&&d.length&&(s(S=>[...d,...S]),E(d[0].id))}),()=>l.abort()}return c.useEffect(ge,[e]),c.useEffect(we,[a]),c.useEffect(()=>{const l=window.setInterval(()=>{u(f=>f+1)},1e4);return()=>{window.clearInterval(l)}},[]),_("div",{id:"learningcompanions_chat-postlist",children:[n(ue,{group:t,questionid:o}),g&&n(O,{}),!g&&n(ce,{posts:r,handleWrapperScroll:l=>{-l.target.scrollTop+l.target.clientHeight>=l.target.scrollHeight&&_e()},isInPreviewMode:h,isDummyGroup:L,highlightedPostId:m,questionid:o})]})}const U=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function fe({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,o]=c.useState([]),[r,s]=c.useState(e),[a,u]=c.useState(!1),[g,w]=c.useState(!0);r===void 0&&t.length&&s(t[0].id),c.useEffect(()=>{const i=t.find(L=>+L.id==+r),m=i==null?void 0:i.chatid,h=!window.learningcompanions_questionid&&i?i.isPreviewGroup:!1;ee(h,m)},[r,t]);function v(i){const m=new URLSearchParams(window.location.search);m.set("groupid",i),m.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${m}`),s(i)}c.useEffect(()=>{const i=new URLSearchParams,m=new AbortController;U&&i.set("shouldIncludeId",U),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax/ajaxgrouplist.php?${i}`,{signal:m.signal}).then(h=>h.json()).then(({groups:h})=>{o(h),w(!1),h.length===0&&te()}).catch(h=>{h.name!=="AbortError"&&console.log("Error: "+h.message)})},[a]),c.useEffect(()=>{const i=window.setInterval(()=>{u(m=>!m)},5e4);return()=>{window.clearInterval(i)}},[]);const E=document.getElementById("learningcompanions_chat-content"),y=t.find(i=>+(i==null?void 0:i.id)==+r);return _(D,{children:[_("div",{id:"learningcompanions_chat-grouplist",children:[g&&n(O,{}),t.map(i=>n($,{handleGroupSelect:v,group:i,activeGroupid:r},i.id)),t.length===0&&!g&&n("p",{children:"No groups found"})]}),N.createPortal(n(F,{activeGroupid:r,group:y}),E)]})}function me(){R.createRoot(document.getElementById("learningcompanions_groups-content")).render(n(React.StrictMode,{children:n(fe,{activeGroupid:window.learningcompanions_groupid})}))}function pe(){const e=R.createRoot(document.getElementById("learningcompanions_chat-content")),t=window.learningcompanions_questionid;e.render(n(React.StrictMode,{children:n(F,{questionid:t})}))}const he={startChat:me,startQuestionChat:pe};window.Chat=he})(React,ReactDOM);
