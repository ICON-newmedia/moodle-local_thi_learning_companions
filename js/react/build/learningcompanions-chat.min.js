(function(c,K){"use strict";var S={exports:{}},y={};var Y=c,z=Symbol.for("react.element"),Q=Symbol.for("react.fragment"),X=Object.prototype.hasOwnProperty,Z=Y.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,q={key:!0,ref:!0,__self:!0,__source:!0};function O(e,t,r){var n,s={},u=null,m=null;r!==void 0&&(u=""+r),t.key!==void 0&&(u=""+t.key),t.ref!==void 0&&(m=t.ref);for(n in t)X.call(t,n)&&!q.hasOwnProperty(n)&&(s[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps,t)s[n]===void 0&&(s[n]=t[n]);return{$$typeof:z,type:e,key:u,ref:m,props:s,_owner:Z.current}}y.Fragment=Q,y.jsx=O,y.jsxs=O,function(e){e.exports=y}(S);const $=S.exports.Fragment,o=S.exports.jsx,_=S.exports.jsxs;var I={},b=K;I.createRoot=b.createRoot,I.hydrateRoot=b.hydrateRoot;function A({timestamp:e,format:t={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return o("div",{className:"learningcompanions_chat_time",children:"No Time!"});const r=new Date(e*1e3),n=new Intl.DateTimeFormat(void 0,t).format(r);return o("div",{className:"learningcompanions_chat_time",children:n})}function ee({handleGroupSelect:e,group:t,activeGroupid:r}){const{name:n,id:s,description:u,chatid:m,shortdescription:g,imageurl:v,latestcomment:w,isPreview:a}=t,h=function(){e(s,m)};let l="d-flex learningcompanions_chat-group";return typeof r<"u"&&parseInt(r)===parseInt(s)&&(l+=" learningcompanions_currentgroup"),a&&(l+=" learningcompanions_previewgroup"),_("div",{onClick:h,id:"learningcompanions_chat-group-"+s,className:l,children:[o("img",{className:"learningcompanions_group_image_small",src:v}),_("div",{className:"learningcompanions_group_infos",children:[o("em",{children:n}),o("br",{}),o("span",{children:g})]}),o(A,{timestamp:w})]})}function N(){return o("div",{className:"learningcompanions_loading"})}const f={on(e,t,r={}){return document.addEventListener(e,n=>t(n.detail),r),this},off(e,t){return this.remove(e,t)},dispatch(e,t){return document.dispatchEvent(new CustomEvent(e,{detail:t})),this},remove(e,t){return document.removeEventListener(e,t),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported",GROUPS_UPDATED:"learningcompanions_groups_updated"}};function L(e,t="local_learningcompanions",r=[]){var m;const n=((m=window.M.str[t])==null?void 0:m[e])??`[[${e}_not_found]]`;if(!r.length)return n;const s=/{\$a->(\w*)}/gm,u=/{\$a}/gm;return typeof r=="object"?n.replace(s,(g,v)=>r[v]??g):n.replace(u,r)}const C=".js-chat-preview",k="#fitem_id_message",x="#fitem_id_attachments",U=".fdescription.required";function te(e,t){var n,s;let r=t;e?(r="",(n=document.querySelector(C))==null||n.classList.replace("d-none","d-flex"),document.querySelectorAll(`${k}, ${x}, ${U}`).forEach(u=>u.classList.add("d-none"))):((s=document.querySelector(C))==null||s.classList.replace("d-flex","d-none"),document.querySelectorAll(`${k}, ${x}, ${U}`).forEach(u=>u.classList.remove("d-none"))),document.querySelector('input[name="chatid"]').value=r}function ne(){document.querySelector(".chat-post-form").classList.add("d-none")}const j=new URLSearchParams(window.location.search).get("groupid")||window.learningcompanions_groupid;function oe({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,r]=c.useState([]),[n,s]=c.useState(e),[u,m]=c.useState(!1),[g,v]=c.useState(!0);n===void 0&&t.length&&s(t[0].id),c.useEffect(()=>{const a=t.find(G=>+G.id==+n),h=a==null?void 0:a.chatid,l=(a==null?void 0:a.isPreviewGroup)??!1;te(l,h),console.log(`setting active group id to: ${n} and chatid to: ${h}`)},[n,t]);function w(a){f.dispatch(f.events.GROUP_CHANGED,{groupid:a});const h=new URLSearchParams(window.location.search);h.set("groupid",a),h.delete("postId"),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?${h}`),s(a)}return c.useEffect(()=>{const a=new URLSearchParams,h=new AbortController;j&&a.set("shouldIncludeId",j),fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxgrouplist.php?${a}`,{signal:h.signal}).then(l=>l.json()).then(({groups:l})=>{console.log("Groups",l),r(l),v(!1),f.dispatch(f.events.GROUPS_UPDATED,{groups:l}),l.length===0&&ne()}).catch(l=>{l.name!=="AbortError"&&console.log("Error: "+l.message)})},[u]),c.useEffect(()=>{const a=window.setInterval(()=>{m(h=>!h)},5e4);return()=>{window.clearInterval(a)}},[]),_("div",{id:"learningcompanions_chat-grouplist",children:[g&&o(N,{}),t.map(a=>o(ee,{handleGroupSelect:w,group:a,activeGroupid:n},a.id)),t.length===0&&!g&&o("p",{children:"No groups found"})]})}function se({attachment:e}){const{url:t,filename:r}=e;return o("div",{children:o("a",{target:"_blank",href:t,children:r})})}function re({attachments:e=[]}){return e.map(t=>o(se,{attachment:t}))}function ie({id:e}){const t=L("delete_post");return o("a",{href:"#","data-id":e,title:t,className:"learningcompanions_delete_comment"})}function ae({id:e}){const t=L("report_post");return o("a",{href:"#","data-id":e,title:t,className:"learningcompanions_report_comment"})}function ce({highlighted:e,post:t,isPreview:r}){const{author:n,id:s,timecreated:u,comment:m,attachments:g,flagged:v,timedeleted:w}=t;let a=!1,h=!1,l;return typeof window.learningcompanions_chat_userid!==void 0&&+n.id==+window.learningcompanions_chat_userid?(a=!0,l="learningcompanions_chat-my-post"):(h=!0,l="learningcompanions_chat-other-post"),+v&&(l+=" learningcompanions_chat-reported-post"),_("div",{id:`learningcompanions_chat-post-${s}`,className:`learningcompanions_chat-post ${l}`,children:[_("strong",{children:[n.firstname," ",n.lastname]}),o("br",{}),o("em",{children:o(A,{timestamp:u,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),o("br",{}),!+w&&o("div",{dangerouslySetInnerHTML:{__html:m}}),!!+w&&o("div",{children:o("i",{children:"Message Deleted"})}),!+w&&!!g.length&&o(re,{attachments:g}),_("div",{className:"action-button-wrapper",children:[!r&&a&&o(ie,{id:s}),!r&&h&&!+v&&o(ae,{id:s})]}),_("span",{children:["ID: ",s]}),e&&_($,{children:[o("br",{}),o("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function le({posts:e,highlightedPostId:t,isInPreviewMode:r,handleWrapperScroll:n}){if(!e.length){const s=L("no_posts_available");return o("div",{className:"post-wrapper p-3",children:s})}return o("div",{className:"post-wrapper",onScroll:n,children:e.map(s=>o(ce,{post:s,isPreview:r,highlighted:s.id===t},s.id))})}function de({group:e}){if(e!==void 0)return _("div",{className:"learningcompanions_groupheader",children:[o("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),o("h1",{children:e.name}),e.dummyGroup||o("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function ue({activeGroupid:e}){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[t,r]=c.useState([]),[n,s]=c.useState(e),[u,m]=c.useState([]),[g,v]=c.useState(0),[w,a]=c.useState(!0),[h,l]=c.useState(null),[G,T]=c.useState(null);console.log("Postlist",{startGroupId:e,activeGroupid:n});const P=new URLSearchParams(window.location.search).get("postId"),R=u.find(i=>+i.id==+n),H=(R==null?void 0:R.isPreviewGroup)??!1;let D=!1;n===void 0&&u.length&&s(u[0].id);const F=c.useCallback(i=>{console.log(i),s(i.groupid),a(!0)},[]),B=c.useCallback(i=>{m(i.groups)},[]),W=c.useCallback(({postid:i})=>{r(d=>d.map(p=>(+p.id==+i&&(p.timedeleted=1),p)))},[]),V=c.useCallback(({postid:i})=>{r(d=>d.map(p=>(+p.id==+i&&(p.flagged=!0),p)))},[]),he=c.useCallback(()=>{const i=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:n,includedPostId:P}),{signal:i.signal}).then(d=>d.json()).then(d=>{var E,J;const p=d.posts;r(p),a(!1),l(((E=p[0])==null?void 0:E.id)??0),T(((J=p[p.length-1])==null?void 0:J.id)??1/0)}).catch(d=>{d.name!=="AbortError"&&console.log(d)}),()=>i.abort()},[n,P]);c.useEffect(()=>(f.on(f.events.GROUP_CHANGED,F),f.on(f.events.MESSAGE_DELETED,W),f.on(f.events.MESSAGE_REPORTED,V),f.on(f.events.GROUPS_UPDATED,B),()=>{f.off(f.events.GROUP_CHANGED,F),f.off(f.events.MESSAGE_DELETED,W),f.off(f.events.MESSAGE_REPORTED,V),f.off(f.events.GROUPS_UPDATED,B)}),[]),c.useEffect(()=>{if(!P)return;const i=document.querySelector(`#learningcompanions_chat-post-${P}`);i&&i.scrollIntoView()},[w]);function me(){if(G===null||D)return;D=!0;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:n,firstPostId:G}),{signal:i.signal}).then(d=>d.json()).then(d=>{const p=d.posts;p.length&&(r(E=>[...E,...p]),T(p[p.length-1].id))}).catch(d=>{d.name!=="AbortError"&&console.log(d)}).finally(()=>{D=!1}),()=>i.abort()}function ge(){if(h===null)return;const i=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${n}&lastPostId=${h}`,{signal:i.signal}).then(d=>d.json()).then(d=>{const p=d.posts;p.length&&(r(E=>[...p,...E]),l(p[0].id))}),()=>i.abort()}c.useEffect(he,[n]),c.useEffect(ge,[g]),c.useEffect(()=>{const i=window.setInterval(()=>{v(d=>d+1)},3e4);return()=>{window.clearInterval(i)}},[]);const we=i=>{-i.target.scrollTop+i.target.clientHeight>=i.target.scrollHeight&&me()};return _("div",{id:"learningcompanions_chat-postlist",children:[o(de,{group:R}),H&&o("span",{children:"Is Preview"}),w&&o(N,{}),!w&&u.length>0&&o(le,{posts:t,handleWrapperScroll:we,isInPreviewMode:H,highlightedPostId:P})]})}const pe=I.createRoot(document.getElementById("learningcompanions_groups-content")),fe=I.createRoot(document.getElementById("learningcompanions_chat-content"));pe.render(o(React.StrictMode,{children:o(oe,{activeGroupid:window.learningcompanions_groupid})})),fe.render(o(React.StrictMode,{children:o(ue,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
