(function(s,j){"use strict";var y={exports:{}},S={};var T=s,F=Symbol.for("react.element"),H=Symbol.for("react.fragment"),U=Object.prototype.hasOwnProperty,B=T.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,W={key:!0,ref:!0,__self:!0,__source:!0};function G(e,n,a){var c,u={},d=null,f=null;a!==void 0&&(d=""+a),n.key!==void 0&&(d=""+n.key),n.ref!==void 0&&(f=n.ref);for(c in n)U.call(n,c)&&!W.hasOwnProperty(c)&&(u[c]=n[c]);if(e&&e.defaultProps)for(c in n=e.defaultProps,n)u[c]===void 0&&(u[c]=n[c]);return{$$typeof:F,type:e,key:d,ref:f,props:u,_owner:B.current}}S.Fragment=H,S.jsx=G,S.jsxs=G,function(e){e.exports=S}(y);const J=y.exports.Fragment,t=y.exports.jsx,h=y.exports.jsxs;var I={},b=j;I.createRoot=b.createRoot,I.hydrateRoot=b.hydrateRoot;function O({timestamp:e,format:n={year:"numeric",month:"2-digit",day:"2-digit"}}){if(e=e??0,e=parseInt(e),e===0)return t("div",{className:"learningcompanions_chat_time",children:"No Time!"});const a=new Date(e*1e3),c=new Intl.DateTimeFormat(void 0,n).format(a);return t("div",{className:"learningcompanions_chat_time",children:c})}function K({handleGroupSelect:e,name:n,id:a,description:c,chatid:u,shortdescription:d,imageurl:f,latestcomment:_,activeGroupid:v}){const g=function(){e(a,u)};let w="d-flex learningcompanions_chat-group";return typeof v<"u"&&parseInt(v)===parseInt(a)&&(w+=" learningcompanions_currentgroup"),h("div",{onClick:g,id:"learningcompanions_chat-group-"+a,className:w,children:[t("img",{className:"learningcompanions_group_image_small",src:f}),h("div",{className:"learningcompanions_group_infos",children:[t("em",{children:n}),t("br",{}),t("span",{children:d})]}),t(O,{timestamp:_})]})}function N({loading:e}){return e?t("div",{className:"learningcompanions_loading"}):null}const p={on(e,n,a={}){return document.addEventListener(e,c=>n(c.detail),a),this},off(e,n){return this.remove(e,n)},dispatch(e,n){return document.dispatchEvent(new CustomEvent(e,{detail:n})),this},remove(e,n){return document.removeEventListener(e,n),this},events:{GROUP_CHANGED:"groupchanged",MESSAGE_DELETED:"learningcompanions_message_deleted",MESSAGE_REPORTED:"learningcompanions_message_reported"}};function V(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,a]=s.useState([]),[c,u]=s.useState(e.activeGroupid),[d,f]=s.useState(0),[_,v]=s.useState(!0);function g(r,m){p.dispatch(p.events.GROUP_CHANGED,{groupid:r}),u(r),document.querySelector('input[name="chatid"]').value=m,console.log(`setting active group id to: ${r} and chatid to: ${m}`)}function w(){const r=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxgrouplist.php",{signal:r.signal}).then(m=>m.json()).then(({groups:m})=>{a(m),v(!1)}).catch(m=>{m.name!=="AbortError"&&console.log("Error: "+m.message)}),()=>r.abort()}return s.useEffect(w,[c,d]),s.useEffect(()=>{const r=window.setInterval(()=>{f(m=>m+1)},5e4);return()=>{window.clearInterval(r)}},[]),h("div",{id:"learningcompanions_chat-grouplist",children:[_&&t(N,{}),n.map(r=>t(K,{handleGroupSelect:g,name:r.name,chatid:r.chatid,id:r.id,shortdescription:r.shortdescription,description:r.description,imageurl:r.imageurl,latestcomment:r.latestcomment,activeGroupid:c},r.id))]})}function Y({attachment:e}){const{url:n,filename:a}=e;return t("div",{children:t("a",{target:"_blank",href:n,children:a})})}function z({attachments:e=[]}){return e.map(n=>t(Y,{attachment:n}))}function Q({id:e}){return t("a",{href:"#","data-id":e,title:"Delete",className:"learningcompanions_delete_comment"})}function X({id:e}){return t("a",{href:"#","data-id":e,title:"Report",className:"learningcompanions_report_comment"})}function Z({author:e,id:n,datetime:a,timestamp:c,comment:u,attachments:d,reported:f,deleted:_,highlighted:v}){let g=!1,w=!1,r;return typeof window.learningcompanions_chat_userid!==void 0&&+e.id==+window.learningcompanions_chat_userid?(g=!0,r="learningcompanions_chat-my-post"):(w=!0,r="learningcompanions_chat-other-post"),f&&(r+=" learningcompanions_chat-reported-post"),h("div",{id:`learningcompanions_chat-post-${n}`,className:`learningcompanions_chat-post ${r}`,children:[h("strong",{children:[e.firstname," ",e.lastname]}),t("br",{}),t("em",{children:t(O,{timestamp:c,format:{year:"numeric",month:"2-digit",day:"2-digit",weekday:"long"}})}),t("br",{}),!_&&t("div",{dangerouslySetInnerHTML:{__html:u}}),_&&t("div",{children:t("i",{children:"Message Deleted"})}),!!d.length&&t(z,{attachments:d}),h("div",{className:"action-button-wrapper",children:[g&&t(Q,{id:n}),w&&!f&&t(X,{id:n})]}),h("span",{children:["ID: ",n]}),v&&h(J,{children:[t("br",{}),t("span",{className:"highlighted-post",children:"Highlighted"})]})]})}function q({group:e}){return h("div",{className:"learningcompanions_groupheader",children:[t("div",{className:"learningcompanions_groupimage",style:{backgroundImage:"url("+e.imageurl+")"}}),t("h1",{children:e.name}),t("a",{href:"#",className:"learningcompanions_editgroup","data-gid":e.id,"data-title":e.name})]})}function $(e){typeof window.M>"u"&&(window.M={cfg:{wwwroot:""}});const[n,a]=s.useState([]),[c,u]=s.useState({}),[d,f]=s.useState(e.activeGroupid),[_,v]=s.useState(0),[g,w]=s.useState(!0),[r,m]=s.useState(null),[L,D]=s.useState(null);let R=!1;const P=new URLSearchParams(window.location.search).get("postId"),A=s.useCallback(o=>{f(o.groupid),window.history.replaceState(null,"Chat",`${window.M.cfg.wwwroot}/local/learningcompanions/chat.php?groupid=${o.groupid}`)},[]),k=s.useCallback(({postid:o})=>{a(i=>i.map(l=>(+l.id==+o&&(l.timedeleted=1),l)))},[]),C=s.useCallback(({postid:o})=>{a(i=>i.map(l=>(+l.id==+o&&(l.flagged=!0),l)))},[]);s.useEffect(()=>(p.on(p.events.GROUP_CHANGED,A),p.on(p.events.MESSAGE_DELETED,k),p.on(p.events.MESSAGE_REPORTED,C),()=>{p.off(p.events.GROUP_CHANGED,A),p.off(p.events.MESSAGE_DELETED,k),p.off(p.events.MESSAGE_REPORTED,C)}),[]),s.useEffect(()=>{if(!P)return;const o=document.querySelector(`#learningcompanions_chat-post-${P}`);console.log("Found element:",o),o&&o.scrollIntoView()},[g]);function ne(){if(L===null||R)return;R=!0;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajaxchat.php?`+new URLSearchParams({groupid:d,firstPostId:L}),{signal:o.signal}).then(i=>i.json()).then(i=>{const l=i.posts;l.length&&(a(E=>[...E,...l]),D(l[l.length-1].id))}).catch(i=>{i.name!=="AbortError"&&console.log(i)}).finally(()=>{R=!1}),()=>o.abort()}function oe(){const o=new AbortController;return fetch(M.cfg.wwwroot+"/local/learningcompanions/ajaxchat.php?"+new URLSearchParams({groupid:d,includedPostId:P}),{signal:o.signal}).then(i=>i.json()).then(i=>{var E,x;const l=i.posts;a(l),u(i.group),w(!1),m(((E=l[0])==null?void 0:E.id)??0),D(((x=l[l.length-1])==null?void 0:x.id)??1/0)}).catch(i=>{i.name!=="AbortError"&&console.log(i)}),()=>o.abort()}function re(){if(r===null)return;const o=new AbortController;return fetch(`${M.cfg.wwwroot}/local/learningcompanions/ajax_newmessages.php?groupId=${d}&lastPostId=${r}`,{signal:o.signal}).then(i=>i.json()).then(i=>{const l=i.posts;l.length&&(a(E=>[...l,...E]),m(l[0].id))}),()=>o.abort()}return s.useEffect(oe,[d]),s.useEffect(re,[_]),s.useEffect(()=>{const o=window.setInterval(()=>{v(i=>i+1)},3e4);return()=>{window.clearInterval(o)}},[]),h("div",{id:"learningcompanions_chat-postlist",children:[g&&t(N,{}),t(q,{group:c}),t("div",{className:"post-wrapper",onScroll:o=>{-o.target.scrollTop+o.target.clientHeight>=o.target.scrollHeight&&ne()},children:n.map(o=>t(Z,{author:o.author,id:o.id,datetime:o.datetime,timestamp:o.timecreated,comment:o.comment,attachments:o.attachments,reported:!!+o.flagged,deleted:!!+o.timedeleted,highlighted:o.id===P},o.id))})]})}const ee=I.createRoot(document.getElementById("learningcompanions_groups-content")),te=I.createRoot(document.getElementById("learningcompanions_chat-content"));ee.render(t(React.StrictMode,{children:t(V,{activeGroupid:window.learningcompanions_groupid})})),te.render(t(React.StrictMode,{children:t($,{activeGroupid:window.learningcompanions_groupid})}))})(React,ReactDOM);
