define("local_learningcompanions/group",["exports","jquery","core/str","core/modal_factory","core/modal_events","local_learningcompanions/datatables-helpers","local_learningcompanions/ajax","local_learningcompanions/datatables","local_learningcompanions/select2","core_form/dynamicform","core/templates","local_learningcompanions/invite_members","core/fragment","core/pending","core/notification","core/form-autocomplete"],(function(_exports,_jquery,str,ModalFactory,ModalEvents,datatablesHelpers,_ajax,_datatables,_select,_dynamicform,_templates,_invite_members,_fragment,_pending,Notification,Autocomplete){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.select2=_exports.init=_exports.handleGroupRequestButton=_exports.handleGroupLeaveButton=_exports.handleGroupInviteButton=void 0,_jquery=_interopRequireDefault(_jquery);str=_interopRequireWildcard(str);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),datatablesHelpers=_interopRequireWildcard(datatablesHelpers),_dynamicform=_interopRequireDefault(_dynamicform),_templates=_interopRequireDefault(_templates),_fragment=_interopRequireDefault(_fragment),_pending=_interopRequireDefault(_pending),Notification=_interopRequireWildcard(Notification),Autocomplete=_interopRequireWildcard(Autocomplete);_exports.select2=()=>{(0,_jquery.default)(".select2").select2()};_exports.init=()=>{setupDatatables(),attachEvents()};const setupDatatables=async()=>{datatablesHelpers.initMinSearch(".js-group-filter--min"),datatablesHelpers.initIncludeSearch(".js-group-filter--includes");const url=await str.get_string("datatables_url","local_learningcompanions");(0,_jquery.default)("#allgroupstable").DataTable({dom:"lrtip",language:{url:url},initComplete:function(){const table=this.api();datatablesHelpers.setupSearchRules(".js-group-filter--search",table),datatablesHelpers.addRedrawEvent(".js-group-filter",table),datatablesHelpers.makeTablesFullWidth(),datatablesHelpers.initOrSearch(".js-group-filter--or-search",table),document.querySelector('input[data-target="course"]').dispatchEvent(new Event("change"))}})},attachEvents=()=>{const body=(0,_jquery.default)("body");(0,_jquery.default)(".grouprow").click(handleTableRowClick),body.on("click","#mentor-deletemyquestion-modal-close",(()=>(0,_jquery.default)(".modal").remove())),body.on("click",".js-leave-group",handleGroupLeaveButton),body.on("click",".js-request-join-group",handleGroupRequestButton),body.on("click",".js-invite-member",handleGroupInviteButton)},handleTableRowClick=async function(e){e.preventDefault();const groupid=(0,_jquery.default)(this).data("gid"),groupname=(0,_jquery.default)(this).data("title"),groupDetailsPromise=(0,_ajax.promiseAjax)(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax.php",{action:"getgroupdetails",groupid:groupid,referrer:"groupsearch"}),titlePromise=str.get_string("modal-groupdetails-groupname","local_learningcompanions",groupname),[{html:html},title]=await Promise.all([groupDetailsPromise,titlePromise]),modal=await ModalFactory.create({title:title,body:html,footer:"",large:!0});modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.show()},handleGroupInviteButton=async function(e){e.preventDefault();const pendingPromise=new _pending.default("local_learningcompanions/group:handleGroupInviteButton"),groupId=(0,_jquery.default)(this).data("groupid"),templatePromise=_fragment.default.loadFragment("local_learningcompanions","invitation_form",groupId,{}),stringsPromise=str.get_strings([{key:"group_invite_title",component:"local_learningcompanions"},{key:"group_invite_placeholder",component:"local_learningcompanions"},{key:"group_invite_noselection",component:"local_learningcompanions"}]),[template,strings]=await Promise.all([templatePromise,stringsPromise]),modal=await ModalFactory.create({title:strings[0],body:template,footer:"",large:!1});modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.show(),(0,_jquery.default)("#id_cancel").on("click",(function(e){return e.preventDefault(),modal.destroy(),!1})),Autocomplete.enhance("#id_userlist",!0,"local_learningcompanions/invitation_potential_user_selector",strings[1],!1,!0,strings[2],!0),Promise.all([modal,modal.getBodyPromise()]).then((_ref=>{let[modal,body]=_ref;return console.log("modal:",modal,"body:",body),modal})).then((modal=>(pendingPromise.resolve(),modal))).catch(Notification.exception)};_exports.handleGroupInviteButton=handleGroupInviteButton;const handleGroupLeaveButton=async function(e){e.preventDefault();const groupId=(0,_jquery.default)(this).data("groupid"),response=await(0,_ajax.promiseAjax)(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax.php",{action:"leavegroup",groupid:groupId});if(response.needsNewAdmin){const possibleNewAdminsBodyPromise=(0,_ajax.promiseAjax)(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax.php",{action:"getpossiblenewadmins",groupid:groupId}),titlePromise=str.get_string("modal-groupdetails-needsnewadmin","local_learningcompanions"),[possibleNewAdminsBody,title]=await Promise.all([possibleNewAdminsBodyPromise,titlePromise]),modal=await ModalFactory.create({title:title,body:possibleNewAdminsBody,footer:"",large:!1});modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.show();const newAdminForm=new _dynamicform.default(document.querySelector("#formcontainer"),"local_learningcompanions\\forms\\assign_new_admin_while_leaving_form");newAdminForm.load({groupId:groupId}),newAdminForm.addEventListener(newAdminForm.events.FORM_SUBMITTED,(()=>{window.location.reload()}))}if(response.isLastMember){const templatePromise=_templates.default.renderForPromise("local_learningcompanions/group/group_modal_confirm_leave",{}),titlePromise=str.get_string("modal-groupdetails-leavetitle","local_learningcompanions"),[{html:html},title]=await Promise.all([templatePromise,titlePromise]),modal=await ModalFactory.create({title:title,body:html,footer:"",large:!1});modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.show();const confirmLeaveForm=new _dynamicform.default(document.querySelector("#formcontainer"),"local_learningcompanions\\forms\\last_user_leaves_closed_group_form");confirmLeaveForm.load({groupId:groupId}),confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_SUBMITTED,(()=>{window.location.reload()})),confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_CANCELLED,(()=>{modal.destroy()}))}response.leaved&&window.location.reload()};_exports.handleGroupLeaveButton=handleGroupLeaveButton;const handleGroupRequestButton=async function(e){e.preventDefault();const errorCode=await(0,_ajax.promiseAjax)(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax.php",{action:"requestgroupjoin",groupid:(0,_jquery.default)(this).data("groupid")});if(errorCode){const errorMessage=await str.get_string("group_request_error_code_".concat(errorCode),"local_learningcompanions");alert(errorMessage)}else window.location.reload()};_exports.handleGroupRequestButton=handleGroupRequestButton}));

//# sourceMappingURL=group.min.js.map