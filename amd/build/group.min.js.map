{"version":3,"file":"group.min.js","sources":["../src/group.js"],"sourcesContent":["/* eslint-disable jsdoc/require-jsdoc, no-console, max-len */\r\nimport $ from 'jquery';\r\nimport * as str from 'core/str';\r\nimport * as ModalFactory from 'core/modal_factory';\r\nimport * as ModalEvents from 'core/modal_events';\r\nimport * as datatablesHelpers from 'local_learningcompanions/datatables-helpers';\r\nimport {promiseAjax} from \"local_learningcompanions/ajax\";\r\n// import 'local_learningcompanions/jquery.dataTables';\r\nimport 'local_learningcompanions/datatables';\r\nimport 'local_learningcompanions/select2';\r\nimport DynamicForm from 'core_form/dynamicform';\r\nimport Templates from 'core/templates';\r\nimport {init as inviteInit} from 'local_learningcompanions/invite_members';\r\nimport Fragment from \"../../../../lib/amd/src/fragment\";\r\n\r\n\r\nexport const select2 = () => {\r\n    $('.select2').select2();\r\n};\r\n\r\nexport const init = () => {\r\n    setupDatatables();\r\n    attachEvents();\r\n};\r\n\r\nconst setupDatatables = async() => {\r\n    datatablesHelpers.initMinSearch('.js-group-filter--min');\r\n    datatablesHelpers.initIncludeSearch('.js-group-filter--includes');\r\n\r\n    const url = await str.get_string('datatables_url', 'local_learningcompanions');\r\n\r\n    // eslint-disable-next-line promise/catch-or-return,promise/always-return\r\n    $('#allgroupstable').DataTable({\r\n        dom: 'lrtip',\r\n        language: {\r\n            url: url\r\n        },\r\n        initComplete: function() {\r\n            const table = this.api();\r\n\r\n            datatablesHelpers.setupSearchRules('.js-group-filter--search', table);\r\n            datatablesHelpers.addRedrawEvent('.js-group-filter', table);\r\n            datatablesHelpers.makeTablesFullWidth();\r\n            datatablesHelpers.initOrSearch('.js-group-filter--or-search', table);\r\n\r\n            // trigger onchange event for course name filter upon page load in case we prefilter by course name\r\n            var theinput = document.querySelector('input[data-target=\"course\"]');\r\n            theinput.dispatchEvent(new Event('change'));\r\n        },\r\n    });\r\n\r\n};\r\n\r\nconst attachEvents = () => {\r\n    const body = $('body');\r\n    $('.grouprow').click(handleTableRowClick);\r\n\r\n    body.on('click', '#mentor-deletemyquestion-modal-close', () => $('.modal').remove());\r\n\r\n    body.on('click', '.js-leave-group', handleGroupLeaveButton);\r\n    body.on('click', '.js-request-join-group', handleGroupRequestButton);\r\n    body.on('click', '.js-invite-member', handleGroupInviteButton);\r\n};\r\n\r\nconst handleTableRowClick = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const groupid = $(this).data('gid');\r\n    const groupname = $(this).data('title');\r\n\r\n    const groupDetailsPromise = promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\r\n        action: 'getgroupdetails',\r\n        groupid: groupid,\r\n        'referrer': 'groupsearch'\r\n    });\r\n    const titlePromise = str.get_string('modal-groupdetails-groupname', 'local_learningcompanions', groupname);\r\n\r\n    const [{html}, title] = await Promise.all([groupDetailsPromise, titlePromise]);\r\n\r\n    const modal = await ModalFactory.create({\r\n        title: title,\r\n        body: html,\r\n        footer: '',\r\n        large: true\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.hidden, function() {\r\n        modal.destroy();\r\n    });\r\n    modal.show();\r\n};\r\n\r\nexport const handleGroupInviteButton = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const groupId = $(this).data('groupid');\r\n\r\n    // const templatePromise = Templates.renderForPromise('local_learningcompanions/group/group_invite', {\r\n    //     groupId\r\n    // });\r\n    console.log('calling invitation form template with group id: ', groupId);\r\n    const templatePromise = Fragment.loadFragment('local_learningcompanions', 'invitation_form', groupId, {});\r\n    const titlePromise = str.get_string('group_invite_title', 'local_learningcompanions');\r\n\r\n    const [template, title] = await Promise.all([templatePromise, titlePromise]);\r\n    console.log('got template for group invitation:', template); // ICUNDO!\r\n\r\n    const modal = await ModalFactory.create({\r\n        title: title,\r\n        body: template,\r\n        footer: '',\r\n        large: false\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.hidden, function() {\r\n        modal.destroy();\r\n    });\r\n    modal.show();\r\n\r\n    inviteInit();\r\n};\r\n\r\nexport const handleGroupLeaveButton = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const groupId = $(this).data('groupid');\r\n\r\n    /**\r\n     * @type {{needsNewAdmin: ?bool, leaved: bool, isLastMember: ?bool}}\r\n     */\r\n    const response = await promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\r\n        action: 'leavegroup',\r\n        groupid: groupId\r\n    });\r\n\r\n    if (response.needsNewAdmin) {\r\n        const possibleNewAdminsBodyPromise = promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\r\n            action: 'getpossiblenewadmins',\r\n            groupid: groupId\r\n        });\r\n        const titlePromise = str.get_string('modal-groupdetails-needsnewadmin', 'local_learningcompanions');\r\n\r\n        const [possibleNewAdminsBody, title] = await Promise.all([possibleNewAdminsBodyPromise, titlePromise]);\r\n\r\n        const modal = await ModalFactory.create({\r\n            title: title,\r\n            body: possibleNewAdminsBody,\r\n            footer: '',\r\n            large: false\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.hidden, function() {\r\n            modal.destroy();\r\n        });\r\n        modal.show();\r\n\r\n        const newAdminForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_learningcompanions\\\\forms\\\\assign_new_admin_while_leaving_form');\r\n        newAdminForm.load({groupId: groupId});\r\n        newAdminForm.addEventListener(newAdminForm.events.FORM_SUBMITTED, () => {\r\n            window.location.reload();\r\n        });\r\n    }\r\n\r\n    if (response.isLastMember) {\r\n        const templatePromise = Templates.renderForPromise('local_learningcompanions/group/group_modal_confirm_leave', {});\r\n        const titlePromise = str.get_string('modal-groupdetails-leavetitle', 'local_learningcompanions');\r\n\r\n        const [{html}, title] = await Promise.all([templatePromise, titlePromise]);\r\n\r\n        const modal = await ModalFactory.create({\r\n            title: title,\r\n            body: html,\r\n            footer: '',\r\n            large: false\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.hidden, function() {\r\n            modal.destroy();\r\n        });\r\n        modal.show();\r\n\r\n        const confirmLeaveForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_learningcompanions\\\\forms\\\\last_user_leaves_closed_group_form');\r\n        confirmLeaveForm.load({groupId: groupId});\r\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_SUBMITTED, () => {\r\n            window.location.reload();\r\n        });\r\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_CANCELLED, () => {\r\n            modal.destroy();\r\n        });\r\n    }\r\n\r\n    if (response.leaved) {\r\n        window.location.reload();\r\n    }\r\n};\r\n\r\nexport const handleGroupRequestButton = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const errorCode = await promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\r\n        action: 'requestgroupjoin',\r\n        groupid: $(this).data('groupid')\r\n    });\r\n\r\n    if (!errorCode) { // All good\r\n        window.location.reload();\r\n    } else { // Error happened\r\n        const errorMessage = await str.get_string(`group_request_error_code_${errorCode}`, 'local_learningcompanions');\r\n        alert(errorMessage);\r\n    }\r\n};\r\n"],"names":["select2","setupDatatables","attachEvents","async","datatablesHelpers","initMinSearch","initIncludeSearch","url","str","get_string","DataTable","dom","language","initComplete","table","this","api","setupSearchRules","addRedrawEvent","makeTablesFullWidth","initOrSearch","document","querySelector","dispatchEvent","Event","body","click","handleTableRowClick","on","remove","handleGroupLeaveButton","handleGroupRequestButton","handleGroupInviteButton","e","preventDefault","groupid","data","groupname","groupDetailsPromise","M","cfg","wwwroot","action","titlePromise","html","title","Promise","all","modal","ModalFactory","create","footer","large","getRoot","ModalEvents","hidden","destroy","show","groupId","console","log","templatePromise","Fragment","loadFragment","template","response","needsNewAdmin","possibleNewAdminsBodyPromise","possibleNewAdminsBody","newAdminForm","DynamicForm","load","addEventListener","events","FORM_SUBMITTED","window","location","reload","isLastMember","Templates","renderForPromise","confirmLeaveForm","FORM_CANCELLED","leaved","errorCode","errorMessage","alert"],"mappings":"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"}