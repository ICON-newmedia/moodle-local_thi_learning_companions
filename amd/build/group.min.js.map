{"version":3,"file":"group.min.js","sources":["../src/group.js"],"sourcesContent":["/* eslint-disable jsdoc/require-jsdoc, no-console, max-len */\nimport $ from 'jquery';\nimport * as str from 'core/str';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport * as datatablesHelpers from 'local_learningcompanions/datatables-helpers';\nimport {promiseAjax} from \"local_learningcompanions/ajax\";\n// import 'local_learningcompanions/jquery.dataTables';\nimport 'local_learningcompanions/datatables';\nimport 'local_learningcompanions/select2';\nimport DynamicForm from 'core_form/dynamicform';\nimport Templates from 'core/templates';\nimport {init as inviteInit} from 'local_learningcompanions/invite_members';\n\n\nexport const select2 = () => {\n    $('.select2').select2();\n};\n\nexport const init = () => {\n    setupDatatables();\n    attachEvents();\n};\n\nconst setupDatatables = async() => {\n    datatablesHelpers.initMinSearch('.js-group-filter--min');\n    datatablesHelpers.initIncludeSearch('.js-group-filter--includes');\n\n    const url = await str.get_string('datatables_url', 'local_learningcompanions');\n\n    // eslint-disable-next-line promise/catch-or-return,promise/always-return\n    $('#allgroupstable').DataTable({\n        dom: 'lrtip',\n        language: {\n            url: url\n        },\n        initComplete: function() {\n            const table = this.api();\n\n            datatablesHelpers.setupSearchRules('.js-group-filter--search', table);\n            datatablesHelpers.addRedrawEvent('.js-group-filter', table);\n            datatablesHelpers.makeTablesFullWidth();\n            datatablesHelpers.initOrSearch('.js-group-filter--or-search', table);\n\n            // trigger onchange event for course name filter upon page load in case we prefilter by course name\n            var theinput = document.querySelector('input[data-target=\"course\"]');\n            theinput.dispatchEvent(new Event('change'));\n        },\n    });\n\n};\n\nconst attachEvents = () => {\n    const body = $('body');\n    $('.grouprow').click(handleTableRowClick);\n\n    body.on('click', '#mentor-deletemyquestion-modal-close', () => $('.modal').remove());\n\n    body.on('click', '.js-leave-group', handleGroupLeaveButton);\n    body.on('click', '.js-request-join-group', handleGroupRequestButton);\n    body.on('click', '.js-invite-member', handleGroupInviteButton);\n};\n\nconst handleTableRowClick = async function(e) {\n    e.preventDefault();\n\n    const groupid = $(this).data('gid');\n    const groupname = $(this).data('title');\n\n    const groupDetailsPromise = promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\n        action: 'getgroupdetails',\n        groupid: groupid\n    });\n    const titlePromise = str.get_string('modal-groupdetails-groupname', 'local_learningcompanions', groupname);\n\n    const [{html}, title] = await Promise.all([groupDetailsPromise, titlePromise]);\n\n    const modal = await ModalFactory.create({\n        title: title,\n        body: html,\n        footer: '',\n        large: true\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, function() {\n        modal.destroy();\n    });\n    modal.show();\n};\n\nexport const handleGroupInviteButton = async function(e) {\n    e.preventDefault();\n\n    const groupId = $(this).data('groupid');\n\n    const templatePromise = Templates.renderForPromise('local_learningcompanions/group/group_invite', {\n        groupId\n    });\n    const titlePromise = str.get_string('group_invite_title', 'local_learningcompanions');\n\n    const [{html}, title] = await Promise.all([templatePromise, titlePromise]);\n\n    const modal = await ModalFactory.create({\n        title: title,\n        body: html,\n        footer: '',\n        large: false\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, function() {\n        modal.destroy();\n    });\n    modal.show();\n\n    inviteInit();\n};\n\nexport const handleGroupLeaveButton = async function(e) {\n    e.preventDefault();\n\n    const groupId = $(this).data('groupid');\n\n    /**\n     * @type {{needsNewAdmin: ?bool, leaved: bool, isLastMember: ?bool}}\n     */\n    const response = await promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\n        action: 'leavegroup',\n        groupid: groupId\n    });\n\n    if (response.needsNewAdmin) {\n        const possibleNewAdminsBodyPromise = promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\n            action: 'getpossiblenewadmins',\n            groupid: groupId\n        });\n        const titlePromise = str.get_string('modal-groupdetails-needsnewadmin', 'local_learningcompanions');\n\n        const [possibleNewAdminsBody, title] = await Promise.all([possibleNewAdminsBodyPromise, titlePromise]);\n\n        const modal = await ModalFactory.create({\n            title: title,\n            body: possibleNewAdminsBody,\n            footer: '',\n            large: false\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n        modal.show();\n\n        const newAdminForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_learningcompanions\\\\forms\\\\assign_new_admin_while_leaving_form');\n        newAdminForm.load({groupId: groupId});\n        newAdminForm.addEventListener(newAdminForm.events.FORM_SUBMITTED, () => {\n            window.location.reload();\n        });\n    }\n\n    if (response.isLastMember) {\n        const templatePromise = Templates.renderForPromise('local_learningcompanions/group/group_modal_confirm_leave', {});\n        const titlePromise = str.get_string('modal-groupdetails-leavetitle', 'local_learningcompanions');\n\n        const [{html}, title] = await Promise.all([templatePromise, titlePromise]);\n\n        const modal = await ModalFactory.create({\n            title: title,\n            body: html,\n            footer: '',\n            large: false\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n        modal.show();\n\n        const confirmLeaveForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_learningcompanions\\\\forms\\\\last_user_leaves_closed_group_form');\n        confirmLeaveForm.load({groupId: groupId});\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_SUBMITTED, () => {\n            window.location.reload();\n        });\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_CANCELLED, () => {\n            modal.destroy();\n        });\n    }\n\n    if (response.leaved) {\n        window.location.reload();\n    }\n};\n\nexport const handleGroupRequestButton = async function(e) {\n    e.preventDefault();\n\n    const errorCode = await promiseAjax(M.cfg.wwwroot + '/local/learningcompanions/ajax/ajax.php', {\n        action: 'requestgroupjoin',\n        groupid: $(this).data('groupid')\n    });\n\n    if (!errorCode) { // All good\n        window.location.reload();\n    } else { // Error happened\n        const errorMessage = await str.get_string(`group_request_error_code_${errorCode}`, 'local_learningcompanions');\n        alert(errorMessage);\n    }\n};\n"],"names":["select2","setupDatatables","attachEvents","datatablesHelpers","initMinSearch","initIncludeSearch","str","get_string","url","DataTable","dom","language","initComplete","table","this","api","setupSearchRules","addRedrawEvent","makeTablesFullWidth","initOrSearch","document","querySelector","dispatchEvent","Event","body","click","handleTableRowClick","on","remove","handleGroupLeaveButton","handleGroupRequestButton","handleGroupInviteButton","e","preventDefault","groupid","data","groupname","groupDetailsPromise","M","cfg","wwwroot","action","titlePromise","Promise","all","html","title","ModalFactory","create","footer","large","modal","getRoot","ModalEvents","hidden","destroy","show","groupId","templatePromise","Templates","renderForPromise","response","needsNewAdmin","possibleNewAdminsBodyPromise","possibleNewAdminsBody","newAdminForm","DynamicForm","load","addEventListener","events","FORM_SUBMITTED","window","location","reload","isLastMember","confirmLeaveForm","FORM_CANCELLED","leaved","errorCode","errorMessage","alert"],"mappings":"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"}