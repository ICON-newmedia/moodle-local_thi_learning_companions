{"version":3,"file":"group.min.js","sources":["../src/group.js"],"sourcesContent":["/* eslint-disable no-console, max-len */\nimport $ from 'jquery';\nimport * as str from 'core/str';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport * as datatablesHelpers from 'local_thi_learning_companions/datatables-helpers';\nimport {promiseAjax} from \"local_thi_learning_companions/ajax\";\n// Import 'local_thi_learning_companions/jquery.dataTables';\nimport 'local_thi_learning_companions/datatables';\nimport 'local_thi_learning_companions/select2';\nimport DynamicForm from 'core_form/dynamicform';\nimport Templates from 'core/templates';\nimport {init as inviteInit} from 'local_thi_learning_companions/invite_members';\nimport Fragment from \"core/fragment\";\nimport Pending from \"core/pending\";\nimport * as Str from \"core/str\";\nimport * as Notification from \"core/notification\";\nimport * as Autocomplete from \"core/form-autocomplete\";\n\nexport const select2 = () => {\n    $('.select2').select2();\n};\n\nexport const init = () => {\n    setupDatatables();\n    attachEvents();\n};\n\nconst setupDatatables = async() => {\n    datatablesHelpers.initMinSearch('.js-group-filter--min');\n    datatablesHelpers.initIncludeSearch('.js-group-filter--includes');\n\n    const url = await str.get_string('datatables_url', 'local_thi_learning_companions');\n\n\n    $('#allgroupstable').DataTable({\n        dom: 'lrtip',\n        language: {\n            url: url\n        },\n        initComplete: function() {\n            const table = this.api();\n\n            datatablesHelpers.setupSearchRules('.js-group-filter--search', table);\n            datatablesHelpers.addRedrawEvent('.js-group-filter', table);\n            datatablesHelpers.makeTablesFullWidth();\n            datatablesHelpers.initOrSearch('.js-group-filter--or-search', table);\n\n            // Trigger onchange event for course name filter upon page load in case we prefilter by course name\n            var theinput = document.querySelector('input[data-target=\"course\"]');\n            theinput.dispatchEvent(new Event('change'));\n        },\n    });\n\n};\n\nconst attachEvents = () => {\n    const body = $('body');\n    $('.grouprow').click(handleTableRowClick);\n\n    body.on('click', '#mentor-deletemyquestion-modal-close', () => $('.modal').remove());\n\n    body.on('click', '.js-leave-group', handleGroupLeaveButton);\n    body.on('click', '.js-request-join-group', handleGroupRequestButton);\n    body.on('click', '.js-invite-member', handleGroupInviteButton);\n};\n\nconst handleTableRowClick = async function(e) {\n    e.preventDefault();\n\n    const groupid = $(this).data('gid');\n    const groupname = $(this).data('title');\n\n    const groupDetailsPromise = promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\n        action: 'getgroupdetails',\n        groupid: groupid,\n        'referrer': 'groupsearch',\n        sesskey: M.cfg.sesskey\n    });\n    const titlePromise = str.get_string('modal-groupdetails-groupname', 'local_thi_learning_companions', groupname);\n\n    const [{html}, title] = await Promise.all([groupDetailsPromise, titlePromise]);\n\n    const modal = await ModalFactory.create({\n        title: title,\n        body: html,\n        footer: '',\n        large: true\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, function() {\n        modal.destroy();\n    });\n    modal.show();\n};\n\nexport const handleGroupInviteButton = async function(e) {\n    e.preventDefault();\n    const pendingPromise = new Pending('local_thi_learning_companions/group:handleGroupInviteButton');\n    const groupId = $(this).data('groupid');\n\n    const templatePromise = Fragment.loadFragment('local_thi_learning_companions', 'invitation_form', groupId, {});\n    const stringsPromise = str.get_strings([\n        {key: 'group_invite_title', component: 'local_thi_learning_companions'},\n        {key: 'group_invite_placeholder', component: 'local_thi_learning_companions'},\n        {key: 'group_invite_noselection', component: 'local_thi_learning_companions'},\n    ]);\n\n    const [template, strings] = await Promise.all([templatePromise, stringsPromise]);\n\n    const modal = await ModalFactory.create({\n        title: strings[0],\n        body: template,\n        footer: '',\n        large: false\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, function() {\n        modal.destroy();\n    });\n    modal.show();\n    $('#id_cancel').on('click', function(e) {\n        e.preventDefault();\n        modal.destroy();\n        return false;\n    });\n    Autocomplete.enhance(\"#id_userlist\", true, 'local_thi_learning_companions/invitation_potential_user_selector', strings[1],\n        false, true, strings[2], true);\n    Promise.all([modal, modal.getBodyPromise()])\n        .then(([modal, body]) => {\n          console.log('modal:', modal, 'body:', body);\n\n            return modal;\n        })\n        .then(modal => {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch (Notification.exception);\n};\n\nexport const handleGroupLeaveButton = async function(e) {\n    e.preventDefault();\n\n    const groupId = $(this).data('groupid');\n\n    /**\n     * @type {{needsNewAdmin: ?bool, leaved: bool, isLastMember: ?bool}}\n     */\n    const response = await promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\n        action: 'leavegroup',\n        groupid: groupId,\n        sesskey: M.cfg.sesskey\n    });\n\n    if (response.needsNewAdmin) {\n        const possibleNewAdminsBodyPromise = promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\n            action: 'getpossiblenewadmins',\n            groupid: groupId,\n            sesskey: M.cfg.sesskey\n        });\n        const titlePromise = str.get_string('modal-groupdetails-needsnewadmin', 'local_thi_learning_companions');\n\n        const [possibleNewAdminsBody, title] = await Promise.all([possibleNewAdminsBodyPromise, titlePromise]);\n\n        const modal = await ModalFactory.create({\n            title: title,\n            body: possibleNewAdminsBody,\n            footer: '',\n            large: false\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n        modal.show();\n\n        const newAdminForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_thi_learning_companions\\\\forms\\\\assign_new_admin_while_leaving_form');\n        newAdminForm.load({groupId: groupId});\n        newAdminForm.addEventListener(newAdminForm.events.FORM_SUBMITTED, () => {\n            window.location.reload();\n        });\n    }\n\n    if (response.isLastMember) {\n        const templatePromise = Templates.renderForPromise('local_thi_learning_companions/group/group_modal_confirm_leave', {});\n        const titlePromise = str.get_string('modal-groupdetails-leavetitle', 'local_thi_learning_companions');\n\n        const [{html}, title] = await Promise.all([templatePromise, titlePromise]);\n\n        const modal = await ModalFactory.create({\n            title: title,\n            body: html,\n            footer: '',\n            large: false\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n        modal.show();\n\n        const confirmLeaveForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_thi_learning_companions\\\\forms\\\\last_user_leaves_closed_group_form');\n        confirmLeaveForm.load({groupId: groupId});\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_SUBMITTED, () => {\n            window.location.reload();\n        });\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_CANCELLED, () => {\n            modal.destroy();\n        });\n    }\n\n    if (response.leaved) {\n        window.location.reload();\n    }\n};\n\nexport const handleGroupRequestButton = async function(e) {\n    e.preventDefault();\n\n    const errorCode = await promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\n        action: 'requestgroupjoin',\n        groupid: $(this).data('groupid'),\n        sesskey: M.cfg.sesskey\n    });\n\n    if (!errorCode) { // All good\n        window.location.reload();\n    } else { // Error happened\n        const errorMessage = await str.get_string(`group_request_error_code_${errorCode}`, 'local_thi_learning_companions');\n        alert(errorMessage);\n    }\n};\n"],"names":["select2","setupDatatables","attachEvents","async","datatablesHelpers","initMinSearch","initIncludeSearch","url","str","get_string","DataTable","dom","language","initComplete","table","this","api","setupSearchRules","addRedrawEvent","makeTablesFullWidth","initOrSearch","document","querySelector","dispatchEvent","Event","body","click","handleTableRowClick","on","remove","handleGroupLeaveButton","handleGroupRequestButton","handleGroupInviteButton","e","preventDefault","groupid","data","groupname","groupDetailsPromise","M","cfg","wwwroot","action","sesskey","titlePromise","html","title","Promise","all","modal","ModalFactory","create","footer","large","getRoot","ModalEvents","hidden","destroy","show","pendingPromise","Pending","groupId","templatePromise","Fragment","loadFragment","stringsPromise","get_strings","key","component","template","strings","Autocomplete","enhance","getBodyPromise","then","_ref","console","log","resolve","catch","Notification","exception","response","needsNewAdmin","possibleNewAdminsBodyPromise","possibleNewAdminsBody","newAdminForm","DynamicForm","load","addEventListener","events","FORM_SUBMITTED","window","location","reload","isLastMember","Templates","renderForPromise","confirmLeaveForm","FORM_CANCELLED","leaved","errorCode","errorMessage","alert"],"mappings":"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"}