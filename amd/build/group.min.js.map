{"version":3,"file":"group.min.js","sources":["../src/group.js"],"sourcesContent":["/* eslint-disable jsdoc/require-jsdoc, no-console, max-len */\r\nimport $ from 'jquery';\r\nimport * as str from 'core/str';\r\nimport * as ModalFactory from 'core/modal_factory';\r\nimport * as ModalEvents from 'core/modal_events';\r\nimport * as datatablesHelpers from 'local_thi_learning_companions/datatables-helpers';\r\nimport {promiseAjax} from \"local_thi_learning_companions/ajax\";\r\n// import 'local_thi_learning_companions/jquery.dataTables';\r\nimport 'local_thi_learning_companions/datatables';\r\nimport 'local_thi_learning_companions/select2';\r\nimport DynamicForm from 'core_form/dynamicform';\r\nimport Templates from 'core/templates';\r\nimport {init as inviteInit} from 'local_thi_learning_companions/invite_members';\r\nimport Fragment from \"core/fragment\";\r\nimport Pending from \"core/pending\";\r\nimport * as Str from \"core/str\";\r\nimport * as Notification from \"core/notification\";\r\nimport * as Autocomplete from \"core/form-autocomplete\";\r\n\r\nexport const select2 = () => {\r\n    $('.select2').select2();\r\n};\r\n\r\nexport const init = () => {\r\n    setupDatatables();\r\n    attachEvents();\r\n};\r\n\r\nconst setupDatatables = async() => {\r\n    datatablesHelpers.initMinSearch('.js-group-filter--min');\r\n    datatablesHelpers.initIncludeSearch('.js-group-filter--includes');\r\n\r\n    const url = await str.get_string('datatables_url', 'local_thi_learning_companions');\r\n\r\n    // eslint-disable-next-line promise/catch-or-return,promise/always-return\r\n    $('#allgroupstable').DataTable({\r\n        dom: 'lrtip',\r\n        language: {\r\n            url: url\r\n        },\r\n        initComplete: function() {\r\n            const table = this.api();\r\n\r\n            datatablesHelpers.setupSearchRules('.js-group-filter--search', table);\r\n            datatablesHelpers.addRedrawEvent('.js-group-filter', table);\r\n            datatablesHelpers.makeTablesFullWidth();\r\n            datatablesHelpers.initOrSearch('.js-group-filter--or-search', table);\r\n\r\n            // trigger onchange event for course name filter upon page load in case we prefilter by course name\r\n            var theinput = document.querySelector('input[data-target=\"course\"]');\r\n            theinput.dispatchEvent(new Event('change'));\r\n        },\r\n    });\r\n\r\n};\r\n\r\nconst attachEvents = () => {\r\n    const body = $('body');\r\n    $('.grouprow').click(handleTableRowClick);\r\n\r\n    body.on('click', '#mentor-deletemyquestion-modal-close', () => $('.modal').remove());\r\n\r\n    body.on('click', '.js-leave-group', handleGroupLeaveButton);\r\n    body.on('click', '.js-request-join-group', handleGroupRequestButton);\r\n    body.on('click', '.js-invite-member', handleGroupInviteButton);\r\n};\r\n\r\nconst handleTableRowClick = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const groupid = $(this).data('gid');\r\n    const groupname = $(this).data('title');\r\n\r\n    const groupDetailsPromise = promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\r\n        action: 'getgroupdetails',\r\n        groupid: groupid,\r\n        'referrer': 'groupsearch'\r\n    });\r\n    const titlePromise = str.get_string('modal-groupdetails-groupname', 'local_thi_learning_companions', groupname);\r\n\r\n    const [{html}, title] = await Promise.all([groupDetailsPromise, titlePromise]);\r\n\r\n    const modal = await ModalFactory.create({\r\n        title: title,\r\n        body: html,\r\n        footer: '',\r\n        large: true\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.hidden, function() {\r\n        modal.destroy();\r\n    });\r\n    modal.show();\r\n};\r\n\r\nexport const handleGroupInviteButton = async function(e) {\r\n    e.preventDefault();\r\n    const pendingPromise = new Pending('local_thi_learning_companions/group:handleGroupInviteButton');\r\n    const groupId = $(this).data('groupid');\r\n\r\n    const templatePromise = Fragment.loadFragment('local_thi_learning_companions', 'invitation_form', groupId, {});\r\n    const stringsPromise = str.get_strings([\r\n        {key: 'group_invite_title', component: 'local_thi_learning_companions'},\r\n        {key: 'group_invite_placeholder', component: 'local_thi_learning_companions'},\r\n        {key: 'group_invite_noselection', component: 'local_thi_learning_companions'},\r\n    ]);\r\n\r\n    const [template, strings] = await Promise.all([templatePromise, stringsPromise]);\r\n\r\n    const modal = await ModalFactory.create({\r\n        title: strings[0],\r\n        body: template,\r\n        footer: '',\r\n        large: false\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.hidden, function() {\r\n        modal.destroy();\r\n    });\r\n    modal.show();\r\n    $('#id_cancel').on('click', function(e){\r\n        e.preventDefault();\r\n        modal.destroy();\r\n        return false;\r\n    });\r\n    Autocomplete.enhance(\"#id_userlist\", true, 'local_thi_learning_companions/invitation_potential_user_selector', strings[1],\r\n        false, true, strings[2], true);\r\n    Promise.all([modal, modal.getBodyPromise()])\r\n        .then(([modal, body]) => {\r\n          console.log('modal:', modal, 'body:', body);\r\n\r\n            return modal;\r\n        })\r\n        .then(modal => {\r\n            pendingPromise.resolve();\r\n\r\n            return modal;\r\n        })\r\n        .catch(Notification.exception);\r\n};\r\n\r\nexport const handleGroupLeaveButton = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const groupId = $(this).data('groupid');\r\n\r\n    /**\r\n     * @type {{needsNewAdmin: ?bool, leaved: bool, isLastMember: ?bool}}\r\n     */\r\n    const response = await promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\r\n        action: 'leavegroup',\r\n        groupid: groupId\r\n    });\r\n\r\n    if (response.needsNewAdmin) {\r\n        const possibleNewAdminsBodyPromise = promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\r\n            action: 'getpossiblenewadmins',\r\n            groupid: groupId\r\n        });\r\n        const titlePromise = str.get_string('modal-groupdetails-needsnewadmin', 'local_thi_learning_companions');\r\n\r\n        const [possibleNewAdminsBody, title] = await Promise.all([possibleNewAdminsBodyPromise, titlePromise]);\r\n\r\n        const modal = await ModalFactory.create({\r\n            title: title,\r\n            body: possibleNewAdminsBody,\r\n            footer: '',\r\n            large: false\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.hidden, function() {\r\n            modal.destroy();\r\n        });\r\n        modal.show();\r\n\r\n        const newAdminForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_thi_learning_companions\\\\forms\\\\assign_new_admin_while_leaving_form');\r\n        newAdminForm.load({groupId: groupId});\r\n        newAdminForm.addEventListener(newAdminForm.events.FORM_SUBMITTED, () => {\r\n            window.location.reload();\r\n        });\r\n    }\r\n\r\n    if (response.isLastMember) {\r\n        const templatePromise = Templates.renderForPromise('local_thi_learning_companions/group/group_modal_confirm_leave', {});\r\n        const titlePromise = str.get_string('modal-groupdetails-leavetitle', 'local_thi_learning_companions');\r\n\r\n        const [{html}, title] = await Promise.all([templatePromise, titlePromise]);\r\n\r\n        const modal = await ModalFactory.create({\r\n            title: title,\r\n            body: html,\r\n            footer: '',\r\n            large: false\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.hidden, function() {\r\n            modal.destroy();\r\n        });\r\n        modal.show();\r\n\r\n        const confirmLeaveForm = new DynamicForm(document.querySelector('#formcontainer'), 'local_thi_learning_companions\\\\forms\\\\last_user_leaves_closed_group_form');\r\n        confirmLeaveForm.load({groupId: groupId});\r\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_SUBMITTED, () => {\r\n            window.location.reload();\r\n        });\r\n        confirmLeaveForm.addEventListener(confirmLeaveForm.events.FORM_CANCELLED, () => {\r\n            modal.destroy();\r\n        });\r\n    }\r\n\r\n    if (response.leaved) {\r\n        window.location.reload();\r\n    }\r\n};\r\n\r\nexport const handleGroupRequestButton = async function(e) {\r\n    e.preventDefault();\r\n\r\n    const errorCode = await promiseAjax(M.cfg.wwwroot + '/local/thi_learning_companions/ajax/ajax.php', {\r\n        action: 'requestgroupjoin',\r\n        groupid: $(this).data('groupid')\r\n    });\r\n\r\n    if (!errorCode) { // All good\r\n        window.location.reload();\r\n    } else { // Error happened\r\n        const errorMessage = await str.get_string(`group_request_error_code_${errorCode}`, 'local_thi_learning_companions');\r\n        alert(errorMessage);\r\n    }\r\n};\r\n"],"names":["select2","setupDatatables","attachEvents","async","datatablesHelpers","initMinSearch","initIncludeSearch","url","str","get_string","DataTable","dom","language","initComplete","table","this","api","setupSearchRules","addRedrawEvent","makeTablesFullWidth","initOrSearch","document","querySelector","dispatchEvent","Event","body","click","handleTableRowClick","on","remove","handleGroupLeaveButton","handleGroupRequestButton","handleGroupInviteButton","e","preventDefault","groupid","data","groupname","groupDetailsPromise","M","cfg","wwwroot","action","titlePromise","html","title","Promise","all","modal","ModalFactory","create","footer","large","getRoot","ModalEvents","hidden","destroy","show","pendingPromise","Pending","groupId","templatePromise","Fragment","loadFragment","stringsPromise","get_strings","key","component","template","strings","Autocomplete","enhance","getBodyPromise","then","_ref","console","log","resolve","catch","Notification","exception","response","needsNewAdmin","possibleNewAdminsBodyPromise","possibleNewAdminsBody","newAdminForm","DynamicForm","load","addEventListener","events","FORM_SUBMITTED","window","location","reload","isLastMember","Templates","renderForPromise","confirmLeaveForm","FORM_CANCELLED","leaved","errorCode","errorMessage","alert"],"mappings":"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"}