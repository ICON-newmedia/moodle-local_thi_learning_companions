function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("local_learningcompanions/learningcompanions_chat",["exports","jquery","core/str","core/modal_factory","core/modal_events","local_learningcompanions/group"],(function(_exports,_jquery,str,ModalFactory,ModalEvents,_group){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj},str=_interopRequireWildcard(str),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents);var _ref,strings=[],init=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var sendButton,stringsObj,body;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:sendButton=(0,_jquery.default)("#local_learningcompanions_chat-send"),(0,_jquery.default)("#id_messageeditable").after(sendButton),sendButton.on("click",handleNewMessageSubmit),addBBBlinkButton(),addUploadButton(),stringsObj=[{key:"modal-deletecomment-title",component:"local_learningcompanions"},{key:"modal-deletecomment-text",component:"local_learningcompanions"},{key:"modal-deletecomment-okaybutton",component:"local_learningcompanions"},{key:"modal-editcomment-title",component:"local_learningcompanions"},{key:"modal-editcomment-okaybutton",component:"local_learningcompanions"},{key:"modal-reportcomment-title",component:"local_learningcompanions"},{key:"modal-reportcomment-text",component:"local_learningcompanions"},{key:"modal-reportcomment-okaybutton",component:"local_learningcompanions"}],str.get_strings(stringsObj).then((function(results){return strings=results})),(body=(0,_jquery.default)("body")).on("click",".learningcompanions_delete_comment",handleCommentDelete),body.on("click",".learningcompanions_edit_comment",handleCommentEdit),body.on("click",".learningcompanions_report_comment",handleCommentReport),body.on("click",".learningcompanions_rate_comment",handleCommentRating),body.on("click",".learningcompanions_editgroup",handleEditGroup),body.on("click",".js-leave-group",_group.handleGroupLeaveButton),body.on("click",".js-request-join-group",_group.handleGroupRequestButton),body.on("click",".js-invite-member",_group.handleGroupInviteButton),body.on("click",".learningcompanions_bbb_button",handleBBBButton),body.on("click",".learningcompanions_upload_button",handleUploadButton),document.querySelector("#page-local-learningcompanions-chat #fitem_id_attachments"),document.body.addEventListener("dragenter",(function(e){document.querySelector("#page-local-learningcompanions-chat #fitem_id_attachments").classList.add("upload-visible")}));case 21:case"end":return _context.stop()}}),_callee)}))),function(){return _ref.apply(this,arguments)});_exports.init=init;var _ref2,_ref3,_ref4,_ref5,addBBBlinkButton=function(){str.get_string("bigbluebutton_title","local_learningcompanions").then((function(title){if((0,_jquery.default)(".atto_editor_row").length>0)var appendTo="#page-local-learningcompanions-chat .atto_toolbar_row:first-child";else appendTo="#page-local-learningcompanions-chat .editor_atto_toolbar";(0,_jquery.default)().add('<div class="atto_group accessibility_group"><button class="learningcompanions_bbb_button" title="'+title+'")>BigBlueButton</button></div>').appendTo(appendTo)}))},addUploadButton=function(){str.get_string("upload_title","local_learningcompanions").then((function(title){if((0,_jquery.default)(".atto_editor_row").length>0)var appendTo="#page-local-learningcompanions-chat .atto_toolbar_row:first-child";else appendTo="#page-local-learningcompanions-chat .editor_atto_toolbar";(0,_jquery.default)().add('<div class="atto_group accessibility_group"><button class="learningcompanions_upload_button" title="'+title+'"><i class="fa fa-upload"></i></button></div>').appendTo(appendTo)}))},handleBBBButton=function(e){e.preventDefault();for(var sel=window.getSelection(),messageEditorSelected=!1,messageEditor=document.getElementById("id_messageeditable");sel=sel.parentNode;)if("id_messageeditable"===sel.id){messageEditorSelected=!0;break}if(!messageEditorSelected){document.getSelection().removeAllRanges(),messageEditor.focus();var range=new Range,childElementCount=messageEditor.childElementCount;range.setStartAfter(messageEditor.children[childElementCount-1]),document.getSelection().addRange(range)}var string=str.get_string("bigbluebutton_join_text","local_learningcompanions"),chatid=(0,_jquery.default)('.chat-post-form input[name="chatid"]').val(),bbbURLs=_jquery.default.ajax(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax_videocall.php",{data:{chatid:chatid}});return Promise.all([string,bbbURLs]).then((function(data){var urls=data[1];window.open(urls.moderator,"_blank"),pasteHtmlAtCaret(' <a target="_blank" href="'+urls.participants+'">'+data[0]+"</a>")})),!1},handleUploadButton=function(e){e.preventDefault();var uploadfield=document.querySelector("#page-local-learningcompanions-chat #fitem_id_attachments"),target=e.target;"I"==target.tagName&&(target=target.parentElement),uploadfield.classList.contains("upload-visible")?(uploadfield.classList.remove("upload-visible"),target.classList.remove("highlight")):(uploadfield.classList.add("upload-visible"),target.classList.add("highlight"))},pasteHtmlAtCaret=function(html){var sel,range;if(window.getSelection){if((sel=window.getSelection()).getRangeAt&&sel.rangeCount){(range=sel.getRangeAt(0)).deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&((range=range.cloneRange()).setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(html)},handleCommentRating=function(e){var postId=+e.target.dataset.id;_jquery.default.ajax({url:M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax_ratecomment.php",method:"POST",dataType:"json",data:{commentid:postId},success:function(data){document.dispatchEvent(new CustomEvent("learningcompanions_message_rated",{detail:{postid:postId,newvalue:data.israted}}))}})},handleCommentDelete=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(e){var postId,modal;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return postId=+e.target.dataset.id,_context2.next=3,ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:'<div id="learningcompanions-deletecomment-modal"><div id="learningcompanions-deletecomment-modal-text">'+strings[1]+"</div></div>"});case 3:(modal=_context2.sent).getRoot().on(ModalEvents.save,(function(){_jquery.default.ajax({url:M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxdeletecomment.php",method:"POST",dataType:"json",data:{commentid:postId},success:function(data){document.dispatchEvent(new CustomEvent("learningcompanions_message_deleted",{detail:{postid:postId}}))}})})),modal.setSaveButtonText(strings[2]),modal.show();case 7:case"end":return _context2.stop()}}),_callee2)}))),function(_x){return _ref2.apply(this,arguments)}),handleCommentEdit=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(e){var commentid;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return commentid=e.target.dataset.id,_context3.abrupt("return",ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[3],body:'<div id="learningcompanions-edit-modal"><div id="learningcompanions-edit-modal-text">'+strings[4]+"</div></div>"}).then((function(modal){modal.setSaveButtonText(strings[5]),_jquery.default.ajax({url:M.cfg.wwwroot+"/local/learningcompanions/editcomment.php",method:"POST",dataType:"json",data:{commentid:commentid}}).done((function(a,b,c){modal.setText(a.text)})),modal.show()})));case 2:case"end":return _context3.stop()}}),_callee3)}))),function(_x2){return _ref3.apply(this,arguments)}),handleCommentReport=(_ref4=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(e){var postId;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return postId=+e.target.dataset.id,_context4.abrupt("return",ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[5],body:'<div id="learningcompanions-reportcomment-modal"><div id="learningcompanions-reportcomment-modal-text">'+strings[6]+"</div></div>"}).then((function(modal){modal.getRoot().on(ModalEvents.save,(function(){_jquery.default.ajax({url:"".concat(M.cfg.wwwroot,"/local/learningcompanions/ajax/ajaxreport.php"),method:"POST",dataType:"json",data:{commentid:postId},success:function(data){document.dispatchEvent(new CustomEvent("learningcompanions_message_reported",{detail:{postid:postId}}))}})})),modal.setSaveButtonText(strings[7]),modal.show()})));case 2:case"end":return _context4.stop()}}),_callee4)}))),function(_x3){return _ref4.apply(this,arguments)}),handleEditGroup=(_ref5=_asyncToGenerator(regeneratorRuntime.mark((function _callee6(e){var callGroupModal,_callGroupModal;return regeneratorRuntime.wrap((function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:_callGroupModal=function(){return _callGroupModal=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(e){var groupid,groupname;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:e.preventDefault(),groupid=e.target.dataset.gid,groupname=e.target.dataset.title,_jquery.default.ajax({url:M.cfg.wwwroot+"/local/learningcompanions/ajax/ajax.php",method:"POST",dataType:"json",data:{action:"getgroupdetails",groupid:groupid,referrer:"chat"},success:function(data){str.get_string("modal-groupdetails-groupname","local_learningcompanions",groupname).then((function(string){ModalFactory.create({title:string,body:data.html,footer:"",large:!0,type:ModalFactory.types.CANCEL}).then((function(modal){modal.show()}))}))}});case 4:case"end":return _context5.stop()}}),_callee5)}))),_callGroupModal.apply(this,arguments)},callGroupModal=function(_x5){return _callGroupModal.apply(this,arguments)},callGroupModal(e).then((function(){console.log("called modal for group details. What now?")}));case 3:case"end":return _context6.stop()}}),_callee6)}))),function(_x4){return _ref5.apply(this,arguments)}),handleNewMessageSubmit=function(e){if(!0!==e.target.getAttribute("disabled")){e.preventDefault();var data={};return(0,_jquery.default)("#learningcompanions_chat form input, #learningcompanions_chat form textarea").each((function(index,el){data[el.name]=el.value})),(0,_jquery.default)("#learningcompanions_chat #id_messageeditable").css("opacity","0.5"),(0,_jquery.default)("#learningcompanions_chat #id_messageeditable").attr("contenteditable","false"),(0,_jquery.default)("#learningcompanions_chat form input,  #learningcompanions_chat form textarea, #local_learningcompanions_chat-send").attr("disabled",!0),_jquery.default.post(M.cfg.wwwroot+"/local/learningcompanions/ajax/ajaxsubmit.php",data).done((function(a,b,c){a.warning_body&&(console.log("output warning"),ModalFactory.create({title:a.warning_title,body:a.warning_body,footer:"",large:!1,type:ModalFactory.types.ALERT}).then((function(modal){modal.show()}))),(0,_jquery.default)("#learningcompanions_chat form #id_messageeditable").text(""),(0,_jquery.default)("#learningcompanions_chat form input, #learningcompanions_chat form textarea").each((function(index,el){"textarea"!=el.name&&"hidden"===el.type||(el.value="")})),(0,_jquery.default)("input[type=hidden][name=message\\[itemid\\]]").val(a.itemid);var clientId=Object.keys(window.M.core_filepicker.instances).pop();clientId&&(window.M.core_filepicker.instances[clientId].options.itemid=a.itemid),document.dispatchEvent(new CustomEvent("learningcompanions_message_send"))})).fail((function(a,b,c){console.warn("Failed sending via AJAX",a,b,c),window.alert("couldn't save")})).always((function(a,b,c){(0,_jquery.default)("#learningcompanions_chat #id_messageeditable").css("opacity","1"),(0,_jquery.default)("#learningcompanions_chat #id_messageeditable").attr("contenteditable","true"),(0,_jquery.default)("#learningcompanions_chat form input,  #learningcompanions_chat form textarea, #local_learningcompanions_chat-send").attr("disabled",!1)})),!1}}}));

//# sourceMappingURL=learningcompanions_chat.min.js.map