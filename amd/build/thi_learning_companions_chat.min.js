define("local_thi_learning_companions/thi_learning_companions_chat",["exports","jquery","core/str","core/modal_factory","core/modal_events","local_thi_learning_companions/group"],(function(_exports,_jquery,str,ModalFactory,ModalEvents,_group){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj},str=_interopRequireWildcard(str),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents);let strings=[];_exports.init=async()=>{const sendButton=(0,_jquery.default)("#local_thi_learning_companions_chat-send");(0,_jquery.default)("#id_messageeditable").after(sendButton),sendButton.on("click",handleNewMessageSubmit),addBBBlinkButton(),addUploadButton();str.get_strings([{key:"modal-deletecomment-title",component:"local_thi_learning_companions"},{key:"modal-deletecomment-text",component:"local_thi_learning_companions"},{key:"modal-deletecomment-okaybutton",component:"local_thi_learning_companions"},{key:"modal-editcomment-title",component:"local_thi_learning_companions"},{key:"modal-editcomment-okaybutton",component:"local_thi_learning_companions"},{key:"modal-reportcomment-title",component:"local_thi_learning_companions"},{key:"modal-reportcomment-text",component:"local_thi_learning_companions"},{key:"modal-reportcomment-okaybutton",component:"local_thi_learning_companions"}]).then((results=>strings=results));const body=(0,_jquery.default)("body");body.on("click",".thi_learning_companions_delete_comment",handleCommentDelete),body.on("click",".thi_learning_companions_edit_comment",handleCommentEdit),body.on("click",".thi_learning_companions_report_comment",handleCommentReport),body.on("click",".thi_learning_companions_rate_comment",handleCommentRating),body.on("click",".thi_learning_companions_editgroup",handleEditGroup),body.on("click",".js-leave-group",_group.handleGroupLeaveButton),body.on("click",".js-request-join-group",_group.handleGroupRequestButton),body.on("click",".js-invite-member",_group.handleGroupInviteButton),body.on("click",".thi_learning_companions_bbb_button",handleBBBButton),body.on("click",".thi_learning_companions_upload_button",handleUploadButton);document.querySelector("#page-local-thi_learning_companions-chat #fitem_id_attachments");document.body.addEventListener("dragenter",(function(e){document.querySelector("#page-local-thi_learning_companions-chat #fitem_id_attachments").classList.add("upload-visible")}))};const addBBBlinkButton=function(){str.get_string("bigbluebutton_title","local_thi_learning_companions").then((title=>{if((0,_jquery.default)(".atto_editor_row").length>0)var appendTo="#page-local-thi_learning_companions-chat .atto_toolbar_row:first-child";else appendTo="#page-local-thi_learning_companions-chat .editor_atto_toolbar";(0,_jquery.default)().add('<div class="atto_group accessibility_group"><button class="thi_learning_companions_bbb_button" title="'+title+'")>BigBlueButton</button></div>').appendTo(appendTo)}))},addUploadButton=function(){str.get_string("upload_title","local_thi_learning_companions").then((title=>{if((0,_jquery.default)(".atto_editor_row").length>0)var appendTo="#page-local-thi_learning_companions-chat .atto_toolbar_row:first-child";else appendTo="#page-local-thi_learning_companions-chat .editor_atto_toolbar";(0,_jquery.default)().add('<div class="atto_group accessibility_group"><button class="thi_learning_companions_upload_button" title="'+title+'"><i class="fa fa-upload"></i></button></div>').appendTo(appendTo)}))},handleBBBButton=function(e){e.preventDefault();var sel=window.getSelection();let messageEditorSelected=!1;const messageEditor=document.getElementById("id_messageeditable");for(;sel=sel.parentNode;)if("id_messageeditable"===sel.id){messageEditorSelected=!0;break}if(!messageEditorSelected){document.getSelection().removeAllRanges(),messageEditor.focus();const range=new Range,childElementCount=messageEditor.childElementCount;let child=Math.max(childElementCount-1,0);range.setStartAfter(messageEditor.children[child]),document.getSelection().addRange(range)}var string=str.get_string("bigbluebutton_join_text","local_thi_learning_companions"),chatid=(0,_jquery.default)('.chat-post-form input[name="chatid"]').val(),bbbURLs=_jquery.default.ajax(M.cfg.wwwroot+"/local/thi_learning_companions/ajax/ajax_videocall.php",{data:{chatid:chatid}});return Promise.all([string,bbbURLs]).then((data=>{const urls=data[1];window.open(urls.moderator,"_blank"),pasteHtmlAtCaret(' <a target="_blank" href="'+urls.participants+'">'+data[0]+"</a>")})),!1},handleUploadButton=function(e){e.preventDefault();const uploadfield=document.querySelector("#page-local-thi_learning_companions-chat #fitem_id_attachments");let target=e.target;"I"==target.tagName&&(target=target.parentElement),uploadfield.classList.contains("upload-visible")?(uploadfield.classList.remove("upload-visible"),target.classList.remove("highlight")):(uploadfield.classList.add("upload-visible"),target.classList.add("highlight"))},pasteHtmlAtCaret=function(html){var sel,range;if(window.getSelection){if((sel=window.getSelection()).getRangeAt&&sel.rangeCount){(range=sel.getRangeAt(0)).deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&((range=range.cloneRange()).setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(html)},handleCommentRating=function(e){const postId=+e.target.dataset.id;_jquery.default.ajax({url:M.cfg.wwwroot+"/local/thi_learning_companions/ajax/ajax_ratecomment.php",method:"POST",dataType:"json",data:{commentid:postId},success:function(data){document.dispatchEvent(new CustomEvent("thi_learning_companions_message_rated",{detail:{postid:postId,newvalue:data.israted}}))}})},handleCommentDelete=async function(e){const postId=+e.target.dataset.id,modal=await ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:'<div id="thi_learning_companions-deletecomment-modal"><div id="thi_learning_companions-deletecomment-modal-text">'+strings[1]+"</div></div>"});modal.getRoot().on(ModalEvents.save,(function(){_jquery.default.ajax({url:M.cfg.wwwroot+"/local/thi_learning_companions/ajax/ajaxdeletecomment.php",method:"POST",dataType:"json",data:{commentid:postId,sesskey:M.cfg.sesskey},success:function(data){document.dispatchEvent(new CustomEvent("thi_learning_companions_message_deleted",{detail:{postid:postId}}))}})})),modal.setSaveButtonText(strings[2]),modal.show()},handleCommentEdit=async function(e){var commentid=e.target.dataset.id;return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[3],body:'<div id="thi_learning_companions-edit-modal"><div id="thi_learning_companions-edit-modal-text">'+strings[4]+"</div></div>"}).then((function(modal){modal.setSaveButtonText(strings[5]),_jquery.default.ajax({url:M.cfg.wwwroot+"/local/thi_learning_companions/editcomment.php",method:"POST",dataType:"json",data:{commentid:commentid}}).done((function(a,b,c){modal.setText(a.text)})),modal.show()}))},handleCommentReport=async function(e){const postId=+e.target.dataset.id;return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[5],body:'<div id="thi_learning_companions-reportcomment-modal"><div id="thi_learning_companions-reportcomment-modal-text">'+strings[6]+"</div></div>"}).then((function(modal){modal.getRoot().on(ModalEvents.save,(function(){_jquery.default.ajax({url:"".concat(M.cfg.wwwroot,"/local/thi_learning_companions/ajax/ajaxreport.php"),method:"POST",dataType:"json",data:{commentid:postId},success:function(data){document.dispatchEvent(new CustomEvent("thi_learning_companions_message_reported",{detail:{postid:postId}}))}})})),modal.setSaveButtonText(strings[7]),modal.show()}))},handleEditGroup=async function(e){(async function(e){e.preventDefault();const groupid=e.target.dataset.gid,groupname=e.target.dataset.title;_jquery.default.ajax({url:M.cfg.wwwroot+"/local/thi_learning_companions/ajax/ajax.php",method:"POST",dataType:"json",data:{action:"getgroupdetails",groupid:groupid,referrer:"chat",sesskey:M.cfg.sesskey},success:function(data){console.log("got group details modal with data: ",data);str.get_string("modal-groupdetails-groupname","local_thi_learning_companions",groupname).then((function(string){ModalFactory.create({title:string,body:data.html,footer:"",large:!0,type:ModalFactory.types.CANCEL}).then((modal=>{modal.show()}))}))}})})(e).then((()=>{console.log("called modal for group details. What now?")}))},handleNewMessageSubmit=e=>{if(!0===e.target.getAttribute("disabled"))return;e.preventDefault();const data={};return(0,_jquery.default)("#thi_learning_companions_chat form input, #thi_learning_companions_chat form textarea").each(((index,el)=>{data[el.name]=el.value})),(0,_jquery.default)("#thi_learning_companions_chat #id_messageeditable").css("opacity","0.5"),(0,_jquery.default)("#thi_learning_companions_chat #id_messageeditable").attr("contenteditable","false"),(0,_jquery.default)("#thi_learning_companions_chat form input,  #thi_learning_companions_chat form textarea, #local_thi_learning_companions_chat-send").attr("disabled",!0),_jquery.default.post(M.cfg.wwwroot+"/local/thi_learning_companions/ajax/ajaxsubmit.php",data).done((function(a,b,c){a.warning_body&&(console.log("output warning"),ModalFactory.create({title:a.warning_title,body:a.warning_body,footer:"",large:!1,type:ModalFactory.types.ALERT}).then((modal=>{modal.show()}))),(0,_jquery.default)("#thi_learning_companions_chat form #id_messageeditable").text(""),(0,_jquery.default)("#thi_learning_companions_chat form input, #thi_learning_companions_chat form textarea").each(((index,el)=>{"textarea"!=el.name&&"hidden"===el.type||(el.value="")})),(0,_jquery.default)("input[type=hidden][name=message\\[itemid\\]]").val(a.itemid);const clientId=Object.keys(window.M.core_filepicker.instances).pop();clientId&&(window.M.core_filepicker.instances[clientId].options.itemid=a.itemid),document.dispatchEvent(new CustomEvent("thi_learning_companions_message_send"))})).fail((function(a,b,c){console.warn("Failed sending via AJAX",a,b,c),window.alert("couldn't save")})).always((function(a,b,c){(0,_jquery.default)("#thi_learning_companions_chat #id_messageeditable").css("opacity","1"),(0,_jquery.default)("#thi_learning_companions_chat #id_messageeditable").attr("contenteditable","true"),(0,_jquery.default)("#thi_learning_companions_chat form input,  #thi_learning_companions_chat form textarea, #local_thi_learning_companions_chat-send").attr("disabled",!1)})),!1}}));

//# sourceMappingURL=thi_learning_companions_chat.min.js.map